import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as d,j as e,R as _e,a as xe}from"./client-BsyqJ1xH.js";import{A as je}from"./api-CH_Pe6Vg.js";const fe=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),j=a=>{const n=typeof a=="string"?new Date(a):a;return fe.format(n)},Z=a=>a==="pending"?"Pending":a==="validated"?"Complete":"Locked",ve=(a,n,l)=>a==="validated"&&n?"Code accepted â€” this delivery is now complete.":a==="locked"?"Maximum attempts reached. Delivery is locked.":n?"Attempt verified.":l===1?"Incorrect code. One attempt left.":`Incorrect code. ${l} attempts left.`,_=`${je}/delivery_confirmation`,y=a=>({Authorization:`Bearer ${a}`,"Content-Type":"application/json"}),g=async(a,n)=>{try{if((a.headers.get("content-type")??"").includes("application/json")){const i=await a.json();if(typeof i=="string")return i;if(Array.isArray(i)){const o=i[0];if(typeof o=="string")return o;if(o&&typeof o=="object"){const h=o.message;if(typeof h=="string")return h}}if(i&&typeof i=="object"){const o=i,h=["detail","message","error"];for(const m of h){const x=o[m];if(typeof x=="string")return x}}}return(await a.text()).trim()||n}catch(l){return console.error("Failed to parse error response",l),n}},ye=()=>{const[a,n]=d.useState(null),[l,T]=d.useState(""),[i,o]=d.useState(""),[h,m]=d.useState(null),[x,$]=d.useState(!1),[b,u]=d.useState(!1),[F,R]=d.useState(!1),[O,N]=d.useState(null),[P,w]=d.useState([]),[f,S]=d.useState({}),[D,C]=d.useState(""),[A,k]=d.useState(null),[M,U]=d.useState(!1),[q,V]=d.useState(""),[B,H]=d.useState(""),[p,E]=d.useState(null),[J,v]=d.useState(null),[I,G]=d.useState([]),[W,Y]=d.useState(!1),[z,K]=d.useState({}),se=a?.role==="shop",te=a?.role==="driver";d.useEffect(()=>{a?.role==="shop"&&ae(),a?.role==="driver"&&Q()},[a?.role]);const ae=async()=>{if(!a)return;const t=await fetch(`${_}/deliveries`,{headers:y(a.token)});if(!t.ok)return;const s=await t.json();w(s)},re=async t=>{if(!a)return;const s=await fetch(`${_}/deliveries/${t}/attempts`,{headers:y(a.token)});if(!s.ok)return;const r=await s.json();S(c=>({...c,[t]:r.attempts}))},Q=async()=>{if(!a)return;const t=await fetch(`${_}/attempts`,{headers:y(a.token)});if(!t.ok)return;const s=await t.json();G(s)},de=t=>{const s=t.replace(/\D/g,"").slice(0,6);H(s)},ce=t=>{const s=t.replace(/\D/g,"");V(s)},ne=()=>{n(null),w([]),S({}),G([]),E(null),v(null),K({}),V(""),H(""),k(null),C(""),N(null)},ie=async t=>{t.preventDefault(),m(null),N(null),$(!0);try{const s=await fetch(`${_}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:l.trim(),password:i})});if(!s.ok){const c=await g(s,"Unable to log in");throw new Error(c)}const r=await s.json();n({token:r.access_token,username:r.username,role:r.role})}catch(s){m(s instanceof Error?s.message:"Login failed")}finally{$(!1)}},le=async()=>{const t=l.trim();if(N(null),m(null),!t){m("Username is required to reset password.");return}R(!0);try{const s=await fetch(`${_}/password_reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t})});if(!s.ok)throw new Error(await g(s,"Unable to request password reset"));const r=await s.json();N(r.message)}catch(s){m(s instanceof Error?s.message:"Reset failed")}finally{R(!1)}},oe=async t=>{if(t.preventDefault(),!(!a||!D.trim())){U(!0);try{const s=await fetch(`${_}/deliveries`,{method:"POST",headers:y(a.token),body:JSON.stringify({address:D.trim()})});if(!s.ok)throw new Error(await g(s,"Unable to create delivery"));const r=await s.json();w(c=>[r,...c]),k(r),C("")}catch(s){k(null),m(s instanceof Error?s.message:"Unable to create delivery")}finally{U(!1)}}},me=async t=>{if(t.preventDefault(),!a)return;const s=q.trim(),r=B.trim();if(!s){v("Delivery ID is required.");return}if(!/^\d{6}$/.test(r)){v("Code must be exactly 6 digits.");return}v(null),Y(!0);try{const c=await fetch(`${_}/attempts`,{method:"POST",headers:y(a.token),body:JSON.stringify({delivery_id:Number(s),code:r})});if(!c.ok){const pe=await g(c,"Attempt rejected");throw new Error(pe)}const L=await c.json();E(L),await Q()}catch(c){E(null),v(c instanceof Error?c.message:"Attempt failed")}finally{Y(!1)}},he=d.useMemo(()=>a?a.role==="shop"?"Create deliveries, hand off the one-time code, and check delivery confirmations.":"Confirm deliveries.":"Generate and validate single-use delivery codes.",[a]),ue=d.useMemo(()=>a?a.role==="shop"?"Shop":"Driver":null,[a]),X=d.useMemo(()=>{if(!I.length)return[];const t=new Map;return I.forEach(s=>{t.has(s.delivery_id)||t.set(s.delivery_id,{delivery_id:s.delivery_id,address:s.address,status:s.status,attempts:[]});const r=t.get(s.delivery_id);r&&r.attempts.push(s)}),Array.from(t.values()).map(s=>({...s,attempts:[...s.attempts].sort((r,c)=>new Date(c.created_at).getTime()-new Date(r.created_at).getTime())})).sort((s,r)=>{const c=s.attempts[0]?.created_at??0,L=r.attempts[0]?.created_at??0;return new Date(L).getTime()-new Date(c).getTime()}).map(s=>({...s,status:s.attempts[0]?.status??s.status,address:s.attempts[0]?.address??s.address}))},[I]);return e.jsxs("div",{className:"dc-app",children:[e.jsxs("header",{className:"dc-app__header",children:[e.jsxs("div",{className:"dc-identity",children:[e.jsx("span",{className:"dc-identity__eyebrow",children:"Delivery Confirmation"}),e.jsx("h1",{className:"dc-identity__title",children:"One-time codes"}),e.jsx("p",{className:"dc-identity__lede",children:he})]}),e.jsx("div",{className:"dc-status",children:a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dc-status__role",children:ue}),e.jsxs("div",{className:"dc-status__user",children:["Signed in as ",a.username]}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:ne,children:"Log out"})]})})]}),!a&&e.jsxs("section",{className:"dc-panel dc-panel--login",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Sign in"}),e.jsx("p",{children:"Use your assigned username to manage or confirm deliveries."})]}),e.jsxs("form",{className:"dc-form",onSubmit:ie,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"username",children:"Username"}),e.jsx("input",{id:"username",name:"username",type:"text",value:l,onChange:t=>T(t.target.value),placeholder:"shop or driver",className:"dc-input",required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"password",children:"Password"}),e.jsxs("div",{className:"dc-input__wrapper",children:[e.jsx("input",{id:"password",name:"password",type:b?"text":"password",value:i,onChange:t=>o(t.target.value),className:"dc-input",required:!0}),e.jsx("button",{type:"button",className:"dc-input__toggle","aria-label":b?"Hide password":"Show password","aria-pressed":b,onMouseDown:()=>u(!0),onMouseUp:()=>u(!1),onMouseLeave:()=>u(!1),onBlur:()=>u(!1),onTouchStart:()=>u(!0),onTouchEnd:()=>u(!1),onTouchCancel:()=>u(!1),"aria-live":"polite",children:"ðŸ‘"})]})]}),h&&e.jsx("div",{className:"dc-form__error",children:h}),e.jsxs("div",{className:"dc-form__actions",children:[e.jsx("button",{className:"dc-button",type:"submit",disabled:x,children:x?"Signing in...":"Sign in"}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:le,disabled:F||x,children:F?"Requesting...":"Forgot password?"})]}),O&&e.jsx("div",{className:"dc-alert",children:O})]})]}),se&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Create delivery"}),e.jsx("p",{children:"Generate a delivery ID and one-time code tied to the address."})]}),e.jsxs("form",{className:"dc-form",onSubmit:oe,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"address",children:"Delivery address"}),e.jsx("textarea",{id:"address",name:"address",className:"dc-input dc-input--multiline",value:D,onChange:t=>C(t.target.value),placeholder:"12 Finchley rd, London, NW3 5JD",rows:3,required:!0})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:M,children:M?"Creating...":"Generate code"}),A&&e.jsxs("div",{className:"dc-alert",children:[e.jsx("div",{className:"dc-alert__title",children:"Delivery created"}),e.jsxs("div",{className:"dc-alert__codes",children:[e.jsxs("span",{children:["Delivery ID: ",A.delivery_id]}),e.jsxs("span",{children:["Secret code: ",A.secret_code]})]}),e.jsx("div",{className:"dc-alert__hint",children:"Share these with the recipient securely."})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsx("div",{className:"dc-panel__header",children:e.jsx("h2",{children:"Your deliveries"})}),P.length===0?e.jsx("p",{className:"dc-empty",children:"No deliveries yet."}):e.jsx("div",{className:"dc-list",children:P.map(t=>e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",t.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:t.address})]}),e.jsx("span",{className:`dc-chip dc-chip--${t.status}`,children:Z(t.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Secret code"}),e.jsx("dd",{className:"dc-code",children:t.secret_code})]}),e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Created"}),e.jsx("dd",{children:j(t.created_at)})]}),t.validated_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Completed"}),e.jsx("dd",{children:j(t.validated_at)})]}),t.locked_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Locked"}),e.jsx("dd",{children:j(t.locked_at)})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>f[t.delivery_id]?S(s=>{const r={...s};return delete r[t.delivery_id],r}):re(t.delivery_id),children:f[t.delivery_id]?"Close":"View attempts"})}),f[t.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"User"}),e.jsx("span",{children:"Result"})]}),f[t.delivery_id].map(s=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:s.attempt_number}),e.jsx("span",{children:j(s.created_at)}),e.jsx("span",{children:s.delivery_person}),e.jsx("span",{className:s.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:s.success?"Verified":"Failed"})]},s.attempt_number)),f[t.delivery_id].length===0&&e.jsx("div",{className:"dc-table__row dc-table__row--muted",children:"No attempts yet."})]})]},t.delivery_id))})]})]}),te&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Validate a delivery"}),e.jsx("p",{children:"Enter the delivery ID and the 6-digit code provided by the shop team."})]}),e.jsxs("form",{className:"dc-form",onSubmit:me,children:[e.jsxs("div",{className:"dc-form__group",children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"deliveryId",children:"Delivery ID"}),e.jsx("input",{id:"deliveryId",name:"deliveryId",type:"text",inputMode:"numeric",pattern:"^[0-9]+$",className:"dc-input",value:q,onChange:t=>ce(t.target.value),required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"secretCode",children:"Secret code"}),e.jsx("input",{id:"secretCode",name:"secretCode",type:"text",inputMode:"numeric",autoComplete:"one-time-code",pattern:"^[0-9]{6}$",maxLength:6,className:"dc-input",value:B,onChange:t=>de(t.target.value),required:!0})]})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:W,children:W?"Submitting...":"Submit attempt"}),J&&e.jsx("div",{className:"dc-form__error",children:J}),p&&e.jsxs("div",{className:`dc-alert ${p.success?"dc-alert--success":""}`,children:[e.jsxs("div",{className:"dc-alert__title",children:["Attempt ",p.attempt_number," Â· Delivery ",p.delivery_id]}),e.jsx("p",{className:"dc-alert__hint",children:ve(p.status,p.success,p.remaining_attempts)})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Recent attempts"}),e.jsx("p",{children:"Your attempts grouped by delivery"})]}),X.length===0?e.jsx("p",{className:"dc-empty",children:"No attempts logged yet."}):e.jsx("div",{className:"dc-list",children:X.map(t=>{const s=t.attempts[0];return e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",t.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:t.address}),s&&e.jsxs("p",{className:"dc-card__hint",children:["Last attempt #",s.attempt_number," Â·"," ",j(s.created_at)]})]}),e.jsx("span",{className:`dc-chip dc-chip--${t.status}`,children:Z(t.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Total attempts"}),e.jsx("dd",{children:t.attempts.length})]}),s&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Latest result"}),e.jsx("dd",{className:s.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:s.success?"Verified":"Failed"})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>K(r=>({...r,[t.delivery_id]:!r[t.delivery_id]})),children:z[t.delivery_id]?"Hide attempts":"View attempts"})}),z[t.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"Result"})]}),t.attempts.map(r=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:r.attempt_number}),e.jsx("span",{children:j(r.created_at)}),e.jsx("span",{className:r.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:r.success?"Verified":"Failed"})]},`${r.delivery_id}-${r.attempt_number}`))]})]},t.delivery_id)})})]})]})]})},ee=document.getElementById("root");if(!ee)throw new Error("Root element #root not found");_e.createRoot(ee).render(e.jsx(xe.StrictMode,{children:e.jsx(ye,{})}));
