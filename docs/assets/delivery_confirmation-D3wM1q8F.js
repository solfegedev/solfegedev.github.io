import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as d,j as e,R as ue,a as pe}from"./client-BsyqJ1xH.js";import{A as _e}from"./api-CH_Pe6Vg.js";const xe=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),u=a=>{const i=typeof a=="string"?new Date(a):a;return xe.format(i)},K=a=>a==="pending"?"Pending":a==="validated"?"Complete":"Locked",je=(a,i,m)=>a==="validated"&&i?"Code accepted â€” this delivery is now complete.":a==="locked"?"Maximum attempts reached. Delivery is locked.":i?"Attempt verified.":m===1?"Incorrect code. One attempt left.":`Incorrect code. ${m} attempts left.`,o=`${_e}/delivery_confirmation`,x=a=>({Authorization:`Bearer ${a}`,"Content-Type":"application/json"}),ve=()=>{const[a,i]=d.useState(null),[m,X]=d.useState(""),[k,Z]=d.useState(""),[E,h]=d.useState(null),[v,I]=d.useState(!1),[f,n]=d.useState(!1),[L,$]=d.useState(!1),[F,j]=d.useState(null),[R,y]=d.useState([]),[p,N]=d.useState({}),[b,g]=d.useState(""),[w,S]=d.useState(null),[T,P]=d.useState(!1),[O,M]=d.useState(""),[U,q]=d.useState(""),[l,D]=d.useState(null),[V,_]=d.useState(null),[C,B]=d.useState([]),[H,J]=d.useState(!1),[G,W]=d.useState({}),ee=a?.role==="shop",se=a?.role==="driver";d.useEffect(()=>{a?.role==="shop"&&te(),a?.role==="driver"&&Y()},[a?.role]);const te=async()=>{if(!a)return;const s=await fetch(`${o}/deliveries`,{headers:x(a.token)});if(!s.ok)return;const t=await s.json();y(t)},ae=async s=>{if(!a)return;const t=await fetch(`${o}/deliveries/${s}/attempts`,{headers:x(a.token)});if(!t.ok)return;const r=await t.json();N(c=>({...c,[s]:r.attempts}))},Y=async()=>{if(!a)return;const s=await fetch(`${o}/attempts`,{headers:x(a.token)});if(!s.ok)return;const t=await s.json();B(t)},re=s=>{const t=s.replace(/\D/g,"").slice(0,6);q(t)},de=()=>{i(null),y([]),N({}),B([]),D(null),_(null),W({}),M(""),q(""),S(null),g(""),j(null)},ce=async s=>{s.preventDefault(),h(null),j(null),I(!0);try{const t=await fetch(`${o}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:m.trim(),password:k})});if(!t.ok){const c=await t.text();throw new Error(c||"Unable to log in")}const r=await t.json();i({token:r.access_token,username:r.username,role:r.role})}catch(t){h(t instanceof Error?t.message:"Login failed")}finally{I(!1)}},ie=async()=>{const s=m.trim();if(j(null),h(null),!s){h("Username is required to reset password.");return}$(!0);try{const t=await fetch(`${o}/password_reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s})});if(!t.ok)throw new Error("Unable to request password reset");const r=await t.json();j(r.message)}catch(t){h(t instanceof Error?t.message:"Reset failed")}finally{$(!1)}},ne=async s=>{if(s.preventDefault(),!(!a||!b.trim())){P(!0);try{const t=await fetch(`${o}/deliveries`,{method:"POST",headers:x(a.token),body:JSON.stringify({address:b.trim()})});if(!t.ok)throw new Error(await t.text());const r=await t.json();y(c=>[r,...c]),S(r),g("")}catch(t){S(null),h(t instanceof Error?t.message:"Unable to create delivery")}finally{P(!1)}}},le=async s=>{if(s.preventDefault(),!a)return;const t=O.trim(),r=U.trim();if(!t){_("Delivery ID is required.");return}if(!/^\d{6}$/.test(r)){_("Code must be exactly 6 digits.");return}_(null),J(!0);try{const c=await fetch(`${o}/attempts`,{method:"POST",headers:x(a.token),body:JSON.stringify({delivery_id:Number(t),code:r})});if(!c.ok){const he=await c.text();throw new Error(he||"Attempt rejected")}const A=await c.json();D(A),await Y()}catch(c){D(null),_(c instanceof Error?c.message:"Attempt failed")}finally{J(!1)}},oe=d.useMemo(()=>a?a.role==="shop"?"Create deliveries, hand off the one-time code, and check delivery confirmations.":"Confirm deliveries.":"Generate and validate single-use delivery codes.",[a]),me=d.useMemo(()=>a?a.role==="shop"?"Shop":"Driver":null,[a]),z=d.useMemo(()=>{if(!C.length)return[];const s=new Map;return C.forEach(t=>{s.has(t.delivery_id)||s.set(t.delivery_id,{delivery_id:t.delivery_id,address:t.address,status:t.status,attempts:[]});const r=s.get(t.delivery_id);r&&r.attempts.push(t)}),Array.from(s.values()).map(t=>({...t,attempts:[...t.attempts].sort((r,c)=>new Date(c.created_at).getTime()-new Date(r.created_at).getTime())})).sort((t,r)=>{const c=t.attempts[0]?.created_at??0,A=r.attempts[0]?.created_at??0;return new Date(A).getTime()-new Date(c).getTime()}).map(t=>({...t,status:t.attempts[0]?.status??t.status,address:t.attempts[0]?.address??t.address}))},[C]);return e.jsxs("div",{className:"dc-app",children:[e.jsxs("header",{className:"dc-app__header",children:[e.jsxs("div",{className:"dc-identity",children:[e.jsx("span",{className:"dc-identity__eyebrow",children:"Delivery Confirmation"}),e.jsx("h1",{className:"dc-identity__title",children:"One-time codes"}),e.jsx("p",{className:"dc-identity__lede",children:oe})]}),e.jsx("div",{className:"dc-status",children:a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dc-status__role",children:me}),e.jsxs("div",{className:"dc-status__user",children:["Signed in as ",a.username]}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:de,children:"Log out"})]})})]}),!a&&e.jsxs("section",{className:"dc-panel dc-panel--login",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Sign in"}),e.jsx("p",{children:"Use your assigned username to manage or confirm deliveries."})]}),e.jsxs("form",{className:"dc-form",onSubmit:ce,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"username",children:"Username"}),e.jsx("input",{id:"username",name:"username",type:"text",value:m,onChange:s=>X(s.target.value),placeholder:"shop or driver",className:"dc-input",required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"password",children:"Password"}),e.jsxs("div",{className:"dc-input__wrapper",children:[e.jsx("input",{id:"password",name:"password",type:f?"text":"password",value:k,onChange:s=>Z(s.target.value),className:"dc-input",required:!0}),e.jsx("button",{type:"button",className:"dc-input__toggle","aria-label":f?"Hide password":"Show password","aria-pressed":f,onMouseDown:()=>n(!0),onMouseUp:()=>n(!1),onMouseLeave:()=>n(!1),onBlur:()=>n(!1),onTouchStart:()=>n(!0),onTouchEnd:()=>n(!1),onTouchCancel:()=>n(!1),"aria-live":"polite",children:"ðŸ‘"})]})]}),E&&e.jsx("div",{className:"dc-form__error",children:E}),e.jsxs("div",{className:"dc-form__actions",children:[e.jsx("button",{className:"dc-button",type:"submit",disabled:v,children:v?"Signing in...":"Sign in"}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:ie,disabled:L||v,children:L?"Requesting...":"Forgot password?"})]}),F&&e.jsx("div",{className:"dc-alert",children:F})]})]}),ee&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Create delivery"}),e.jsx("p",{children:"Generate a delivery ID and one-time code tied to the address."})]}),e.jsxs("form",{className:"dc-form",onSubmit:ne,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"address",children:"Delivery address"}),e.jsx("textarea",{id:"address",name:"address",className:"dc-input dc-input--multiline",value:b,onChange:s=>g(s.target.value),placeholder:"12 Finchley rd, London, NW3 5JD",rows:3,required:!0})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:T,children:T?"Creating...":"Generate code"}),w&&e.jsxs("div",{className:"dc-alert",children:[e.jsx("div",{className:"dc-alert__title",children:"Delivery created"}),e.jsxs("div",{className:"dc-alert__codes",children:[e.jsxs("span",{children:["Delivery ID: ",w.delivery_id]}),e.jsxs("span",{children:["Secret code: ",w.secret_code]})]}),e.jsx("div",{className:"dc-alert__hint",children:"Share these with the recipient securely."})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsx("div",{className:"dc-panel__header",children:e.jsx("h2",{children:"Your deliveries"})}),R.length===0?e.jsx("p",{className:"dc-empty",children:"No deliveries yet."}):e.jsx("div",{className:"dc-list",children:R.map(s=>e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",s.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:s.address})]}),e.jsx("span",{className:`dc-chip dc-chip--${s.status}`,children:K(s.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Secret code"}),e.jsx("dd",{className:"dc-code",children:s.secret_code})]}),e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Created"}),e.jsx("dd",{children:u(s.created_at)})]}),s.validated_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Completed"}),e.jsx("dd",{children:u(s.validated_at)})]}),s.locked_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Locked"}),e.jsx("dd",{children:u(s.locked_at)})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>p[s.delivery_id]?N(t=>{const r={...t};return delete r[s.delivery_id],r}):ae(s.delivery_id),children:p[s.delivery_id]?"Close":"View attempts"})}),p[s.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"User"}),e.jsx("span",{children:"Result"})]}),p[s.delivery_id].map(t=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:t.attempt_number}),e.jsx("span",{children:u(t.created_at)}),e.jsx("span",{children:t.delivery_person}),e.jsx("span",{className:t.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:t.success?"Verified":"Failed"})]},t.attempt_number)),p[s.delivery_id].length===0&&e.jsx("div",{className:"dc-table__row dc-table__row--muted",children:"No attempts yet."})]})]},s.delivery_id))})]})]}),se&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Validate a delivery"}),e.jsx("p",{children:"Enter the delivery ID and the 6-digit code provided by the shop team."})]}),e.jsxs("form",{className:"dc-form",onSubmit:le,children:[e.jsxs("div",{className:"dc-form__group",children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"deliveryId",children:"Delivery ID"}),e.jsx("input",{id:"deliveryId",name:"deliveryId",type:"number",className:"dc-input",value:O,onChange:s=>M(s.target.value),required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"secretCode",children:"Secret code"}),e.jsx("input",{id:"secretCode",name:"secretCode",type:"text",inputMode:"numeric",autoComplete:"one-time-code",pattern:"^[0-9]{6}$",maxLength:6,className:"dc-input",value:U,onChange:s=>re(s.target.value),required:!0})]})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:H,children:H?"Submitting...":"Submit attempt"}),V&&e.jsx("div",{className:"dc-form__error",children:V}),l&&e.jsxs("div",{className:`dc-alert ${l.success?"dc-alert--success":""}`,children:[e.jsxs("div",{className:"dc-alert__title",children:["Attempt ",l.attempt_number," Â· Delivery ",l.delivery_id]}),e.jsx("p",{className:"dc-alert__hint",children:je(l.status,l.success,l.remaining_attempts)})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Recent attempts"}),e.jsx("p",{children:"Your attempts grouped by delivery"})]}),z.length===0?e.jsx("p",{className:"dc-empty",children:"No attempts logged yet."}):e.jsx("div",{className:"dc-list",children:z.map(s=>{const t=s.attempts[0];return e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",s.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:s.address}),t&&e.jsxs("p",{className:"dc-card__hint",children:["Last attempt #",t.attempt_number," Â·"," ",u(t.created_at)]})]}),e.jsx("span",{className:`dc-chip dc-chip--${s.status}`,children:K(s.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Total attempts"}),e.jsx("dd",{children:s.attempts.length})]}),t&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Latest result"}),e.jsx("dd",{className:t.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:t.success?"Verified":"Failed"})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>W(r=>({...r,[s.delivery_id]:!r[s.delivery_id]})),children:G[s.delivery_id]?"Hide attempts":"View attempts"})}),G[s.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"Result"})]}),s.attempts.map(r=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:r.attempt_number}),e.jsx("span",{children:u(r.created_at)}),e.jsx("span",{className:r.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:r.success?"Verified":"Failed"})]},`${r.delivery_id}-${r.attempt_number}`))]})]},s.delivery_id)})})]})]})]})},Q=document.getElementById("root");if(!Q)throw new Error("Root element #root not found");ue.createRoot(Q).render(e.jsx(pe.StrictMode,{children:e.jsx(ve,{})}));
