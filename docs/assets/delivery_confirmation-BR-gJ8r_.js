import"./modulepreload-polyfill-B5Qt9EMX.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{A as be}from"./api-CH_Pe6Vg.js";const F=1,we=({authMode:s,email:o,password:d,roleSelection:j,showPassword:n,loadingAuth:l,resettingPassword:p,authError:m,resetFlash:i,switchAuthMode:_,setEmail:f,setPassword:v,setRoleSelection:c,setShowPassword:t,handleAuthSubmit:h,handlePasswordReset:y})=>e.jsxs("section",{className:"dc-panel dc-panel--login",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:s==="login"?"Sign in":"Create account"}),e.jsx("p",{children:s==="login"?"Use your email to manage or confirm deliveries.":"Register with your email; new accounts start on a Free membership."})]}),e.jsxs("div",{className:"dc-tabs",role:"tablist","aria-label":"Authentication mode",children:[e.jsx("button",{type:"button",role:"tab","aria-selected":s==="login",className:`dc-tabs__item${s==="login"?" is-active":""}`,onClick:()=>_("login"),children:"Sign in"}),e.jsx("button",{type:"button",role:"tab","aria-selected":s==="register",className:`dc-tabs__item${s==="register"?" is-active":""}`,onClick:()=>_("register"),children:"Register"})]}),e.jsxs("form",{className:"dc-form",onSubmit:h,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"email",children:"Email address"}),e.jsx("input",{id:"email",name:"email",type:"email",value:o,onChange:g=>f(g.target.value),placeholder:"you@example.com",className:"dc-input",required:!0,autoComplete:s==="login"?"username":"email"})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"password",children:"Password"}),e.jsxs("div",{className:"dc-input__wrapper",children:[e.jsx("input",{id:"password",name:"password",type:n?"text":"password",value:d,onChange:g=>v(g.target.value),className:"dc-input",required:!0,autoComplete:s==="login"?"current-password":"new-password",minLength:s==="register"?F:void 0}),e.jsx("button",{type:"button",className:"dc-input__toggle","aria-label":n?"Hide characters":"Show characters","aria-controls":"password","aria-pressed":n,onMouseDown:()=>t(!0),onMouseUp:()=>t(!1),onMouseLeave:()=>t(!1),onBlur:()=>t(!1),onTouchStart:()=>t(!0),onTouchEnd:()=>t(!1),onTouchCancel:()=>t(!1),"aria-live":"polite",children:"ðŸ‘"})]})]}),s==="register"&&e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"role",children:"Choose your role"}),e.jsxs("div",{className:"dc-radio-group",role:"radiogroup","aria-label":"Role",children:[e.jsxs("label",{className:"dc-radio",children:[e.jsx("input",{type:"radio",name:"role",value:"shop",checked:j==="shop",onChange:()=>c("shop")}),"Shop â€” create deliveries"]}),e.jsxs("label",{className:"dc-radio",children:[e.jsx("input",{type:"radio",name:"role",value:"driver",checked:j==="driver",onChange:()=>c("driver")}),"Driver â€” confirm deliveries"]})]}),e.jsx("p",{className:"dc-form__hint",children:"All new accounts start on the Free membership."})]}),m&&e.jsx("div",{className:"dc-form__error",children:m}),e.jsxs("div",{className:"dc-form__actions",children:[e.jsx("button",{className:"dc-button",type:"submit",disabled:l,children:l?s==="login"?"Signing in...":"Creating account...":s==="login"?"Sign in":"Register"}),s==="login"&&e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:y,disabled:p||l,children:p?"Requesting...":"Forgot password?"})]}),i&&e.jsx("div",{className:"dc-alert",children:i})]})]}),Se=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),w=s=>{const o=typeof s=="string"?new Date(s):s;return Se.format(o)},Y=s=>s==="pending"?"Pending":s==="validated"?"Complete":"Locked",Ce=(s,o,d)=>s==="validated"&&o?"Code accepted â€” this delivery is now complete.":s==="locked"?"Maximum attempts reached. Delivery is locked.":o?"Attempt verified.":d===1?"Incorrect code. One attempt left.":`Incorrect code. ${d} attempts left.`,De=({attemptDeliveryId:s,attemptCode:o,attemptResult:d,attemptError:j,submittingAttempt:n,attemptHistory:l,expandedDriverDeliveries:p,handleSubmitAttempt:m,onAttemptDeliveryIdChange:i,onAttemptCodeChange:_,toggleDriverDeliveryExpansion:f})=>{const v=React.useMemo(()=>{if(!l.length)return[];const c=new Map;return l.forEach(t=>{c.has(t.delivery_id)||c.set(t.delivery_id,{delivery_id:t.delivery_id,address:t.address,status:t.status,attempts:[]});const h=c.get(t.delivery_id);h&&h.attempts.push(t)}),Array.from(c.values()).map(t=>({...t,attempts:[...t.attempts].sort((h,y)=>new Date(y.created_at).getTime()-new Date(h.created_at).getTime())})).sort((t,h)=>{const y=t.attempts[0]?.created_at??0,g=h.attempts[0]?.created_at??0;return new Date(g).getTime()-new Date(y).getTime()}).map(t=>({...t,status:t.attempts[0]?.status??t.status,address:t.attempts[0]?.address??t.address}))},[l]);return e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Validate a delivery"}),e.jsx("p",{children:"Enter the delivery ID and the 6-digit code provided by the shop team."})]}),e.jsxs("form",{className:"dc-form",onSubmit:m,children:[e.jsxs("div",{className:"dc-form__group",children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"deliveryId",children:"Delivery ID"}),e.jsx("input",{id:"deliveryId",name:"deliveryId",type:"text",inputMode:"numeric",pattern:"^[0-9]+$",className:"dc-input",value:s,onChange:c=>i(c.target.value),required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"secretCode",children:"Secret code"}),e.jsx("input",{id:"secretCode",name:"secretCode",type:"text",inputMode:"numeric",autoComplete:"one-time-code",pattern:"^[0-9]{6}$",maxLength:6,className:"dc-input",value:o,onChange:c=>_(c.target.value),required:!0})]})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:n,children:n?"Submitting...":"Submit attempt"}),j&&e.jsx("div",{className:"dc-form__error",children:j}),d&&e.jsxs("div",{className:`dc-alert ${d.success?"dc-alert--success":""}`,children:[e.jsxs("div",{className:"dc-alert__title",children:["Attempt ",d.attempt_number," Â· Delivery ",d.delivery_id]}),e.jsx("p",{className:"dc-alert__hint",children:Ce(d.status,d.success,d.remaining_attempts)})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Recent attempts"}),e.jsx("p",{children:"Your attempts grouped by delivery"})]}),v.length===0?e.jsx("p",{className:"dc-empty",children:"No attempts logged yet."}):e.jsx("div",{className:"dc-list",children:v.map(c=>{const t=c.attempts[0];return e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",c.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:c.address}),t&&e.jsxs("p",{className:"dc-card__hint",children:["Last attempt #",t.attempt_number," Â·"," ",w(t.created_at)]})]}),e.jsx("span",{className:`dc-chip dc-chip--${c.status}`,children:Y(c.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Total attempts"}),e.jsx("dd",{children:c.attempts.length})]}),t&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Latest result"}),e.jsx("dd",{className:t.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:t.success?"Verified":"Failed"})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>f(c.delivery_id),children:p[c.delivery_id]?"Hide attempts":"View attempts"})}),p[c.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"Result"})]}),c.attempts.map(h=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:h.attempt_number}),e.jsx("span",{children:w(h.created_at)}),e.jsx("span",{className:h.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:h.success?"Verified":"Failed"})]},`${h.delivery_id}-${h.attempt_number}`))]})]},c.delivery_id)})})]})]})},Re=({deliveries:s,selectedDeliveryAttempts:o,addressInput:d,creationFlash:j,isCreating:n,handleCreateDelivery:l,handleAddressChange:p,toggleDeliveryAttempts:m})=>e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Create delivery"}),e.jsx("p",{children:"Generate a delivery ID and one-time code tied to the address."})]}),e.jsxs("form",{className:"dc-form",onSubmit:l,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"address",children:"Delivery address"}),e.jsx("textarea",{id:"address",name:"address",className:"dc-input dc-input--multiline",value:d,onChange:i=>p(i.target.value),placeholder:"12 Finchley rd, London, NW3 5JD",rows:3,required:!0})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:n,children:n?"Creating...":"Generate code"}),j&&e.jsxs("div",{className:"dc-alert",children:[e.jsx("div",{className:"dc-alert__title",children:"Delivery created"}),e.jsxs("div",{className:"dc-alert__codes",children:[e.jsxs("span",{children:["Delivery ID: ",j.delivery_id]}),e.jsxs("span",{children:["Secret code: ",j.secret_code]})]}),e.jsx("div",{className:"dc-alert__hint",children:"Share these with the recipient securely."})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsx("div",{className:"dc-panel__header",children:e.jsx("h2",{children:"Your deliveries"})}),s.length===0?e.jsx("p",{className:"dc-empty",children:"No deliveries yet."}):e.jsx("div",{className:"dc-list",children:s.map(i=>e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",i.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:i.address})]}),e.jsx("span",{className:`dc-chip dc-chip--${i.status}`,children:Y(i.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Secret code"}),e.jsx("dd",{className:"dc-code",children:i.secret_code})]}),e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Created"}),e.jsx("dd",{children:w(i.created_at)})]}),i.validated_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Completed"}),e.jsx("dd",{children:w(i.validated_at)})]}),i.locked_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Locked"}),e.jsx("dd",{children:w(i.locked_at)})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>m(i.delivery_id),children:o[i.delivery_id]?"Close":"View attempts"})}),o[i.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"User"}),e.jsx("span",{children:"Result"})]}),o[i.delivery_id].map(_=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:_.attempt_number}),e.jsx("span",{children:w(_.created_at)}),e.jsx("span",{children:_.delivery_person}),e.jsx("span",{className:_.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:_.success?"Verified":"Failed"})]},_.attempt_number)),o[i.delivery_id].length===0&&e.jsx("div",{className:"dc-table__row dc-table__row--muted",children:"No attempts yet."})]})]},i.delivery_id))})]})]}),N=`${be}/delivery_confirmation`,R=s=>({Authorization:`Bearer ${s}`,"Content-Type":"application/json"}),A=async(s,o)=>{try{if((s.headers.get("content-type")??"").includes("application/json")){const n=await s.json();if(typeof n=="string")return n;if(Array.isArray(n)){const l=n[0];if(typeof l=="string")return l;if(l&&typeof l=="object"){const p=l.message;if(typeof p=="string")return p}}if(n&&typeof n=="object"){const l=n,p=["detail","message","error"];for(const m of p){const i=l[m];if(typeof i=="string")return i}}}return(await s.text()).trim()||o}catch(d){return console.error("Failed to parse error response",d),o}},Ae=()=>{const[s,o]=React.useState(null),[d,j]=React.useState(""),[n,l]=React.useState(""),[p,m]=React.useState(null),[i,_]=React.useState(!1),[f,v]=React.useState("login"),[c,t]=React.useState("driver"),[h,y]=React.useState(!1),[g,O]=React.useState(!1),[K,S]=React.useState(null),[Q,k]=React.useState([]),[q,E]=React.useState({}),[$,T]=React.useState(""),[X,I]=React.useState(null),[Z,U]=React.useState(!1),[P,V]=React.useState(""),[B,G]=React.useState(""),[ee,L]=React.useState(null),[se,C]=React.useState(null),[te,J]=React.useState([]),[ae,W]=React.useState(!1),[re,H]=React.useState({}),ie=s?.role==="shop",ce=s?.role==="driver";React.useEffect(()=>{s?.role==="shop"&&ne(),s?.role==="driver"&&M()},[s?.role]);const ne=async()=>{if(!s)return;const r=await fetch(`${N}/deliveries`,{headers:R(s.token)});if(!r.ok)return;const a=await r.json();k(a)},de=async r=>{if(!s)return;const a=await fetch(`${N}/deliveries/${r}/attempts`,{headers:R(s.token)});if(!a.ok)return;const u=await a.json();E(x=>({...x,[r]:u.attempts}))},M=async()=>{if(!s)return;const r=await fetch(`${N}/attempts`,{headers:R(s.token)});if(!r.ok)return;const a=await r.json();J(a)},le=r=>{const a=r.replace(/\D/g,"").slice(0,6);G(a)},oe=r=>{const a=r.replace(/\D/g,"");V(a)},me=r=>{T(r)},he=r=>{if(q[r]){E(a=>{const u={...a};return delete u[r],u});return}de(r)},ue=r=>{H(a=>({...a,[r]:!a[r]}))},pe=()=>{o(null),k([]),E({}),J([]),L(null),C(null),H({}),V(""),G(""),I(null),T(""),S(null),l(""),j(""),v("login")},_e=r=>{v(r),m(null),S(null)},je=async r=>{r.preventDefault();const a=d.trim().toLowerCase();if(m(null),S(null),!a){m("Email is required.");return}if(!n.trim()){m("Password is required.");return}if(f==="register"&&n.length<F){m(`Password must be at least ${F} characters.`);return}_(!0);try{const u=f==="login"?"login":"register",x={email:a,password:n};f==="register"&&(x.role=c);const D=await fetch(`${N}/${u}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)});if(!D.ok){const Ne=await A(D,f==="login"?"Unable to log in":"Unable to register");throw new Error(Ne)}const b=await D.json();o({token:b.access_token,email:b.username,role:b.role,membership:b.membership}),l("")}catch(u){m(u instanceof Error?u.message:f==="login"?"Login failed":"Registration failed")}finally{_(!1)}},xe=async()=>{const r=d.trim().toLowerCase();if(S(null),m(null),!r){m("Email is required to reset password.");return}O(!0);try{const a=await fetch(`${N}/password_reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r})});if(!a.ok)throw new Error(await A(a,"Unable to request password reset"));const u=await a.json();S(u.message)}catch(a){m(a instanceof Error?a.message:"Reset failed")}finally{O(!1)}},fe=async r=>{if(r.preventDefault(),!(!s||!$.trim())){U(!0);try{const a=await fetch(`${N}/deliveries`,{method:"POST",headers:R(s.token),body:JSON.stringify({address:$.trim()})});if(!a.ok)throw new Error(await A(a,"Unable to create delivery"));const u=await a.json();k(x=>[u,...x]),I(u),T("")}catch(a){I(null),m(a instanceof Error?a.message:"Unable to create delivery")}finally{U(!1)}}},ve=async r=>{if(r.preventDefault(),!s)return;const a=P.trim(),u=B.trim();if(!a){C("Delivery ID is required.");return}if(!/^\d{6}$/.test(u)){C("Code must be exactly 6 digits.");return}C(null),W(!0);try{const x=await fetch(`${N}/attempts`,{method:"POST",headers:R(s.token),body:JSON.stringify({delivery_id:Number(a),code:u})});if(!x.ok){const b=await A(x,"Attempt rejected");throw new Error(b)}const D=await x.json();L(D),await M()}catch(x){L(null),C(x instanceof Error?x.message:"Attempt failed")}finally{W(!1)}},ye=React.useMemo(()=>s?s.role==="shop"?"Create deliveries, hand off the one-time code, and check delivery confirmations.":"Confirm deliveries.":"Generate and validate single-use delivery codes.",[s]),ge=React.useMemo(()=>s?s.role==="shop"?"Shop":"Driver":null,[s]);return e.jsxs("div",{className:"dc-app",children:[e.jsxs("header",{className:"dc-app__header",children:[e.jsxs("div",{className:"dc-identity",children:[e.jsx("span",{className:"dc-identity__eyebrow",children:"Delivery Confirmation"}),e.jsx("h1",{className:"dc-identity__title",children:"One-time codes"}),e.jsx("p",{className:"dc-identity__lede",children:ye})]}),e.jsx("div",{className:"dc-status",children:s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dc-status__role",children:ge}),e.jsxs("div",{className:"dc-status__user",children:["Signed in as ",s.email," Â· ",s.membership.toUpperCase()," member"]}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:pe,children:"Log out"})]})})]}),!s&&e.jsx(we,{authMode:f,email:d,password:n,roleSelection:c,showPassword:h,loadingAuth:i,resettingPassword:g,authError:p,resetFlash:K,switchAuthMode:_e,setEmail:j,setPassword:l,setRoleSelection:t,setShowPassword:y,handleAuthSubmit:je,handlePasswordReset:xe}),ie&&e.jsx(Re,{deliveries:Q,selectedDeliveryAttempts:q,addressInput:$,creationFlash:X,isCreating:Z,handleCreateDelivery:fe,handleAddressChange:me,toggleDeliveryAttempts:he}),ce&&e.jsx(De,{attemptDeliveryId:P,attemptCode:B,attemptResult:ee,attemptError:se,submittingAttempt:ae,attemptHistory:te,expandedDriverDeliveries:re,handleSubmitAttempt:ve,onAttemptDeliveryIdChange:oe,onAttemptCodeChange:le,toggleDriverDeliveryExpansion:ue})]})},z=document.getElementById("root");if(!z)throw new Error("Root element #root not found");ReactDOM.createRoot(z).render(e.jsx(React.StrictMode,{children:e.jsx(Ae,{})}));
