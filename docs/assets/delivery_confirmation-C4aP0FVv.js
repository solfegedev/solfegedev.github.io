import"./modulepreload-polyfill-B5Qt9EMX.js";import{r,j as e,R as me,a as he}from"./client-BsyqJ1xH.js";import{g as ue}from"./api-C-gcI8S5.js";const pe=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),h=a=>{const i=typeof a=="string"?new Date(a):a;return pe.format(i)},Y=a=>a==="pending"?"Pending":a==="validated"?"Complete":"Locked",_e=(a,i,o)=>a==="validated"&&i?"Code accepted — this delivery is now complete.":a==="locked"?"Maximum attempts reached. Delivery is locked.":i?"Attempt verified.":o===1?"Incorrect code. One attempt left.":`Incorrect code. ${o} attempts left.`,l=`${ue()}/delivery_confirmation`,_=a=>({Authorization:`Bearer ${a}`,"Content-Type":"application/json"}),xe=()=>{const[a,i]=r.useState(null),[o,K]=r.useState(""),[C,Q]=r.useState(""),[A,m]=r.useState(null),[j,k]=r.useState(!1),[E,I]=r.useState(!1),[$,x]=r.useState(null),[F,f]=r.useState([]),[u,v]=r.useState({}),[y,N]=r.useState(""),[g,b]=r.useState(null),[L,R]=r.useState(!1),[T,O]=r.useState(""),[P,U]=r.useState(""),[n,w]=r.useState(null),[q,p]=r.useState(null),[S,M]=r.useState([]),[V,J]=r.useState(!1),[B,G]=r.useState({}),X=a?.role==="staff",Z=a?.role==="delivery";r.useEffect(()=>{a?.role==="staff"&&ee(),a?.role==="delivery"&&H()},[a?.role]);const ee=async()=>{if(!a)return;const s=await fetch(`${l}/deliveries`,{headers:_(a.token)});if(!s.ok)return;const t=await s.json();f(t)},se=async s=>{if(!a)return;const t=await fetch(`${l}/deliveries/${s}/attempts`,{headers:_(a.token)});if(!t.ok)return;const d=await t.json();v(c=>({...c,[s]:d.attempts}))},H=async()=>{if(!a)return;const s=await fetch(`${l}/attempts`,{headers:_(a.token)});if(!s.ok)return;const t=await s.json();M(t)},te=s=>{const t=s.replace(/\D/g,"").slice(0,6);U(t)},ae=()=>{i(null),f([]),v({}),M([]),w(null),p(null),G({}),O(""),U(""),b(null),N(""),x(null)},de=async s=>{s.preventDefault(),m(null),x(null),k(!0);try{const t=await fetch(`${l}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o.trim(),password:C})});if(!t.ok){const c=await t.text();throw new Error(c||"Unable to log in")}const d=await t.json();i({token:d.access_token,username:d.username,role:d.role})}catch(t){m(t instanceof Error?t.message:"Login failed")}finally{k(!1)}},re=async()=>{const s=o.trim();if(x(null),m(null),!s){m("Username is required to reset password.");return}I(!0);try{const t=await fetch(`${l}/password_reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s})});if(!t.ok)throw new Error("Unable to request password reset");const d=await t.json();x(d.message)}catch(t){m(t instanceof Error?t.message:"Reset failed")}finally{I(!1)}},ce=async s=>{if(s.preventDefault(),!(!a||!y.trim())){R(!0);try{const t=await fetch(`${l}/deliveries`,{method:"POST",headers:_(a.token),body:JSON.stringify({address:y.trim()})});if(!t.ok)throw new Error(await t.text());const d=await t.json();f(c=>[d,...c]),b(d),N("")}catch(t){b(null),m(t instanceof Error?t.message:"Unable to create delivery")}finally{R(!1)}}},ie=async s=>{if(s.preventDefault(),!a)return;const t=T.trim(),d=P.trim();if(!t){p("Delivery ID is required.");return}if(!/^\d{6}$/.test(d)){p("Code must be exactly 6 digits.");return}p(null),J(!0);try{const c=await fetch(`${l}/attempts`,{method:"POST",headers:_(a.token),body:JSON.stringify({delivery_id:Number(t),code:d})});if(!c.ok){const oe=await c.text();throw new Error(oe||"Attempt rejected")}const D=await c.json();w(D),await H()}catch(c){w(null),p(c instanceof Error?c.message:"Attempt failed")}finally{J(!1)}},ne=r.useMemo(()=>a?a.role==="staff"?"Create deliveries, hand off the one-time code, and check delivery confirmations.":"Confirm deliveries.":"Generate and validate single-use delivery codes.",[a]),le=r.useMemo(()=>a?a.role==="staff"?"Shop":"Driver":null,[a]),W=r.useMemo(()=>{if(!S.length)return[];const s=new Map;return S.forEach(t=>{s.has(t.delivery_id)||s.set(t.delivery_id,{delivery_id:t.delivery_id,address:t.address,status:t.status,attempts:[]});const d=s.get(t.delivery_id);d&&d.attempts.push(t)}),Array.from(s.values()).map(t=>({...t,attempts:[...t.attempts].sort((d,c)=>new Date(c.created_at).getTime()-new Date(d.created_at).getTime())})).sort((t,d)=>{const c=t.attempts[0]?.created_at??0,D=d.attempts[0]?.created_at??0;return new Date(D).getTime()-new Date(c).getTime()}).map(t=>({...t,status:t.attempts[0]?.status??t.status,address:t.attempts[0]?.address??t.address}))},[S]);return e.jsxs("div",{className:"dc-app",children:[e.jsxs("header",{className:"dc-app__header",children:[e.jsxs("div",{className:"dc-identity",children:[e.jsx("span",{className:"dc-identity__eyebrow",children:"Delivery Confirmation"}),e.jsx("h1",{className:"dc-identity__title",children:"One-time codes"}),e.jsx("p",{className:"dc-identity__lede",children:ne})]}),e.jsx("div",{className:"dc-status",children:a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dc-status__chip dc-status__chip--active",children:le}),e.jsxs("div",{className:"dc-status__user",children:["Signed in as ",a.username]}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:ae,children:"Log out"})]}):e.jsx("div",{className:"dc-status__chip",children:"Not signed in"})})]}),!a&&e.jsxs("section",{className:"dc-panel dc-panel--login",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Sign in"}),e.jsx("p",{children:"Use your assigned username to manage or confirm deliveries."})]}),e.jsxs("form",{className:"dc-form",onSubmit:de,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"username",children:"Username"}),e.jsx("input",{id:"username",name:"username",type:"text",value:o,onChange:s=>K(s.target.value),placeholder:"shop or driver",className:"dc-input",required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"password",children:"Password"}),e.jsx("input",{id:"password",name:"password",type:"password",value:C,onChange:s=>Q(s.target.value),className:"dc-input",required:!0})]}),A&&e.jsx("div",{className:"dc-form__error",children:A}),e.jsxs("div",{className:"dc-form__actions",children:[e.jsx("button",{className:"dc-button",type:"submit",disabled:j,children:j?"Signing in...":"Sign in"}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:re,disabled:E||j,children:E?"Requesting...":"Forgot password?"})]}),$&&e.jsx("div",{className:"dc-alert",children:$})]})]}),X&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Create delivery"}),e.jsx("p",{children:"Generate a delivery ID and one-time code tied to the address."})]}),e.jsxs("form",{className:"dc-form",onSubmit:ce,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"address",children:"Delivery address"}),e.jsx("textarea",{id:"address",name:"address",className:"dc-input dc-input--multiline",value:y,onChange:s=>N(s.target.value),placeholder:"12 Finchley rd, London, NW3 5JD",rows:3,required:!0})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:L,children:L?"Creating...":"Generate code"}),g&&e.jsxs("div",{className:"dc-alert",children:[e.jsx("div",{className:"dc-alert__title",children:"Delivery created"}),e.jsxs("div",{className:"dc-alert__codes",children:[e.jsxs("span",{children:["Delivery ID: ",g.delivery_id]}),e.jsxs("span",{children:["Secret code: ",g.secret_code]})]}),e.jsx("div",{className:"dc-alert__hint",children:"Share these with the recipient securely."})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsx("div",{className:"dc-panel__header",children:e.jsx("h2",{children:"Your deliveries"})}),F.length===0?e.jsx("p",{className:"dc-empty",children:"No deliveries yet."}):e.jsx("div",{className:"dc-list",children:F.map(s=>e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",s.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:s.address})]}),e.jsx("span",{className:`dc-chip dc-chip--${s.status}`,children:Y(s.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Secret code"}),e.jsx("dd",{className:"dc-code",children:s.secret_code})]}),e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Created"}),e.jsx("dd",{children:h(s.created_at)})]}),s.validated_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Completed"}),e.jsx("dd",{children:h(s.validated_at)})]}),s.locked_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Locked"}),e.jsx("dd",{children:h(s.locked_at)})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>u[s.delivery_id]?v(t=>{const d={...t};return delete d[s.delivery_id],d}):se(s.delivery_id),children:u[s.delivery_id]?"Close":"View attempts"})}),u[s.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"User"}),e.jsx("span",{children:"Result"})]}),u[s.delivery_id].map(t=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:t.attempt_number}),e.jsx("span",{children:h(t.created_at)}),e.jsx("span",{children:t.delivery_person}),e.jsx("span",{className:t.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:t.success?"Verified":"Failed"})]},t.attempt_number)),u[s.delivery_id].length===0&&e.jsx("div",{className:"dc-table__row dc-table__row--muted",children:"No attempts yet."})]})]},s.delivery_id))})]})]}),Z&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Validate a delivery"}),e.jsx("p",{children:"Enter the delivery ID and the 6-digit code provided by the shop staff."})]}),e.jsxs("form",{className:"dc-form",onSubmit:ie,children:[e.jsxs("div",{className:"dc-form__group",children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"deliveryId",children:"Delivery ID"}),e.jsx("input",{id:"deliveryId",name:"deliveryId",type:"number",className:"dc-input",value:T,onChange:s=>O(s.target.value),required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"secretCode",children:"Secret code"}),e.jsx("input",{id:"secretCode",name:"secretCode",type:"text",inputMode:"numeric",autoComplete:"one-time-code",pattern:"^[0-9]{6}$",maxLength:6,className:"dc-input",value:P,onChange:s=>te(s.target.value),required:!0})]})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:V,children:V?"Submitting...":"Submit attempt"}),q&&e.jsx("div",{className:"dc-form__error",children:q}),n&&e.jsxs("div",{className:`dc-alert ${n.success?"dc-alert--success":""}`,children:[e.jsxs("div",{className:"dc-alert__title",children:["Attempt ",n.attempt_number," · Delivery ",n.delivery_id]}),e.jsx("p",{className:"dc-alert__hint",children:_e(n.status,n.success,n.remaining_attempts)})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Recent attempts"}),e.jsx("p",{children:"Your attempts grouped by delivery"})]}),W.length===0?e.jsx("p",{className:"dc-empty",children:"No attempts logged yet."}):e.jsx("div",{className:"dc-list",children:W.map(s=>{const t=s.attempts[0];return e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",s.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:s.address}),t&&e.jsxs("p",{className:"dc-card__hint",children:["Last attempt #",t.attempt_number," ·"," ",h(t.created_at)]})]}),e.jsx("span",{className:`dc-chip dc-chip--${s.status}`,children:Y(s.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Total attempts"}),e.jsx("dd",{children:s.attempts.length})]}),t&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Latest result"}),e.jsx("dd",{className:t.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:t.success?"Verified":"Failed"})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>G(d=>({...d,[s.delivery_id]:!d[s.delivery_id]})),children:B[s.delivery_id]?"Hide attempts":"View attempts"})}),B[s.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"Result"})]}),s.attempts.map(d=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:d.attempt_number}),e.jsx("span",{children:h(d.created_at)}),e.jsx("span",{className:d.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:d.success?"Verified":"Failed"})]},`${d.delivery_id}-${d.attempt_number}`))]})]},s.delivery_id)})})]})]})]})},z=document.getElementById("root");if(!z)throw new Error("Root element #root not found");me.createRoot(z).render(e.jsx(he.StrictMode,{children:e.jsx(xe,{})}));
