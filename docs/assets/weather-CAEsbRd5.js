import"./index-BRH-H6m_.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{P as xe,u as Ve,T as Be}from"./Toast-CC0uQ94P.js";import{A as M}from"./api-CH_Pe6Vg.js";import{B as z}from"./button-BRMX--fC.js";import{M as ie,C as pe,a as Ze}from"./map-BsqQ6ULd.js";import{C as Je}from"./chevron-left-CGHllpLw.js";import{c as Y}from"./createLucideIcon-DtX1aPOG.js";import{L as Ce,a as B,I as q}from"./label-D6I6lMvU.js";import{L as Ye}from"./log-out-B0TqtotO.js";import{P as fe}from"./pen-vQk8amFZ.js";import{T as _e}from"./trash-2-DQbJ9aIh.js";import{G as Le,U as Ke,D as Xe}from"./upload-CK6mc6ZD.js";import{S as Qe}from"./search-Cfl0sis-.js";import{X as et}from"./x-BS-d4QNZ.js";import{S as tt}from"./save-rN7CZjMN.js";import{L as at}from"./index-BehiXGmn.js";import"./utils-CN4411gJ.js";import"./clsx-B-dksMZM.js";const st=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],nt=Y("clock",st);const ot=[["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"M16 14v6",key:"1j4efv"}],["path",{d:"M8 14v6",key:"17c4r9"}],["path",{d:"M12 16v6",key:"c8a4gj"}]],ve=Y("cloud-rain",ot);const rt=[["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}],["path",{d:"M15.947 12.65a4 4 0 0 0-5.925-4.128",key:"dpwdj0"}],["path",{d:"M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z",key:"s09mg5"}]],it=Y("cloud-sun",rt);const lt=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],dt=Y("layers",lt);const ct=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],ut=Y("sun",ct);const mt=[["path",{d:"M12 2v8",key:"1q4o3n"}],["path",{d:"m4.93 10.93 1.41 1.41",key:"2a7f42"}],["path",{d:"M2 18h2",key:"j10viu"}],["path",{d:"M20 18h2",key:"wocana"}],["path",{d:"m19.07 10.93-1.41 1.41",key:"15zs5n"}],["path",{d:"M22 22H2",key:"19qnx5"}],["path",{d:"m8 6 4-4 4 4",key:"ybng9g"}],["path",{d:"M16 18a4 4 0 0 0-8 0",key:"1lzouq"}]],ht=Y("sunrise",mt);const pt=[["path",{d:"M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z",key:"17jzev"}]],Ne=Y("thermometer",pt);const xt=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],ft=Y("zoom-in",xt),he="e1f10a1e78da46f5b10a1e78da96f525";function re(t,a){return t.map(s=>s!==null&&s<=a?0:s)}const W=()=>{const t=localStorage.getItem("weather_token"),a={"Content-Type":"application/json"};return t&&(a.Authorization=`Bearer ${t}`),a},E={async getWeatherData(){const t=await fetch(`${M}/weather/data`,{headers:W()});if(!t.ok)throw new Error("Failed to fetch weather data");return t.json()},async register(t,a,s,n){const c=await fetch(`${M}/weather/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:a,first_name:s,last_name:n})});if(!c.ok)throw new Error("Registration failed");return c.json()},async login(t,a){const s=await fetch(`${M}/weather/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:a})});if(!s.ok)throw new Error("Login failed");return s.json()},async getMe(){const t=await fetch(`${M}/weather/me`,{headers:W()});if(!t.ok)throw new Error("Failed to get user");return t.json()},async addGroup(t){const a=await fetch(`${M}/weather/groups`,{method:"POST",headers:W(),body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to add group");return a.json()},async updateGroup(t,a){const s=await fetch(`${M}/weather/groups/${t}`,{method:"PUT",headers:W(),body:JSON.stringify(a)});if(!s.ok)throw new Error("Failed to update group");return s.json()},async deleteGroup(t){const a=await fetch(`${M}/weather/groups/${t}`,{method:"DELETE",headers:W()});if(!a.ok)throw new Error("Failed to delete group");return a.json()},async reorderGroups(t){const a=await fetch(`${M}/weather/groups/reorder`,{method:"POST",headers:W(),body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to reorder groups");return a.json()},async addPlace(t){const a=await fetch(`${M}/weather/places`,{method:"POST",headers:W(),body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to add place");return a.json()},async updatePlace(t,a){const s=await fetch(`${M}/weather/places/${t}`,{method:"PUT",headers:W(),body:JSON.stringify(a)});if(!s.ok)throw new Error("Failed to update place");return s.json()},async deletePlace(t){const a=await fetch(`${M}/weather/places/${t}`,{method:"DELETE",headers:W()});if(!a.ok)throw new Error("Failed to delete place");return a.json()},async reorderPlaces(t){const a=await fetch(`${M}/weather/places/reorder`,{method:"POST",headers:W(),body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to reorder places");return a.json()},async exportPlaces(){const t=await fetch(`${M}/weather/export`,{headers:W()});if(!t.ok)throw new Error("Failed to export places");return t.json()},async importPlaces(t){const a=await fetch(`${M}/weather/import`,{method:"POST",headers:W(),body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to import places");return a.json()},async searchPlace(t){const a=await fetch(`${M}/weather/search?link_wu=${encodeURIComponent(t)}`,{headers:W()});if(!a.ok){const s=await a.json().catch(()=>({}));throw new Error(s.detail||"Failed to search place")}return a.json()},async fetchWUForecast(t){const a=`https://api.weather.com/v3/wx/forecast/hourly/15day?apiKey=${he}&geocode=${t.coords[0]}%2C${t.coords[1]}&units=m&language=en-US&format=json`,n=await(await fetch(a,{referrerPolicy:"no-referrer"})).json();return{tzOffset:n.validTimeLocal[0]?.slice(19),x:n.validTimeLocal.map(c=>new Date(c.slice(0,19))),y_precipitation:n.qpf,y_humidity:n.relativeHumidity,y_snow:re(n.qpfSnow,0),y_temperature:n.temperature,y_windGust:n.windGust,y_precipChance:n.precipChance,y_uvIndex:re(n.uvIndex,0),y_cloudCover:re(n.cloudCover,0)}},async fetchWUHistory(t){const a=`https://api.weather.com/v3/wx/conditions/historical/hourly/1day?apiKey=${he}&geocode=${t.coords[0]}%2C${t.coords[1]}&units=m&language=en-US&format=json`,n=await(await fetch(a,{referrerPolicy:"no-referrer"})).json();return{tzOffset:n.validTimeLocal[0]?.slice(19),x:n.validTimeLocal.map(c=>new Date(c.slice(0,19))),y_precipitation:[],y_humidity:n.relativeHumidity,y_snow:[],y_temperature:n.temperature,y_windGust:n.windGust,y_precipChance:[],y_uvIndex:re(n.uvIndex,0),y_cloudCover:[],sunriseTimeLocal:n.sunriseTimeLocal[0],sunsetTimeLocal:n.sunsetTimeLocal[0]}},async fetchWUPollen(t){const a=`https://api.weather.com/v2/turbo/vt1pollenforecast?apiKey=${he}&geocode=${t.coords[0]}%2C${t.coords[1]}&language=en&format=json`,n=await(await fetch(a)).json();return{x:n.vt1pollenforecast?.reportDate.map(c=>new Date(c.slice(0,19)))||[],y_tree:n.vt1pollenforecast?.tree||[],y_weed:n.vt1pollenforecast?.weed||[],y_grass:n.vt1pollenforecast?.grass||[]}}},gt=()=>{const[t,a]=React.useState([]),[s,n]=React.useState([]),[c,p]=React.useState(null),[x,S]=React.useState(()=>{const o=localStorage.getItem("weather_zoom");return o==="STANDARD"?"z1x":o==="DETAILED"?"z2x":o==="MACRO"?"z3x":o==="COMPACT"?"z2x":o||"z2x"}),[T,g]=React.useState(!0),[f,j]=React.useState(null),[i,w]=React.useState(()=>typeof window>"u"?!1:new URLSearchParams(window.location.search).get("view")==="login"),[b,k]=React.useState(()=>typeof window>"u"?!1:new URLSearchParams(window.location.search).get("view")==="edit"),[P,d]=React.useState("idle"),m=React.useCallback(async()=>{d("loading");try{const o=await E.getWeatherData();a(o.places),n(o.groups);const I=new URLSearchParams(window.location.search).get("location"),Z=localStorage.getItem("weather_location"),F=o.places.find(Q=>Q.name===I)||o.places.find(Q=>Q.name===Z)||o.places[0];p(F),d("success")}catch(o){console.error("Failed to load weather data",o),d("error")}finally{g(!1)}},[]);React.useEffect(()=>{m(),localStorage.getItem("weather_token")&&E.getMe().then(j).catch(()=>{localStorage.removeItem("weather_token"),j(null)})},[m]),React.useEffect(()=>{const o=()=>{const u=new URLSearchParams(window.location.search);w(u.get("view")==="login"),k(u.get("view")==="edit");const I=u.get("location");I&&a(Z=>{const F=Z.find(Q=>Q.name===I);return F&&p(F),Z})};return window.addEventListener("popstate",o),()=>window.removeEventListener("popstate",o)},[]);const r=()=>{const o=new URLSearchParams(window.location.search);o.get("view")!=="login"&&(o.set("view","login"),window.history.pushState({},"",`?${o.toString()}`),w(!0),k(!1))},l=()=>{const o=new URLSearchParams(window.location.search);o.get("view")!=="edit"&&(o.set("view","edit"),window.history.pushState({},"",`?${o.toString()}`),k(!0),w(!1))},R=()=>{const o=new URLSearchParams(window.location.search);if(o.has("view")){o.delete("view");const u=o.toString();window.history.pushState({},"",u?`?${u}`:window.location.pathname),w(!1),k(!1)}else w(!1),k(!1)};return React.useEffect(()=>{f&&new URLSearchParams(window.location.search).get("view")!=="edit"&&l()},[f]),{places:t,groups:s,selectedPlace:c,loading:T,user:f,showLogin:i,showEdit:b,requestState:P,zoomLevel:x,setZoomLevel:o=>{S(o),localStorage.setItem("weather_zoom",o)},handlePlaceChange:o=>{p(o),localStorage.setItem("weather_location",o.name);const u=new URLSearchParams(window.location.search);u.get("location")!==o.name&&(u.set("location",o.name),window.history.pushState({},"",`?${u.toString()}`))},login:async(o,u)=>{try{const I=await E.login(o,u);return localStorage.setItem("weather_token",I.access_token),j(I.user),await m(),!0}catch(I){return console.error("Login failed",I),!1}},register:async(o,u,I,Z)=>{try{const F=await E.register(o,u,I,Z);return localStorage.setItem("weather_token",F.access_token),j(F.user),await m(),!0}catch(F){return console.error("Registration failed",F),!1}},logout:async()=>{localStorage.removeItem("weather_token"),j(null),await m(),R()},navigateToLogin:r,navigateToEdit:l,navigateToPublic:R,handleAddGroup:async o=>{const u=await E.addGroup(o);a(u.places),n(u.groups)},handleUpdateGroup:async(o,u)=>{const I=await E.updateGroup(o,u);a(I.places),n(I.groups)},handleDeleteGroup:async o=>{if(!window.confirm("Are you sure you want to delete this group? Places in this group will become standalone."))return;const u=await E.deleteGroup(o);a(u.places),n(u.groups)},handleReorderGroups:async o=>{const u=await E.reorderGroups(o);a(u.places),n(u.groups)},handleAddPlace:async o=>{const u=await E.addPlace(o);a(u.places),n(u.groups)},handleUpdatePlace:async(o,u)=>{const I=await E.updatePlace(o,u);a(I.places),n(I.groups)},handleDeletePlace:async o=>{if(!window.confirm("Are you sure you want to delete this location?"))return;const u=await E.deletePlace(o);a(u.places),n(u.groups)},handleReorderPlaces:async o=>{const u=await E.reorderPlaces(o);a(u.places),n(u.groups)},handleSearchPlace:async o=>await E.searchPlace(o),handleExportPlaces:async()=>await E.exportPlaces(),handleImportPlaces:async o=>{const u=await E.importPlaces(o);a(u.places)}}},Se=({places:t,selectedPlace:a,onSelect:s})=>{const[n,c]=React.useState(!1),[p,x]=React.useState(null),S=React.useRef(null),T=React.useRef(null),{groups:g,standalone:f}=React.useMemo(()=>{const i={},w=[];return t.forEach(b=>{b.group?(i[b.group]||(i[b.group]=[]),i[b.group].push(b)):w.push(b)}),{groups:i,standalone:w}},[t]);React.useEffect(()=>{const i=w=>{S.current&&!S.current.contains(w.target)&&c(!1)};return n&&document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[n]),React.useEffect(()=>{n?a?.group&&x(a.group):x(null)},[n,a]);const j=i=>{s(i),c(!1)};return e.jsxs("div",{className:"relative inline-block w-full md:w-64",ref:S,"data-testid":"place-dropdown",children:[e.jsxs("button",{type:"button",ref:T,onClick:()=>c(!n),className:"flex w-full items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-2 text-left font-semibold text-slate-700 shadow-sm transition-all hover:bg-slate-50 focus:ring-2 focus:ring-indigo-500/20 focus:outline-none","aria-haspopup":"listbox","aria-expanded":n,"data-testid":"place-dropdown-trigger",children:[e.jsxs("div",{className:"flex items-center gap-2 truncate",children:[e.jsx(ie,{className:"size-4 shrink-0 text-indigo-500"}),e.jsx("span",{className:"truncate",children:a?.name||"Select location..."})]}),e.jsx(pe,{className:`size-4 text-slate-400 transition-transform duration-200 ${n?"rotate-180":""}`})]}),n&&e.jsx("div",{className:"animate-in fade-in zoom-in absolute z-20 mt-2 max-h-80 w-full overflow-hidden rounded-xl border border-slate-200 bg-white p-1 shadow-xl duration-200",role:"listbox",children:p?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("button",{type:"button",onClick:()=>x(null),className:"flex w-full items-center gap-2 rounded-lg border-b border-slate-100 px-3 py-2 text-left text-xs font-bold text-indigo-600 transition-colors hover:bg-slate-50","data-testid":"group-back-button",children:[e.jsx(Je,{className:"size-3.5"}),e.jsx("span",{children:"Back to all"}),e.jsx("span",{className:"ml-auto font-normal text-slate-400",children:p})]}),e.jsx("ul",{className:"max-h-60 overflow-auto p-1",children:g[p].map(i=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>j(i),className:`flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left text-sm transition-colors ${a?.name===i.name?"bg-indigo-50 font-bold text-indigo-700":"text-slate-600 hover:bg-slate-50"}`,role:"option","aria-selected":a?.name===i.name,"data-testid":`place-item-${i.name}`,children:[e.jsx(ie,{className:`size-3.5 ${a?.name===i.name?"text-indigo-500":"text-slate-400"}`}),e.jsx("span",{className:"truncate",children:i.name}),i.country&&e.jsx("span",{className:"ml-auto text-[10px] font-medium tracking-wider text-slate-400 uppercase",children:i.country})]})},i.name))})]}):e.jsxs("ul",{className:"max-h-60 overflow-auto",children:[Object.keys(g).map(i=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>x(i),className:"flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm text-slate-600 transition-colors hover:bg-slate-50","data-testid":`group-item-${i}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(dt,{className:"size-3.5 text-indigo-400"}),e.jsx("span",{className:"font-bold",children:i})]}),e.jsx(pe,{className:"size-3.5 -rotate-90 text-slate-300"})]})},i)),f.map(i=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>j(i),className:`flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left text-sm transition-colors ${a?.name===i.name?"bg-indigo-50 font-bold text-indigo-700":"text-slate-600 hover:bg-slate-50"}`,role:"option","aria-selected":a?.name===i.name,"data-testid":`place-item-${i.name}`,children:[e.jsx(ie,{className:`size-3.5 ${a?.name===i.name?"text-indigo-500":"text-slate-400"}`}),e.jsx("span",{className:"truncate",children:i.name}),i.country&&e.jsx("span",{className:"ml-auto text-[10px] font-medium tracking-wider text-slate-400 uppercase",children:i.country})]})},i.name))]})})]})},wt=({isAdmin:t,userEmail:a,userFirstName:s,userMembership:n,onLoginClick:c,onLogoutClick:p,onLogoClick:x,showLoginButton:S,places:T=[],selectedPlace:g=null,onPlaceChange:f})=>e.jsxs("header",{className:"sticky top-0 z-10 w-full border-b bg-white shadow-sm","data-testid":"weather-navbar",children:[e.jsxs("div",{className:"mx-auto flex max-w-7xl items-center justify-between gap-4 px-4 py-2 md:py-4",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("button",{onClick:x,className:"flex items-center gap-2 transition-opacity hover:opacity-80","data-testid":"navbar-logo",children:[e.jsx("img",{src:"/favicon_weather.png",alt:"",className:"size-8","aria-hidden":"true"}),e.jsx("h1",{className:"bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-2xl font-bold text-transparent",children:"Weather"})]})}),f&&e.jsx("div",{className:"hidden max-w-md flex-1 items-center gap-3 md:flex","data-testid":"place-dropdown-desktop",children:e.jsx(Se,{places:T,selectedPlace:g,onSelect:f})}),e.jsxs("div",{className:"flex items-center gap-4",children:[S&&e.jsxs(z,{variant:"ghost",className:"gap-2 text-slate-600 hover:bg-slate-100",onClick:c,"data-testid":"login-button",children:[e.jsx(Ce,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Login"})]}),a&&e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("span",{className:"text-sm font-medium text-slate-500 md:inline","data-testid":"user-display-name",children:s||a}),n&&e.jsx("span",{className:"text-[10px] font-bold tracking-wider text-indigo-500 uppercase","data-testid":"user-membership",children:n})]}),e.jsx(z,{variant:"ghost",size:"icon",onClick:p,className:"text-slate-400 hover:bg-slate-100 hover:text-red-500",title:"Logout","data-testid":"logout-button",children:e.jsx(Ye,{size:20})})]})]})]}),f&&e.jsx("div",{className:"border-t px-4 py-2 md:hidden","data-testid":"place-dropdown-mobile",children:e.jsx(Se,{places:T,selectedPlace:g,onSelect:f})})]}),yt=({onLogin:t,onRegister:a,onCancel:s})=>{const[n,c]=React.useState(""),[p,x]=React.useState(""),[S,T]=React.useState(""),[g,f]=React.useState(""),[j,i]=React.useState(""),[w,b]=React.useState(""),[k,P]=React.useState(!1),[d,m]=React.useState(!1),r=async R=>{if(R.preventDefault(),b(""),d&&p!==S){b("Passwords do not match");return}P(!0),(d?await a(n,p,g,j):await t(n,p))||(b(d?"Registration failed":"Invalid email or password"),P(!1))},l=()=>e.jsx("span",{className:"ml-0.5 font-bold text-red-500",children:"*"});return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4","data-testid":"login-view",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border bg-white p-8 shadow-xl",children:[e.jsxs("div",{className:"mb-8 flex flex-col items-center",children:[e.jsx("div",{className:"mb-4 rounded-2xl bg-indigo-50 p-3",children:e.jsx(Ce,{className:"size-8 text-indigo-600"})}),e.jsx("h2",{className:"text-2xl font-bold","data-testid":"login-title",children:d?"Create Account":"Login"}),e.jsx("p",{className:"mt-1 text-sm text-slate-500",children:d?"Join us to save your locations":"Access your personalized weather"})]}),e.jsxs("form",{onSubmit:r,className:"space-y-6",children:[d&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"firstName",children:["First Name ",e.jsx(l,{})]}),e.jsx(q,{id:"firstName",value:g,onChange:R=>f(R.target.value),placeholder:"John",required:!0,className:"rounded-xl","data-testid":"login-firstname-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"lastName",children:["Last Name ",e.jsx(l,{})]}),e.jsx(q,{id:"lastName",value:j,onChange:R=>i(R.target.value),placeholder:"Doe",required:!0,className:"rounded-xl","data-testid":"login-lastname-input"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"email",children:["Email address ",e.jsx(l,{})]}),e.jsx(q,{id:"email",type:"email",autoComplete:"email",value:n,onChange:R=>c(R.target.value),placeholder:"user@example.com",required:!0,className:"rounded-xl","data-testid":"login-email-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"password",children:["Password ",e.jsx(l,{})]}),e.jsx(q,{id:"password",type:"password",autoComplete:d?"new-password":"current-password",value:p,onChange:R=>x(R.target.value),placeholder:"••••••••",required:!0,className:"rounded-xl","data-testid":"login-password-input"})]}),d&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"confirmPassword",children:["Confirm Password ",e.jsx(l,{})]}),e.jsx(q,{id:"confirmPassword",type:"password",autoComplete:"new-password",value:S,onChange:R=>T(R.target.value),placeholder:"••••••••",required:!0,className:"rounded-xl","data-testid":"login-confirm-password-input"})]}),w&&e.jsx("p",{className:"text-sm font-medium text-red-500","data-testid":"login-error-message",children:w}),e.jsxs("div",{className:"flex flex-col gap-3 pt-2",children:[e.jsx(z,{type:"submit",disabled:k,className:"h-auto w-full rounded-xl py-6 text-lg","data-testid":"login-submit-button",children:k?d?"Creating...":"Logging in...":d?"Sign Up":"Login"}),e.jsx("button",{type:"button",onClick:()=>m(!d),className:"text-sm text-indigo-600 hover:underline","data-testid":"toggle-auth-mode",children:d?"Already have an account? Login":"Don't have an account? Sign up"}),e.jsx(z,{type:"button",variant:"ghost",onClick:s,className:"w-full text-slate-500","data-testid":"login-cancel-button",children:"Cancel"})]})]})]})})},D={LINE_WIDTH_DEFAULT:2,LINE_WIDTH_FILLED_AREA:2,TENSION:.3,POINT_RADIUS:1,HIT_RADIUS:16},bt={z1x:"2000px",z2x:"4000px",z3x:"6000px",z4x:"8000px"},ke={free:{locations:10,groups:1},pro:{locations:50,groups:10},max:{locations:200,groups:50}},jt=({groups:t,userId:a,userGroups:s,orderedGroups:n,limits:c,isAtGroupLimit:p,draggedGroupId:x,canDragGroupId:S,onAddGroup:T,onUpdateGroup:g,onDeleteGroup:f,onDragStart:j,onDragOver:i,onDragEnd:w,setCanDragGroupId:b})=>{const[k,P]=React.useState(""),[d,m]=React.useState(null),[r,l]=React.useState(""),R=async N=>{N.preventDefault(),k.trim()&&(await T(k),P(""))},H=async N=>{N.preventDefault(),!(!d||!r.trim())&&(await g(d,r),m(null),l(""))};return e.jsx("div",{className:"mt-8","data-testid":"groups-management-section",children:e.jsx("div",{className:"overflow-hidden rounded-2xl border bg-white shadow-sm","data-testid":"groups-table-container",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"border-b bg-slate-50 md:table-header-group",children:e.jsx("tr",{children:e.jsx("th",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-xs font-bold text-slate-500 uppercase",children:"Groups"}),e.jsxs("span",{className:"text-xs font-normal text-slate-500",children:[s.length," / ",c.groups]})]})})})}),e.jsxs("tbody",{className:"divide-y",children:[n.map(N=>e.jsxs("tr",{draggable:S===N.id,onDragStart:()=>N.id&&j(N.id),onDragOver:G=>N.id&&i(G,N.id),onDragEnd:w,className:`flex flex-col border-b transition-colors last:border-b-0 hover:bg-slate-50 md:table-row md:border-b-0 ${x===N.id?"bg-indigo-50/50 opacity-40":""} ${S===N.id?"select-none":""}`,"data-testid":`group-row-${N.id}`,children:[e.jsx("td",{className:"block px-6 pt-2 md:table-cell",children:d===N.id?e.jsxs("form",{onSubmit:H,className:"flex flex-1 gap-2 py-2",children:[e.jsx(q,{value:r,onChange:G=>l(G.target.value),autoFocus:!0,className:"h-9 rounded-xl"}),e.jsx(z,{type:"submit",className:"h-9",children:"Save"}),e.jsx(z,{variant:"outline",onClick:()=>m(null),className:"h-9",children:"Cancel"})]}):e.jsx("span",{className:"block font-bold",children:N.name})}),e.jsx("td",{className:"ml-auto block px-6 text-left md:table-cell md:text-right",children:e.jsxs("div",{className:"flex justify-start gap-1 md:justify-end",children:[e.jsx(z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-indigo-600",onClick:()=>{m(N.id),l(N.name)},children:e.jsx(fe,{size:14})}),e.jsx(z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-red-600",onClick:()=>N.id&&f(N.id),children:e.jsx(_e,{size:14})}),e.jsx("div",{className:"cursor-grab touch-none p-2 text-slate-300 transition-colors hover:text-indigo-600 active:cursor-grabbing",title:"Hold to drag","data-testid":`group-drag-handle-${N.id}`,onMouseDown:()=>b(N.id||null),onMouseUp:()=>b(null),onTouchStart:()=>b(N.id||null),onTouchEnd:()=>b(null),onTouchCancel:()=>b(null),onClick:G=>G.stopPropagation(),children:e.jsx(Le,{size:18})})]})})]},N.id)),!p&&e.jsx("tr",{className:"flex flex-col bg-slate-50/30 md:table-row",children:e.jsx("td",{colSpan:2,className:"block px-6 py-4 md:table-cell",children:e.jsxs("form",{onSubmit:R,className:"flex gap-2",children:[e.jsx(q,{placeholder:"New Group Name...",value:k,onChange:N=>P(N.target.value),className:"rounded-xl","data-testid":"new-group-name-input"}),e.jsxs(z,{type:"submit",disabled:!k.trim(),className:"gap-2 rounded-xl","data-testid":"submit-group-button",children:[e.jsx(xe,{size:18})," Add"]})]})})})]})]})})})},vt=({isImporting:t,onImportClick:a,onExportYAML:s})=>e.jsxs("div",{className:"mb-8 flex flex-col items-start justify-between gap-4 px-4 sm:flex-row sm:items-center","data-testid":"management-header",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-2xl font-bold","data-testid":"management-title",children:"Manage"})}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(z,{variant:"outline",onClick:a,className:"gap-2 rounded-xl",disabled:t,"data-testid":"import-yaml-button",children:[e.jsx(Ke,{size:18})," Import YAML"]}),e.jsxs(z,{variant:"outline",onClick:s,className:"gap-2 rounded-xl","data-testid":"export-yaml-button",children:[e.jsx(Xe,{size:18})," Export YAML"]})]})]}),Nt=({groups:t,userId:a,userRole:s,className:n="",...c})=>e.jsxs("select",{className:`flex h-10 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:ring-2 focus-visible:ring-indigo-600 focus-visible:ring-offset-2 focus-visible:outline-none disabled:cursor-not-allowed disabled:opacity-50 ${n}`,"data-testid":"group-select",...c,children:[e.jsx("option",{value:"",children:"---"}),t.filter(p=>p.user_id===a||s==="admin").map(p=>e.jsx("option",{value:p.id,children:p.name},p.id))]}),St=({editingPlace:t,groups:a,userId:s,userRole:n,isSearching:c,isAutoFetching:p,onSearchPlace:x,onSubmit:S,onCancel:T})=>{const[g,f]=React.useState({name:"",coords:[0,0],linkWU:"",country:"",group_id:null}),[j,i]=React.useState(""),[w,b]=React.useState(!1);React.useEffect(()=>{t?(f(t),i(`${t.coords[0]}, ${t.coords[1]}`)):(f({name:"",coords:[0,0],linkWU:"",country:"",group_id:null}),i(""))},[t]);const k=async()=>{if(g.linkWU){b(!0);try{const m=await x(g.linkWU);f(r=>({...r,name:m.city||r.name,coords:[m.lat,m.lon],country:m.countryCode||r.country})),i(`${m.lat}, ${m.lon}`)}finally{b(!1)}}},P=m=>{m.preventDefault(),S(g,j)},d=w||c||p;return e.jsxs("div",{className:"animate-in fade-in slide-in-from-top-4 mb-8 rounded-2xl border bg-white p-6 shadow-lg duration-300","data-testid":"place-form-container",children:[e.jsxs("h3",{className:"mb-6 flex items-center gap-2 text-lg font-bold",children:[t?e.jsx(fe,{size:20,className:"text-indigo-600"}):e.jsx(xe,{size:20,className:"text-indigo-600"}),t?"Edit Location":"Add New Location"]}),e.jsxs("form",{onSubmit:P,className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"name",children:["City Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{id:"name",value:g.name,onChange:m=>f({...g,name:m.target.value}),required:!0,className:"rounded-xl","data-testid":"place-name-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"country",children:"Country Code"}),e.jsx(q,{id:"country",value:g.country||"",onChange:m=>f({...g,country:m.target.value}),placeholder:"GB, FRA, ZAF...",className:"rounded-xl","data-testid":"place-country-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"coords",children:"Coordinates (lat, lon)"}),e.jsx(q,{id:"coords",value:j,onChange:m=>i(m.target.value),placeholder:"51.507, -0.127 (Auto-fetch if empty)",className:"rounded-xl","data-testid":"place-coords-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"linkWU",children:["WU Path (or URL) ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{id:"linkWU",value:g.linkWU,onChange:m=>{let r=m.target.value;const l="https://www.wunderground.com/weather/";r.startsWith(l)&&(r=r.substring(l.length)),f({...g,linkWU:r})},placeholder:"gb/london/ILONDO440",required:!0,className:"rounded-xl","data-testid":"place-link-wu-input"}),e.jsx(z,{type:"button",variant:"outline",size:"icon",onClick:k,disabled:!g.linkWU||d,className:"shrink-0 rounded-xl",title:"Fetch details from Wunderground","data-testid":"fetch-wu-details-button",children:e.jsx(Qe,{size:18,className:w?"animate-pulse":""})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"group",children:"Group"}),e.jsx(Nt,{id:"group",value:g.group_id||"",onChange:m=>f({...g,group_id:m.target.value?parseInt(m.target.value):null}),groups:a,userId:s,userRole:n,"data-testid":"place-group-select"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 md:col-span-2",children:[e.jsxs(z,{type:"button",variant:"outline",onClick:T,disabled:d,className:"rounded-xl","data-testid":"cancel-form-button",children:[e.jsx(et,{size:18,className:"mr-2"})," Cancel"]}),e.jsx(z,{type:"submit",className:"min-w-[120px] rounded-xl",disabled:d,"data-testid":"save-place-button",children:p?e.jsx(e.Fragment,{children:"Searching..."}):e.jsxs(e.Fragment,{children:[e.jsx(tt,{size:18,className:"mr-2"})," ",t?"Update":"Save"]})})]})]})]})},kt=({places:t,orderedPlaces:a,groups:s,userPlaces:n,limits:c,isAtLimit:p,draggedId:x,canDragId:S,onAddClick:T,onEdit:g,onDelete:f,onDragStart:j,onDragOver:i,onDragEnd:w,onDropOnGroup:b,setCanDragId:k})=>{const P=React.useMemo(()=>{const d={};a.forEach(r=>{const l=r.group||"---";d[l]||(d[l]=[]),d[l].push(r)});const m=[];return s.forEach(r=>{m.push([r.name,d[r.name]||[]]),delete d[r.name]}),(d["---"]||m.length===0)&&(m.push(["---",d["---"]||[]]),delete d["---"]),Object.entries(d).forEach(r=>m.push(r)),m.filter(([r,l])=>l.length>0?!0:r!=="---")},[s,a]);return e.jsx("div",{className:"rounded-2xl border bg-white shadow-sm","data-testid":"places-table-container",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"border-b bg-slate-50 md:table-header-group",children:e.jsx("tr",{children:e.jsx("th",{className:"px-6 text-xs tracking-wider text-slate-500",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-bold uppercase",children:"Locations"}),e.jsxs("span",{className:"p-4 text-xs font-normal text-slate-500","data-testid":"location-counter",children:[n.length," / ",c.locations," locations used"]}),e.jsxs(z,{onClick:T,disabled:p,className:"h-8 gap-2 rounded-xl","data-testid":"add-place-button",children:[e.jsx(xe,{size:16})," ",p?"Limit Reached":"Add"]})]})})})}),e.jsx("tbody",{className:"divide-y",children:P.map(([d,m])=>e.jsxs(React.Fragment,{children:[e.jsx("tr",{className:"flex flex-col bg-slate-50/50 transition-colors md:table-row",onDragOver:r=>{r.preventDefault(),r.currentTarget.classList.add("bg-indigo-100/50")},onDragLeave:r=>{r.currentTarget.classList.remove("bg-indigo-100/50")},onDrop:r=>{r.currentTarget.classList.remove("bg-indigo-100/50"),b(r,d)},"data-testid":`group-header-${d}`,children:e.jsx("td",{colSpan:2,className:"block px-6 py-2 text-[0.75rem] font-bold tracking-widest text-indigo-500 uppercase md:table-cell",children:d})}),m.map(r=>e.jsxs("tr",{draggable:S===r.id,onDragStart:()=>r.id&&j(r.id),onDragOver:l=>r.id&&i(l,r.id),onDragEnd:w,onDrop:l=>r.id&&b(l,d),className:`flex flex-col border-b transition-colors last:border-b-0 hover:bg-slate-50 md:table-row md:border-b-0 ${x===r.id?"bg-indigo-50/50 opacity-40":""} ${S===r.id?"select-none":""}`,"data-testid":`place-row-${r.id}`,children:[e.jsx("td",{className:"block px-6 pt-2 md:table-cell",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"rounded-lg bg-indigo-50 p-2",children:e.jsx(ie,{size:16,className:"text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold",children:r.name}),e.jsx("div",{className:"flex gap-2 text-xs text-slate-400",children:e.jsx("span",{children:r.country||"N/A"})})]})]})}),e.jsx("td",{className:"ml-auto block px-6 text-left md:table-cell md:text-right",children:e.jsxs("div",{className:"flex justify-start gap-2 md:justify-end",children:[e.jsx("a",{href:`https://www.wunderground.com/weather/${r.linkWU}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex rounded-lg p-2 text-slate-400 transition-colors hover:bg-indigo-50 hover:text-indigo-600",title:"View on Weather Underground","data-testid":"view-wu-link",children:e.jsx(it,{size:16})}),e.jsx("a",{href:`https://www.google.com/maps/search/?api=1&query=${r.coords[0]},${r.coords[1]}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex rounded-lg p-2 text-slate-400 transition-colors hover:bg-indigo-50 hover:text-indigo-600",title:"View on Google Maps","data-testid":"view-map-link",children:e.jsx(Ze,{size:16})}),e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>g(r),className:"text-slate-400 hover:bg-indigo-50 hover:text-indigo-600",title:"Edit location","data-testid":`edit-place-${r.id}`,children:e.jsx(fe,{size:16})}),e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>r.id&&f(r.id),className:"text-slate-400 hover:bg-red-50 hover:text-red-600",title:"Delete location","data-testid":`delete-place-${r.id}`,children:e.jsx(_e,{size:16})}),e.jsx("div",{className:"cursor-grab touch-none p-2 text-slate-300 transition-colors hover:text-indigo-600 active:cursor-grabbing",title:"Hold to drag","data-testid":`drag-handle-${r.id}`,onMouseDown:()=>k(r.id||null),onMouseUp:()=>k(null),onTouchStart:()=>k(r.id||null),onTouchEnd:()=>k(null),onTouchCancel:()=>k(null),onClick:l=>l.stopPropagation(),children:e.jsx(Le,{size:18})})]})})]},r.id))]},d))})]})})},Rt=({places:t,groups:a,userMembership:s,userRole:n,userId:c,onAddGroup:p,onUpdateGroup:x,onDeleteGroup:S,onReorderGroups:T,onAddPlace:g,onUpdatePlace:f,onDeletePlace:j,onReorderPlaces:i,onSearchPlace:w,onExportPlaces:b,onImportPlaces:k})=>{const{successToast:P,errorToast:d,warningToast:m}=Ve(),[r,l]=React.useState(!1),[R,H]=React.useState(!1),[N,G]=React.useState(!1),[V,te]=React.useState(null),[ae,K]=React.useState(!1),X=React.useRef(null),[O,le]=React.useState(null),[ge,de]=React.useState(null),[J,ce]=React.useState(null),[we,ue]=React.useState(null),o=React.useMemo(()=>t.filter(h=>h.user_id===c),[t,c]),u=n==="admin"?t:o,[I,Z]=React.useState(u);React.useEffect(()=>{O===null&&Z(u)},[u,O]);const F=ke[s]||ke.free,Q=o.length>=F.locations,se=React.useMemo(()=>a||[],[a]),ne=React.useMemo(()=>se.filter(h=>h.user_id===c),[se,c]),De=ne.length>=F.groups,[ee,ye]=React.useState(ne);React.useEffect(()=>{J===null&&ye(ne)},[ne,J]);const me=()=>{te(null),l(!1),H(!1),G(!1)},Te=h=>{te(h),l(!1)},Ae=async h=>{try{await p({name:h}),P("Group added successfully")}catch(L){d(`Failed to add group: ${L}`)}},Pe=async(h,L)=>{try{await x(h,{name:L}),P("Group updated successfully")}catch(y){d(`Failed to update group: ${y}`)}},Ee=async h=>{try{await S(h),P("Group deleted successfully")}catch(L){d(`Failed to delete group: ${L}`)}},ze=async()=>{try{const h=await b(),L=jsyaml.dump(h),y=new Blob([L],{type:"text/yaml"}),v=URL.createObjectURL(y),C=document.createElement("a");C.href=v,C.download=`weather-places-${new Date().toISOString().split("T")[0]}.yml`,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(v)}catch(h){d(`Failed to export YAML: ${h}`)}},Ue=async h=>{const L=h.target.files?.[0];if(!L)return;K(!0);const y=new FileReader;y.onload=async v=>{try{const C=v.target?.result,U=jsyaml.load(C);let A=U;if(Array.isArray(U))A={places:[{name:null,items:U}]};else if(!(U&&U.places&&Array.isArray(U.places)))throw new Error("Invalid YAML format");await k(A),P("Locations imported successfully.")}catch(C){d(`Failed to import YAML: ${C}`)}finally{K(!1),X.current&&(X.current.value="")}},y.readAsText(L)},$e=async(h,L)=>{let y=h.coords,v=h.name,C=h.country;const U=L.trim();if(U===""||U==="0, 0"||U==="0,0"){if(h.linkWU){G(!0);try{const $=await w(h.linkWU);y=[$.lat,$.lon],v=h.name||$.city||"",C=h.country||$.countryCode||""}catch($){d(`Failed to fetch coordinates: ${$}`),G(!1);return}finally{G(!1)}}}else{const $=U.split(/[, ]+/);if($.length>=2){const be=parseFloat($[0]),je=parseFloat($[1]);!isNaN(be)&&!isNaN(je)&&(y=[be,je])}}const A={...h,name:v,country:C,coords:y};if(o.some($=>$.name.toLowerCase()===v.toLowerCase()&&$.id!==(V?.id||null))){m(`A location with the name "${v}" already exists in your list.`);return}try{V?.id?await f(V.id,A):await g(A),me()}catch($){d(`Failed to save location: ${$}`)}},Me=h=>{le(h)},Ge=(h,L)=>{if(h.preventDefault(),O===null||O===L)return;const y=I.findIndex(A=>A.id===O),v=I.findIndex(A=>A.id===L);if(y===-1||v===-1)return;const C=[...I],[U]=C.splice(y,1);C.splice(v,0,U),C.map(A=>A.id).join(",")!==I.map(A=>A.id).join(",")&&Z(C)},Oe=()=>{if(O!==null){const h=u.map(y=>y.id).join(","),L=I.map(y=>y.id).join(",");if(h!==L){const y=I.map(v=>v.id).filter(v=>v!==void 0);i(y).catch(v=>console.error("Failed to reorder",v))}}le(null),de(null)},Fe=h=>{ce(h)},We=(h,L)=>{if(h.preventDefault(),J===null||J===L)return;const y=ee.findIndex(A=>A.id===J),v=ee.findIndex(A=>A.id===L);if(y===-1||v===-1)return;const C=[...ee],[U]=C.splice(y,1);C.splice(v,0,U),C.map(A=>A.id).join(",")!==ee.map(A=>A.id).join(",")&&ye(C)},He=()=>{if(J!==null){const h=ne.map(y=>y.id).join(","),L=ee.map(y=>y.id).join(",");if(h!==L){const y=ee.map(v=>v.id).filter(v=>v!==void 0);T(y).catch(v=>console.error("Failed to reorder groups",v))}}ce(null),ue(null)},qe=async(h,L)=>{if(h.preventDefault(),O===null)return;const y=I.find(C=>C.id===O);if(!y)return;const v=L==="---"?null:se.find(C=>C.name===L)?.id||null;if(y.group_id!==v)try{await f(O,{...y,group_id:v}),P(`Moved ${y.name} to ${L==="---"?"Standalone":L}`)}catch(C){d(`Failed to move item: ${C}`)}};return e.jsxs("div",{className:"mx-auto max-w-4xl py-4 md:px-4","data-testid":"management-view",children:[e.jsx("input",{type:"file",accept:".yml,.yaml",className:"hidden",ref:X,onChange:Ue,disabled:ae}),e.jsx(vt,{isImporting:ae,onImportClick:()=>X.current?.click(),onExportYAML:ze}),(r||V)&&e.jsx(St,{editingPlace:V,groups:se,userId:c,userRole:n,isSearching:R,isAutoFetching:N,onSearchPlace:w,onSubmit:$e,onCancel:me}),e.jsx(kt,{places:t,orderedPlaces:I,groups:se,userPlaces:o,limits:F,isAtLimit:Q,draggedId:O,canDragId:ge,onAddClick:()=>{me(),l(!0)},onEdit:Te,onDelete:j,onDragStart:Me,onDragOver:Ge,onDragEnd:Oe,onDropOnGroup:qe,setCanDragId:de}),e.jsx(jt,{groups:se,userId:c,userGroups:ne,orderedGroups:ee,limits:F,isAtGroupLimit:De,draggedGroupId:J,canDragGroupId:we,onAddGroup:Ae,onUpdateGroup:Pe,onDeleteGroup:Ee,onDragStart:Fe,onDragOver:We,onDragEnd:He,setCanDragGroupId:ue})]})},_={Temperature:"#ef4444",Precipitation:"#3b82f6",PrecipChance:"#0ea5e9",WindGust:"#8b5cf6",UV:"#f59e0b",CloudCover:"#94a3b8",Humidity:"#10b981",Snow:"#d946ef"};function Ct(){Chart.Chart.register(Chart.CategoryScale,Chart.LinearScale,Chart.PointElement,Chart.LineElement,Chart.BarElement,Chart.Title,Chart.Tooltip,Chart.Legend,Chart.Filler)}function Ie(t){const a=new Date;if(!t||t==="Local")return a;let s=0;if(t!=="Z"){const c=t.startsWith("-")?-1:1,p=parseInt(t.slice(1,3)),x=parseInt(t.slice(3,5))||0;s=c*(p*36e5+x*6e4)}const n=a.getTime()+a.getTimezoneOffset()*6e4;return new Date(n+s)}const _t={id:"nowLine",afterDatasetsDraw:t=>{const{ctx:a,chartArea:{top:s,bottom:n},scales:{x:c}}=t;if(!c)return;const p=t.options.plugins?.nowLine?.tzOffset,x=Ie(p),S=t.data.labels;let T=-1,g=1/0;if(S.forEach((f,j)=>{const i=new Date(f),w=Math.abs(i.getTime()-x.getTime());w<g&&(g=w,T=j)}),T!==-1&&g<24*36e5){const f=c.getPixelForValue(S[T]);a.save(),a.beginPath(),a.lineWidth=2,a.strokeStyle="#0d9488",a.moveTo(f,s),a.lineTo(f,n),a.stroke(),a.fillStyle="#0d9488",a.font="bold 13px sans-serif",a.textAlign="left";const j=x.getHours().toString().padStart(2,"0"),i=x.getMinutes().toString().padStart(2,"0"),w=`${j}:${i}`,b=a.measureText(w);a.fillStyle="rgba(13, 148, 136, 0.9)",a.fillRect(f,s+10,b.width+16,24),a.fillStyle="#ffffff",a.fillText(w,f+8,s+27),a.restore()}}},Lt=()=>({type:"category",grid:{color:t=>{const a=t.chart.data.labels[t.index];return new Date(a).getHours()===0?"#0f172a":"transparent"},lineWidth:t=>{const a=t.chart.data.labels[t.index];return new Date(a).getHours()===0?2:0},drawTicks:!0},ticks:{maxRotation:0,autoSkip:!1,padding:10,color:"#334155",font:{weight:"bold",size:14},callback:function(t){const a=this.getLabelForValue(t),s=new Date(a);return isNaN(s.getTime())?"":s.getHours()===12?s.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}):""}}});Ct();const It=({place:t,zoomLevel:a})=>{const[s,n]=React.useState(null),[c,p]=React.useState(!0),x=React.useRef(null),S=React.useRef(null);if(React.useEffect(()=>{p(!0),Promise.all([E.fetchWUForecast(t),E.fetchWUHistory(t)]).then(([l,R])=>{n({forecast:l,history:R}),p(!1)})},[t]),React.useEffect(()=>{if(!c&&s&&x.current){const l=setTimeout(()=>{const R=S.current,H=x.current;if(R&&H){const N=Ie(s.forecast.tzOffset),G=R.data.labels;let V=-1,te=1/0;if(G.forEach((ae,K)=>{const X=new Date(ae),O=Math.abs(X.getTime()-N.getTime());O<te&&(te=O,V=K)}),V!==-1){const K=R.scales.x.getPixelForValue(G[V])-H.offsetWidth/2;H.scrollTo({left:Math.max(0,K),behavior:"smooth"})}}},500);return()=>clearTimeout(l)}},[c,s,a]),c||!s)return e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx("div",{className:"animate-pulse text-slate-400",children:"Loading forecast data..."})});const T=1440*60*1e3,g=[...s.history.x.slice().reverse(),...s.forecast.x].map(l=>l.toISOString()),f=s.history.x.length,j=s.history.sunriseTimeLocal?new Date(s.history.sunriseTimeLocal.slice(0,19)):null,i=s.history.sunsetTimeLocal?new Date(s.history.sunsetTimeLocal.slice(0,19)):null;let w=0,b=null;if(j&&i){const l=i.getTime()-j.getTime();w=l/T*100,b=new Date(j.getTime()+l/2)}const k=s.forecast.y_temperature.slice(0,24).filter(l=>l!==null),P=k.length>0?Math.min(...k):null,d=k.length>0?Math.max(...k):null,m={labels:g,datasets:[{label:"Temperature (°C)",data:[...s.history.y_temperature.slice().reverse(),...s.forecast.y_temperature],borderColor:_.Temperature,backgroundColor:_.Temperature+"20",yAxisID:"y_temp",tension:D.TENSION,pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,borderWidth:D.LINE_WIDTH_DEFAULT},{label:"Rain Probability (%)",data:[...Array(f).fill(null),...s.forecast.y_precipChance],borderColor:_.PrecipChance,backgroundColor:_.PrecipChance+"20",yAxisID:"y_perc",tension:D.TENSION,pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,borderWidth:D.LINE_WIDTH_DEFAULT},{label:"Rain (mm/h)",data:[...Array(f).fill(null),...s.forecast.y_precipitation],borderColor:_.Precipitation,backgroundColor:_.Precipitation+"40",yAxisID:"y_rain",fill:!0,pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,borderWidth:D.LINE_WIDTH_FILLED_AREA},{label:"Wind Gust (km/h)",data:[...s.history.y_windGust.slice().reverse(),...s.forecast.y_windGust],borderColor:_.WindGust,yAxisID:"y_wind",pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,borderDash:[5,5],borderWidth:D.LINE_WIDTH_DEFAULT},{label:"Cloud Cover (%)",data:[...s.history.y_cloudCover.slice().reverse(),...s.forecast.y_cloudCover],borderColor:_.CloudCover,yAxisID:"y_cloud",pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,fill:!1,borderWidth:D.LINE_WIDTH_DEFAULT},{label:"UV Index",data:[...s.history.y_uvIndex.slice().reverse(),...s.forecast.y_uvIndex],borderColor:_.UV,yAxisID:"y_uv",pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,fill:!1,borderWidth:D.LINE_WIDTH_DEFAULT},{label:"Humidity (%)",data:[...s.history.y_humidity.slice().reverse(),...s.forecast.y_humidity],borderColor:_.Humidity,yAxisID:"y_humidity",pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,fill:!1,borderWidth:D.LINE_WIDTH_DEFAULT},{label:"Snow (cm/h)",data:[...s.history.y_snow.slice().reverse(),...s.forecast.y_snow],borderColor:_.Snow,backgroundColor:_.Snow+"30",yAxisID:"y_snow",fill:"origin",pointRadius:D.POINT_RADIUS,pointHitRadius:D.HIT_RADIUS,borderWidth:D.LINE_WIDTH_FILLED_AREA}]},r={responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!0},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0,font:{size:11}}},tooltip:{filter:l=>{const R=l.dataset.yAxisID,H=l.raw;return R==="y_temp"?!0:["y_perc","y_rain","y_uv","y_snow"].includes(R)?H!==0&&H!==null:!1},callbacks:{title:l=>new Date(l[0].label).toLocaleString("en-GB",{weekday:"short",day:"numeric",month:"short",hour:"2-digit",minute:"2-digit",hour12:!1})}},nowLine:{tzOffset:s.forecast.tzOffset}},scales:{x:Lt(),y_temp:{type:"linear",display:!0,position:"left",grid:{color:"rgba(239, 68, 68, 0.15)",drawOnChartArea:!0},ticks:{color:_.Temperature,font:{size:10,weight:"bold"},stepSize:5,precision:0},title:{display:!0,text:"Temperature °C",color:_.Temperature,font:{size:12,weight:"bold"}},beginAtZero:!1,afterDataLimits:l=>{l.min=Math.floor(l.min/5)*5,l.max=Math.ceil(l.max/5)*5}},y_perc:{type:"linear",display:!0,position:"left",min:0,max:100,grid:{drawOnChartArea:!1},ticks:{color:_.PrecipChance,font:{size:10,weight:"bold"},stepSize:100},title:{display:!0,text:"Rain %",color:_.PrecipChance,font:{size:12,weight:"bold"}}},y_rain:{type:"linear",display:!0,position:"left",min:0,suggestedMax:1,grid:{color:"rgba(59, 130, 246, 0.1)",drawOnChartArea:!0},ticks:{color:_.Precipitation,font:{size:10,weight:"bold"},stepSize:1},title:{display:!0,text:"Rain mm/h",color:_.Precipitation,font:{size:12,weight:"bold"}},afterDataLimits:l=>{l.max=Math.ceil(Math.max(l.max,1))}},y_snow:{type:"linear",display:!0,position:"left",min:0,suggestedMax:1,grid:{drawOnChartArea:!1},ticks:{color:_.Snow,font:{size:10,weight:"bold"},stepSize:1},title:{display:!0,text:"Snow cm/h",color:_.Snow,font:{size:12,weight:"bold"}},afterDataLimits:l=>{l.max=Math.ceil(Math.max(l.max,1))}},y_wind:{type:"linear",display:!0,position:"left",min:0,grid:{drawOnChartArea:!1},ticks:{color:_.WindGust,font:{size:10,weight:"bold"},stepSize:25},title:{display:!0,text:"Wind Gust km/h",color:_.WindGust,font:{size:12,weight:"bold"}}},y_cloud:{type:"linear",display:!0,position:"left",min:0,max:100,grid:{drawOnChartArea:!1},ticks:{color:_.CloudCover,font:{size:10,weight:"bold"},stepSize:100},title:{display:!0,text:"Cloud Coverage %",color:_.CloudCover,font:{size:12,weight:"bold"}}},y_uv:{type:"linear",display:!0,position:"left",min:0,max:12,grid:{drawOnChartArea:!1},ticks:{color:_.UV,font:{size:10,weight:"bold"},stepSize:12},title:{display:!0,text:"UV",color:_.UV,font:{size:12,weight:"bold"}}},y_humidity:{type:"linear",display:!0,position:"left",min:0,max:100,grid:{drawOnChartArea:!1},ticks:{color:_.Humidity,font:{size:10,weight:"bold"},stepSize:100},title:{display:!0,text:"Humidity %",color:_.Humidity,font:{size:12,weight:"bold"}}}}};return e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 px-4 md:grid-cols-3",children:[e.jsx(oe,{icon:e.jsx(Ne,{className:"text-red-500"}),label:"TEMP / UV index",value:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-red-500",children:[s.forecast.y_temperature[0],"°C"]}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsxs("span",{className:"text-amber-500",children:["UV ",s.forecast.y_uvIndex[0]]})]})}),e.jsx(oe,{icon:e.jsx(Ne,{className:"text-slate-500"}),label:"Min / Max",value:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-blue-500",children:[P,"°"]}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsxs("span",{className:"text-red-500",children:[d,"°"]})]})}),e.jsx(oe,{icon:e.jsx(ve,{className:"text-sky-500"}),label:"Rain / Precip",value:e.jsxs("div",{className:"flex gap-2 text-sm md:text-base",children:[e.jsxs("span",{className:"text-sky-500",children:[s.forecast.y_precipChance[0],"%"]}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsxs("span",{className:"text-blue-500",children:[s.forecast.y_precipitation[0]," mm/h"]})]})}),e.jsx(oe,{icon:e.jsx(ve,{className:"text-emerald-500"}),label:"Humidity / Cloud",value:e.jsxs("div",{className:"flex gap-2 text-sm md:text-base",children:[e.jsxs("span",{className:"text-emerald-500",children:[s.forecast.y_humidity[0],"%"]}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsxs("span",{className:"text-slate-400",children:[s.forecast.y_cloudCover[0],"%"]})]})}),e.jsx(oe,{icon:e.jsx(ht,{className:"text-slate-500"}),label:"Sun rise / Set",value:e.jsxs("div",{className:"flex gap-2 text-sm md:text-base",children:[e.jsx("span",{className:"text-slate-900",children:j?j.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):"N/A"}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsx("span",{className:"text-slate-900",children:i?i.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):"N/A"})]})}),e.jsx(oe,{icon:e.jsx(nt,{className:"text-slate-500"}),label:"Noon / Daylight %",value:e.jsxs("div",{className:"flex gap-2 text-sm md:text-base",children:[e.jsx("span",{className:"text-slate-900",children:b?b.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):"N/A"}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsx("span",{className:"text-slate-900",children:w>0?`${w.toFixed(1)}%`:"N/A"})]})})]}),e.jsx("div",{ref:x,className:"custom-scrollbar h-[400px] w-full overflow-x-auto",children:e.jsx("div",{className:"h-full",style:{width:bt[a]},children:e.jsx(at,{ref:S,data:m,options:r,plugins:[_t]})})})]})},oe=({icon:t,label:a,value:s})=>e.jsxs("div",{className:"flex items-center gap-2 rounded-xl bg-slate-50 p-2 md:p-3",children:[e.jsx("div",{className:"flex-shrink-0",children:t}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-[10px] font-semibold tracking-wider text-slate-500 md:text-xs",children:a}),e.jsx("div",{className:"truncate text-base font-bold md:text-lg",children:s})]})]}),Re=[{value:"z1x",label:"1x"},{value:"z2x",label:"2x"},{value:"z3x",label:"3x"},{value:"z4x",label:"4x"}],Dt=({currentZoom:t,onSelect:a})=>{const[s,n]=React.useState(!1),c=React.useRef(null);React.useEffect(()=>{const x=S=>{c.current&&!c.current.contains(S.target)&&n(!1)};return s&&document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[s]);const p=Re.find(x=>x.value===t)?.label||t;return e.jsxs("div",{className:"relative inline-block",ref:c,"data-testid":"zoom-dropdown",children:[e.jsxs("button",{type:"button",onClick:()=>n(!s),className:"flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition-all hover:bg-slate-50 focus:outline-none",children:[e.jsx(ft,{className:"size-4 text-indigo-500"}),e.jsxs("span",{children:["Zoom: ",p]}),e.jsx(pe,{className:`size-3 text-slate-400 transition-transform duration-200 ${s?"rotate-180":""}`})]}),s&&e.jsx("ul",{className:"animate-in fade-in zoom-in absolute right-0 z-20 mt-2 w-40 overflow-hidden rounded-xl border border-slate-200 bg-white p-1 shadow-xl duration-200",children:Re.map(x=>e.jsx("li",{children:e.jsx("button",{type:"button",onClick:()=>{a(x.value),n(!1)},className:`flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm transition-colors ${t===x.value?"bg-indigo-50 font-bold text-indigo-700":"text-slate-600 hover:bg-slate-50"}`,children:e.jsx("span",{children:x.label})})},x.value))})]})},Tt=({selectedPlace:t,zoomLevel:a,onZoomChange:s})=>e.jsx("div",{className:"mx-auto max-w-7xl md:px-4 md:py-8","data-testid":"public-view",children:t&&e.jsxs("div",{className:"space-y-8","data-testid":"weather-details",children:[e.jsxs("div",{className:"rounded-b-2xl border bg-white py-4 shadow-sm md:rounded-2xl md:p-6","data-testid":"weather-charts-container",children:[e.jsx(It,{place:t,zoomLevel:a}),e.jsx("div",{className:"mt-8 flex justify-center","data-testid":"zoom-dropdown-container",children:e.jsx(Dt,{currentZoom:a,onSelect:s})})]}),e.jsx("section",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:e.jsxs("div",{className:"rounded-2xl border bg-white p-4 shadow-sm md:p-6","data-testid":"external-links-container",children:[e.jsxs("h3",{className:"mb-4 flex items-center gap-2 text-lg font-bold",children:[e.jsx(ut,{className:"size-5 text-amber-500"})," External Links"]}),e.jsxs("ul",{className:"space-y-2",children:[e.jsx("li",{children:e.jsx("a",{href:`https://www.wunderground.com/forecast/${t.linkWU}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-indigo-600 hover:underline","data-testid":"wu-link",children:"Weather Underground Forecast"})}),e.jsx("li",{children:e.jsx("a",{href:`https://www.lightningmaps.org/?lang=en#m=oss;y=${t.coords[0]};x=${t.coords[1]};z=13`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-indigo-600 hover:underline","data-testid":"lightning-maps-link",children:"Lightning Maps"})})]})]})})]})}),At=()=>e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center","data-testid":"weather-loading-spinner",children:e.jsx("div",{className:"h-12 w-12 animate-spin rounded-full border-b-2 border-indigo-500"})}),Pt=()=>{const t=gt(),a=()=>t.loading?e.jsx(At,{}):t.showLogin?e.jsx(yt,{onLogin:t.login,onRegister:t.register,onCancel:t.navigateToPublic}):t.user&&t.showEdit?e.jsx(Rt,{places:t.places,groups:t.groups,userMembership:t.user.membership,userRole:t.user.role,userId:t.user.id,onAddGroup:t.handleAddGroup,onUpdateGroup:t.handleUpdateGroup,onDeleteGroup:t.handleDeleteGroup,onReorderGroups:t.handleReorderGroups,onAddPlace:t.handleAddPlace,onUpdatePlace:t.handleUpdatePlace,onDeletePlace:t.handleDeletePlace,onReorderPlaces:t.handleReorderPlaces,onSearchPlace:t.handleSearchPlace,onExportPlaces:t.handleExportPlaces,onImportPlaces:t.handleImportPlaces}):e.jsx(Tt,{selectedPlace:t.selectedPlace,zoomLevel:t.zoomLevel,onZoomChange:t.setZoomLevel});return e.jsxs("div",{className:"min-h-screen bg-slate-50 pb-12 font-sans text-slate-900","data-testid":"weather-page",children:[e.jsx(wt,{isAdmin:!!t.user,userEmail:t.user?.email,userFirstName:t.user?.first_name,userRole:t.user?.role,userMembership:t.user?.membership,onLoginClick:t.navigateToLogin,onLogoutClick:()=>t.logout(),onLogoClick:t.user?t.navigateToEdit:t.navigateToPublic,showLoginButton:!t.user&&!t.showLogin,places:t.places,selectedPlace:t.selectedPlace,onPlaceChange:t.handlePlaceChange}),e.jsx("main",{"data-testid":"weather-main-content",children:a()})]})};ReactDOM.createRoot(document.getElementById("root")).render(e.jsx(React.StrictMode,{children:e.jsx(Be,{children:e.jsx(Pt,{})})}));
