import"./index-Cm_Ydr0l.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{P as Ne,A as Xe}from"./Auth-uEj7rJlD.js";import{A as Me}from"./api-CH_Pe6Vg.js";import{D as Ye,U as Qe}from"./upload--Rbr-3Yq.js";import{C as $e}from"./chevron-down-3_LVzg6l.js";import{P as Ie}from"./pencil-DHu_drsE.js";import{G as Ge}from"./grip-vertical-BjGCJcsX.js";import{E as De}from"./external-link-Bw0ICscN.js";import{M as be}from"./map-BMvedaBo.js";import{T as Se}from"./trash-2-DQbJ9aIh.js";import{S as et}from"./search-Cfl0sis-.js";import{f as tt,b as st,e as at,g as rt,u as Ce,T as ve,M as ot,a as nt,P as lt}from"./TileLayer-KcMz5fwj.js";import{L as me}from"./LayersControl-bsTFKbeJ.js";import{u as it,T as ct}from"./Toast-COaeoAQl.js";import{X as dt}from"./x-BS-d4QNZ.js";import{C as ut}from"./copy-CzC7y2Qs.js";import{c as mt}from"./createLucideIcon-DtX1aPOG.js";import{S as pt}from"./settings-G074OJw9.js";import{L as gt}from"./log-out-B0TqtotO.js";import{L as ht}from"./list-BhDG0LsZ.js";/* empty css                */import"./button-D6DGr86I.js";import"./clsx-B-dksMZM.js";import"./eye-Jn_UhOO1.js";import"./circle-check-F4iM422t.js";const xt=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],ft=mt("share-2",xt),bt=tt(function({children:r,...o},d){const u=new L.LayerGroup([],o);return st(u,at(d,{layerContainer:u}))}),wt=rt(function(r){return new L.Control.Zoom(r)}),j=`${Me}/maps`,k=()=>{const t=localStorage.getItem("map_token")||sessionStorage.getItem("map_token");return{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}}},f={login:async(t,r,o=!0)=>{const d=await fetch(`${j}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:t,password:r,remember:o})});if(!d.ok){const c=await d.json().catch(()=>({detail:"Login failed"}));throw new Error(c.detail||"Login failed")}const u=await d.json();return o?localStorage.setItem("map_token",u.access_token):sessionStorage.setItem("map_token",u.access_token),u},getMe:async()=>{const t=await fetch(`${j}/auth/me`,{headers:k(),credentials:"include"});if(!t.ok)throw new Error("Not authenticated");return t.json()},getLists:async()=>{const t=await fetch(`${j}/lists`,{headers:k(),credentials:"include"});if(!t.ok)throw new Error("Failed to fetch lists");return t.json()},createList:async t=>{const r=await fetch(`${j}/lists`,{method:"POST",headers:k(),credentials:"include",body:JSON.stringify({name:t})});if(!r.ok)throw new Error("Failed to create list");return r.json()},reorderLists:async t=>{const r=await fetch(`${j}/lists/reorder`,{method:"POST",headers:k(),credentials:"include",body:JSON.stringify(t)});if(!r.ok)throw new Error("Failed to reorder lists");return r.json()},deleteList:async t=>{const r=await fetch(`${j}/lists/${t}`,{method:"DELETE",headers:k(),credentials:"include"});if(!r.ok)throw new Error("Failed to delete list");return r.json()},getGroups:async t=>{const r=t?`${j}/groups?list_id=${t}`:`${j}/groups`,o=await fetch(r,{headers:k(),credentials:"include"});if(!o.ok)throw new Error("Failed to fetch groups");return o.json()},createGroup:async(t,r,o,d)=>{const u=await fetch(`${j}/groups`,{method:"POST",headers:k(),credentials:"include",body:JSON.stringify({name:t,color:r,list_id:o,note:d})});if(!u.ok)throw new Error("Failed to create group");return u.json()},updateGroup:async(t,r)=>{const o=await fetch(`${j}/groups/${t}`,{method:"PUT",headers:k(),credentials:"include",body:JSON.stringify(r)});if(!o.ok)throw new Error("Failed to update group");return o.json()},deleteGroup:async t=>{const r=await fetch(`${j}/groups/${t}`,{method:"DELETE",headers:k(),credentials:"include"});if(!r.ok)throw new Error("Failed to delete group");return r.json()},getItems:async t=>{const r=t?`${j}/items?list_id=${t}`:`${j}/items`,o=await fetch(r,{headers:k(),credentials:"include"});if(!o.ok)throw new Error("Failed to fetch items");return o.json()},createItem:async(t,r,o,d,u,c,g,S,m)=>{const b=await fetch(`${j}/items`,{method:"POST",headers:k(),credentials:"include",body:JSON.stringify({group_id:t,name:r,latitude:o,longitude:d,note:u,url_google:c,url_item:g,exclude_initial_map:S,visited:m})});if(!b.ok)throw new Error("Failed to create item");return b.json()},updateItem:async(t,r)=>{const o=await fetch(`${j}/items/${t}`,{method:"PUT",headers:k(),credentials:"include",body:JSON.stringify(r)});if(!o.ok)throw new Error("Failed to update item");return o.json()},deleteItem:async t=>{const r=await fetch(`${j}/items/${t}`,{method:"DELETE",headers:k(),credentials:"include"});if(!r.ok)throw new Error("Failed to delete item");return r.json()},reorderGroups:async t=>{const r=await fetch(`${j}/groups/reorder`,{method:"POST",headers:k(),credentials:"include",body:JSON.stringify(t)});if(!r.ok)throw new Error("Failed to reorder groups");return r.json()},reorderItems:async t=>{const r=await fetch(`${j}/items/reorder`,{method:"POST",headers:k(),credentials:"include",body:JSON.stringify(t)});if(!r.ok)throw new Error("Failed to reorder items");return r.json()},exportData:async()=>{const t=await fetch(`${j}/export`,{headers:k(),credentials:"include"});if(!t.ok)throw new Error("Export failed");const r=await t.blob(),o=window.URL.createObjectURL(r),d=document.createElement("a");d.href=o,d.download="map_data.yaml",d.click(),window.URL.revokeObjectURL(o)},importData:async t=>{const r=await fetch(`${j}/import`,{method:"POST",headers:{...k(),"Content-Type":"text/plain"},credentials:"include",body:t});if(!r.ok){const o=await r.json().catch(()=>({detail:"Import failed"}));throw new Error(o.detail||"Import failed")}return r.json()},logout:async()=>{try{await fetch(`${Me}/bookmarks/logout`,{method:"POST",credentials:"include"})}catch(t){console.error("Logout API call failed",t)}localStorage.removeItem("map_token"),sessionStorage.removeItem("map_token")},getSharedData:async t=>{const r=await fetch(`${j}/shared/${t}`);if(!r.ok)throw new Error("Failed to fetch shared list");return r.json()}},Oe=React.createContext(void 0),yt=({children:t})=>{const[r,o]=React.useState(null),[d,u]=React.useState([]),[c,g]=React.useState(null),[S,m]=React.useState([]),[b,l]=React.useState([]),[C,p]=React.useState(null),[G,J]=React.useState(!1),[q,D]=React.useState(!1),[_,R]=React.useState(null),[v,H]=React.useState(!0),[W,F]=React.useState(!1),[O,K]=React.useState(null),[ee,P]=React.useState(null),[pe,X]=React.useState("map"),A=(n,h,x)=>{x?localStorage.setItem("map_token",n):sessionStorage.setItem("map_token",n),o(h),w()},V=(n,h=!0)=>{p(n),J(h)},Y=n=>{W||(g(n),m([]),l([]),n?localStorage.setItem("map_current_list_id",String(n.id)):localStorage.removeItem("map_current_list_id"))},w=async()=>{if(W&&O){try{const n=await f.getSharedData(O);u([n.list]),g(n.list),m(n.groups),l(n.items)}catch(n){console.error(n),P("Failed to load shared list")}return}try{const n=await f.getLists();u(n);let h=c;if(!h&&n.length>0){const x=localStorage.getItem("map_current_list_id");x?h=n.find(y=>y.id===Number(x))||n[0]:h=n[0],g(h)}if(h){const[x,y]=await Promise.all([f.getGroups(h.id),f.getItems(h.id)]);m(x),l(y)}else m([]),l([])}catch(n){console.error(n)}};React.useEffect(()=>{w()},[c?.id,W,O]),React.useEffect(()=>{(async()=>{const x=new URLSearchParams(window.location.search).get("share_token");if(x){F(!0),K(x),H(!1);return}const y=localStorage.getItem("map_token")||sessionStorage.getItem("map_token");try{const T=await f.getMe();o(T)}catch{y&&(localStorage.removeItem("map_token"),sessionStorage.removeItem("map_token"))}H(!1)})()},[]);const ge=async(n,h)=>{P(null);try{await f.login(n,h);const x=await f.getMe();o(x),await w()}catch(x){throw P(x.message||"Login failed"),x}},te=async()=>{await f.logout(),o(null),u([]),g(null),m([]),l([])},se=async n=>{await f.createList(n),await w()},ae=async n=>{await f.reorderLists(n),await w()},he=async n=>{await f.deleteList(n),c?.id===n&&(g(null),localStorage.removeItem("map_current_list_id")),await w()},re=async(n,h,x)=>{const y=await f.createGroup(n,h,c?.id||void 0,x);return await w(),y},oe=async(n,h)=>{await f.updateGroup(n,h),await w()},ne=async n=>{await f.deleteGroup(n),await w()},le=async(n,h,x,y,T,U,fe,we,ue)=>{const z=await f.createItem(n,h,x,y,T,U,fe,we,ue);return await w(),z},ie=async(n,h)=>{await f.updateItem(n,h),await w()},ce=async n=>{await f.deleteItem(n),await w()},B=async n=>{await f.reorderGroups(n),await w()},de=async n=>{await f.reorderItems(n),await w()},xe=async()=>{await f.exportData()},M=async n=>{await f.importData(n),await w()};return React.useEffect(()=>{(async()=>{const h=localStorage.getItem("map_token")||sessionStorage.getItem("map_token");try{const x=await f.getMe();o(x)}catch{h&&(localStorage.removeItem("map_token"),sessionStorage.removeItem("map_token"))}H(!1)})()},[]),e.jsx(Oe.Provider,{value:{user:r,lists:d,currentList:c,setCurrentList:Y,groups:S,items:b,selectedItem:C,setSelectedItem:V,shouldFocusItem:G,showAddItem:q,setShowAddItem:D,editingItem:_,setEditingItem:R,isLoading:v,isReadOnly:W,shareToken:O,error:ee,login:ge,logout:te,refreshData:w,createList:se,reorderLists:ae,deleteList:he,createGroup:re,updateGroup:oe,deleteGroup:ne,createItem:le,updateItem:ie,deleteItem:ce,reorderGroups:B,reorderItems:de,exportData:xe,importData:M,mobileView:pe,setMobileView:X,handleAuthSuccess:A},children:t})},Z=()=>{const t=React.useContext(Oe);if(t===void 0)throw new Error("useMap must be used within a MapProvider");return t},Pe={"red-500":"#ef4444","orange-500":"#f97316","amber-500":"#f59e0b","yellow-500":"#eab308","lime-500":"#84cc16","green-500":"#22c55e","emerald-500":"#10b981","teal-500":"#14b8a6","cyan-500":"#06b6d4","sky-500":"#0ea5e9","blue-500":"#3b82f6","indigo-500":"#6366f1","violet-500":"#8b5cf6","purple-500":"#a855f7","fuchsia-500":"#d946ef","pink-500":"#ec4899","rose-500":"#f43f5e","slate-500":"#64748b","gray-500":"#6b7280","zinc-500":"#71717a","neutral-500":"#737373","stone-500":"#78716c","red-600":"#dc2626","orange-600":"#ea580c","amber-600":"#d97706","yellow-600":"#ca8a04","lime-600":"#65a30d","green-600":"#16a34a","emerald-600":"#059669","teal-600":"#0d9488","cyan-600":"#0891b2","sky-600":"#0284c7","blue-600":"#2563eb","indigo-600":"#4f46e5","violet-600":"#7c3aed","purple-600":"#9333ea","fuchsia-600":"#c026d3","pink-600":"#db2777","rose-600":"#e11d48","slate-600":"#475569","gray-600":"#4b5563","zinc-600":"#52525b","neutral-600":"#525252","stone-600":"#57534e","red-400":"#f87171","orange-400":"#fb923c","amber-400":"#fbbf24","yellow-400":"#facc15","lime-400":"#a3e635","green-400":"#4ade80","emerald-400":"#34d399","teal-400":"#2dd4bf","cyan-400":"#22d3ee","sky-400":"#38bdf8","blue-400":"#60a5fa","indigo-400":"#818cf8","violet-400":"#a78bfa","purple-400":"#c084fc","fuchsia-400":"#e879f9","pink-400":"#f472b6","rose-400":"#fb7185","slate-400":"#94a3b8","gray-400":"#9ca3af","zinc-400":"#a1a1aa","neutral-400":"#a3a3a3","stone-400":"#a8a29e"},Ae=t=>Pe[t]||t,jt="bg-gray-200",vt=()=>{const{groups:t,items:r,currentList:o,selectedItem:d,setSelectedItem:u,createGroup:c,updateGroup:g,deleteGroup:S,createItem:m,updateItem:b,deleteItem:l,reorderGroups:C,reorderItems:p,exportData:G,importData:J,logout:q,isReadOnly:D,showAddItem:_,setShowAddItem:R,editingItem:v,setEditingItem:H}=Z(),[W,F]=React.useState(!1),[O,K]=React.useState(""),[ee,P]=React.useState("blue-500"),[pe,X]=React.useState(""),[A,V]=React.useState(null),[Y,w]=React.useState(""),[ge,te]=React.useState(""),[se,ae]=React.useState(""),[he,re]=React.useState(""),[oe,ne]=React.useState(!1),[le,ie]=React.useState(!1),[ce,B]=React.useState(""),[de,xe]=React.useState(""),[M,n]=React.useState(null),[h,x]=React.useState(null),[y,T]=React.useState(r),[U,fe]=React.useState(null),[we,ue]=React.useState(null),[z,Le]=React.useState(t),[ye,Te]=React.useState(new Set),je=()=>{w(""),te(""),ae(""),re(""),ne(!1),ie(!1),B(""),H(null)};React.useEffect(()=>{console.log("Items in ListView:",r),T(r)},[r]),React.useEffect(()=>{Le(t)},[t]),React.useEffect(()=>{v&&(u(v),w(v.name),te(v.note||""),ae(v.url_google||""),re(v.url_item||""),ne(v.exclude_initial_map),ie(v.visited),xe(String(v.group_id)),B(v.latitude!==null&&v.latitude!==void 0?`${v.latitude}, ${v.longitude}`:""))},[v]);const Ue=s=>{const a=new Set(ye);a.has(s)?a.delete(s):a.add(s),Te(a)},ze=s=>{n(s)},Fe=(s,a)=>{if(s.preventDefault(),M===null||M===a)return;const i=y.findIndex(Q=>Q.id===M),N=y.findIndex(Q=>Q.id===a);if(i===-1||N===-1)return;const I={...y[i]},$=y[N];I.group_id!==$.group_id&&(I.group_id=$.group_id);const E=[...y];E.splice(i,1),E.splice(N,0,I),T(E)},_e=async()=>{M!==null&&(n(null),x(null),await p(y.map(s=>({id:s.id,group_id:s.group_id}))))},Ve=s=>{fe(s)},Be=(s,a)=>{if(s.preventDefault(),U===null||U===a)return;const i=z.findIndex(E=>E.id===U),N=z.findIndex(E=>E.id===a);if(i===-1||N===-1)return;const I=[...z],[$]=I.splice(i,1);I.splice(N,0,$),Le(I)},Ze=async()=>{U!==null&&(fe(null),ue(null),await C(z.map(s=>s.id)))},Je=async s=>{s.preventDefault();const a=pe.trim()||null;A?await g(A.id,{name:O,color:ee,note:a}):await c(O,ee,a),K(""),P("blue-500"),X(""),V(null),F(!1)},qe=s=>{const i=s.trim().split(/[\s,]+/);if(i.length>=2){const N=parseFloat(i[0]),I=parseFloat(i[1]);if(!isNaN(N)&&!isNaN(I))return{lat:N,lng:I}}return null},Ee=s=>{if(!s)return"";try{const a=new URL(s),i=a.hostname==="maps.google.com"||a.hostname.includes("google.com")&&a.pathname.includes("/maps"),N=a.hostname.includes("booking.com");return i||N?a.origin+a.pathname:s}catch{return s}},He=async s=>{s.preventDefault();const a=qe(ce);if(ce.trim()&&!a){alert("Invalid coordinates format. Please use 'lat, lng'.");return}let i=Number(de);if(!de){const E=t.find(Q=>Q.name.toUpperCase()==="DEFAULT");E?i=E.id:i=(await c("DEFAULT","gray-500","Default group for locations")).id}const N=ge.trim()||null,I=Ee(se.trim())||null,$=Ee(he.trim())||null;v?await b(v.id,{group_id:i,name:Y,latitude:a?.lat??null,longitude:a?.lng??null,note:N,url_google:I,url_item:$,exclude_initial_map:oe,visited:le}):await m(i,Y,a?.lat??null,a?.lng??null,N,I,$,oe,le),je(),R(!1)},We=()=>{const s=se.trim();if(!s)return;const a=s.match(/\/place\/([^/]+)/);a&&!Y.trim()&&w(decodeURIComponent(a[1].replace(/\+/g," ")));const i=s.match(/!3d(-?\d+(?:\.\d+)?)/),N=s.match(/!4d(-?\d+(?:\.\d+)?)/);if(i&&N)B(`${i[1]}, ${N[1]}`);else{const I=s.match(/@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/);I&&B(`${I[1]}, ${I[2]}`)}},Ke=async s=>{const a=s.target.files?.[0];if(a){const i=await a.text();await J(i)}};return e.jsxs("div",{className:"flex h-full flex-col overflow-y-auto bg-white p-4",children:[!D&&e.jsx("div",{className:"mb-4 border-b pb-4",children:e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{"data-testid":"add-group-button",onClick:()=>{V(null),K(""),P("blue-500"),X(""),F(!0)},className:"flex flex-col items-center justify-center gap-1 rounded-lg border border-blue-100 bg-blue-50/50 py-2 text-[10px] font-bold text-blue-700 transition-colors hover:bg-blue-50",title:"Add Group",children:[e.jsx(Ne,{size:14}),"Group"]}),e.jsxs("button",{"data-testid":"add-location-button",onClick:()=>{je(),R(!0)},className:"flex flex-col items-center justify-center gap-1 rounded-lg border border-green-100 bg-green-50/50 py-2 text-[10px] font-bold text-green-700 transition-colors hover:bg-green-50",title:"Add Location",children:[e.jsx(Ne,{size:14}),"Location"]}),e.jsxs("button",{onClick:G,className:"flex flex-col items-center justify-center gap-1 rounded-lg border border-gray-100 bg-gray-50 py-2 text-[10px] font-bold text-gray-600 transition-colors hover:bg-gray-100",title:"Export Data",children:[e.jsx(Ye,{size:14}),"Export"]}),e.jsxs("label",{className:"flex cursor-pointer flex-col items-center justify-center gap-1 rounded-lg border border-gray-100 bg-gray-50 py-2 text-[10px] font-bold text-gray-600 transition-colors hover:bg-gray-100",title:"Import Data",children:[e.jsx(Qe,{size:14}),"Import",e.jsx("input",{type:"file",className:"hidden",accept:".yaml,.yml",onChange:Ke})]})]})}),e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsx("h2",{className:"text-xl font-bold",children:"Locations"})}),e.jsxs("div",{className:"flex-1 space-y-4",children:[z.length===0&&e.jsxs("div",{className:"py-10 text-center text-gray-500",children:[e.jsx("p",{children:"No groups yet."}),e.jsx("p",{className:"text-sm",children:"Create a group to start adding locations."})]}),z.map(s=>e.jsxs("div",{"data-testid":`group-container-${s.id}`,draggable:!D&&we===s.id,onDragStart:()=>Ve(s.id),onDragOver:a=>{U!==null&&Be(a,s.id)},onDragEnd:Ze,className:`rounded-lg border border-gray-100 bg-gray-50/30 p-4 shadow-sm transition-all hover:shadow-md ${U===s.id?"opacity-30":""}`,children:[e.jsxs("div",{className:"mb-3 flex cursor-pointer items-center justify-between",onClick:()=>Ue(s.id),children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx($e,{size:18,className:`mr-2 text-gray-400 transition-transform ${ye.has(s.id)?"-rotate-90":""}`}),e.jsx("div",{className:"mr-3 h-3 w-3 rounded-full shadow-sm ring-2 ring-white",style:{backgroundColor:Ae(s.color)}}),e.jsx("h3",{className:"font-bold text-gray-800",children:s.name})]}),e.jsxs("div",{className:"ml-4 flex flex-1 items-center justify-between gap-2",children:[e.jsxs("span",{className:"rounded-full border bg-white px-2 py-0.5 text-xs font-medium text-gray-400",children:[y.filter(a=>a.group_id===s.id).length," items"]}),!D&&e.jsxs("div",{className:"flex items-center gap-1",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{onClick:a=>{a.stopPropagation(),K(s.name),P(s.color),X(s.note||""),V(s),F(!0)},className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-blue-50 hover:text-blue-500",title:"Edit Group",children:e.jsx(Ie,{size:14})}),e.jsx("div",{"data-testid":`group-grip-${s.id}`,className:"cursor-grab p-0.5 text-gray-400 transition-colors hover:text-gray-600 active:cursor-grabbing",onMouseDown:()=>ue(s.id),onMouseUp:()=>ue(null),children:e.jsx(Ge,{size:14})})]})]})]}),!ye.has(s.id)&&e.jsxs(e.Fragment,{children:[s.note&&e.jsx("div",{className:"mb-3 line-clamp-2 pl-6 text-xs whitespace-pre-wrap text-gray-500 italic transition-all hover:line-clamp-none",children:s.note}),e.jsx("ul",{"data-testid":`group-items-${s.id}`,className:"min-h-[20px] space-y-2 pl-6",onDragOver:a=>{a.preventDefault()},onDrop:a=>{if(a.preventDefault(),M===null)return;const i=y.findIndex($=>$.id===M);if(i===-1)return;const N=y[i];if(N.group_id===s.id)return;const I=[...y];I[i]={...N,group_id:s.id},T(I),_e()},children:y.filter(a=>a.group_id===s.id).map(a=>e.jsxs("li",{"data-testid":`item-${a.id}`,"data-visited":a.visited,onClick:()=>u(a),draggable:!D&&h===a.id,onDragStart:i=>{i.stopPropagation(),ze(a.id)},onDragOver:i=>{i.stopPropagation(),Fe(i,a.id)},onDragEnd:_e,className:`group/item flex cursor-pointer items-center justify-between rounded-md p-1.5 text-sm transition-colors hover:bg-white/50 ${d?.id===a.id?"bg-blue-50 shadow-sm ring-1 ring-blue-200":a.visited?"bg-blue-100/50":a.latitude===void 0||a.latitude===null?jt:"text-gray-600"} ${M===a.id?"opacity-30":""}`,children:[e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col",children:[e.jsx("div",{className:`truncate font-medium ${d?.id===a.id?"text-blue-600":""}`,children:a.name}),d?.id===a.id&&a.note&&e.jsx("div",{className:"mt-1 text-xs whitespace-pre-wrap text-gray-500 italic",children:a.note})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[a.url_item&&e.jsx("a",{href:a.url_item,target:"_blank",rel:"noopener noreferrer",onClick:i=>i.stopPropagation(),className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-blue-50 hover:text-blue-500",title:"Open Item URL",children:e.jsx(De,{size:14})}),(a.url_google||a.latitude!==null&&a.latitude!==void 0)&&e.jsx("a",{href:a.url_google||`https://www.google.com/maps/search/?api=1&query=${a.latitude},${a.longitude}`,target:"_blank",rel:"noopener noreferrer",onClick:i=>i.stopPropagation(),className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-blue-50 hover:text-blue-500",title:"Open in Google Maps",children:e.jsx(be,{size:14})}),!D&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:i=>{i.stopPropagation(),H(a),R(!0)},className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-blue-50 hover:text-blue-500",title:"Edit",children:e.jsx(Ie,{size:14})}),e.jsx("button",{onClick:i=>{i.stopPropagation(),l(a.id)},className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-red-50 hover:text-red-500",children:e.jsx(Se,{size:14})}),e.jsx("div",{"data-testid":`item-grip-${a.id}`,className:"cursor-grab p-0.5 text-gray-400 transition-colors hover:text-gray-600 active:cursor-grabbing",onMouseDown:()=>x(a.id),onMouseUp:()=>x(null),children:e.jsx(Ge,{size:14})})]})]})]},a.id))})]})]},s.id))]}),W&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 p-4",children:e.jsxs("div",{className:"w-full max-w-sm rounded-lg bg-white p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-bold",children:A?"Edit Group":"Add Group"}),A&&e.jsx("button",{onClick:async()=>{confirm("Delete this group and all its items?")&&(await S(A.id),F(!1),V(null))},className:"rounded-lg p-1 text-gray-400 hover:bg-red-50 hover:text-red-500",title:"Delete Group",children:e.jsx(Se,{size:18})})]}),e.jsxs("form",{onSubmit:Je,children:[e.jsx("input",{className:"mb-4 w-full rounded border p-2",placeholder:"Group Name",value:O,onChange:s=>K(s.target.value),"data-testid":"group-name-input",required:!0}),e.jsx("textarea",{className:"mb-4 w-full rounded border p-2 text-sm",placeholder:"Note (optional)",value:pe,onChange:s=>X(s.target.value),rows:3}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"mb-2 block text-xs font-medium text-gray-500",children:"Select Color"}),e.jsx("div",{className:"grid max-h-48 grid-cols-6 gap-2 overflow-y-auto rounded border p-2",children:Object.entries(Pe).map(([s,a])=>e.jsx("button",{type:"button",title:s,onClick:()=>P(s),className:`h-8 w-8 rounded-full border-2 transition-all ${ee===s?"scale-110 border-black shadow-md":"border-transparent hover:scale-105"}`,style:{backgroundColor:a}},s))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{F(!1),V(null)},className:"flex-1 rounded border p-2",children:"Cancel"}),e.jsx("button",{type:"submit",className:"flex-1 rounded bg-blue-600 p-2 text-white",children:A?"Save":"Add"})]})]})]})}),_&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 p-4",children:e.jsxs("div",{className:"w-full max-w-sm rounded-lg bg-white p-6",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:v?"Edit Location":"Add Location"}),e.jsxs("form",{onSubmit:He,children:[e.jsx("label",{htmlFor:"group-select",className:"mb-1 block text-xs font-medium text-gray-500",children:"Group"}),e.jsxs("select",{id:"group-select","data-testid":"group-select",className:"mb-4 w-full rounded border p-2",value:de,onChange:s=>xe(s.target.value),children:[e.jsx("option",{value:"",children:"Select Group"}),t.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("input",{className:"mb-4 w-full rounded border p-2",placeholder:"Location Name",value:Y,onChange:s=>w(s.target.value),"data-testid":"location-name-input",required:!0}),e.jsx("textarea",{className:"mb-4 w-full rounded border p-2 text-sm",placeholder:"Note (optional)",value:ge,onChange:s=>te(s.target.value),rows:3}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("input",{className:"flex-1 rounded border p-2 text-sm",placeholder:"Google Maps URL (optional)",value:se,onChange:s=>ae(s.target.value),"data-testid":"location-url-input"}),e.jsx("button",{type:"button",onClick:We,"data-testid":"extract-url-button",className:"flex items-center justify-center rounded bg-gray-100 px-3 text-gray-600 hover:bg-gray-200",title:"Extract name and coordinates from URL",children:e.jsx(et,{size:16})})]}),e.jsx("input",{className:"mb-4 w-full rounded border p-2 text-sm",placeholder:"Item URL (optional)",value:he,onChange:s=>re(s.target.value),"data-testid":"item-url-input"}),e.jsx("input",{type:"text",className:"mb-4 w-full rounded border p-2",placeholder:"Coordinates (lat, lng)",value:ce,onChange:s=>B(s.target.value),"data-testid":"location-coordinates-input"}),e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"exclude-initial-map",checked:oe,onChange:s=>ne(s.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("label",{htmlFor:"exclude-initial-map",className:"text-sm text-gray-600 select-none",children:"Exclude from Initial Map View"})]}),e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"item-visited",checked:le,onChange:s=>ie(s.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500","data-testid":"location-visited-checkbox"}),e.jsx("label",{htmlFor:"item-visited",className:"text-sm text-gray-600 select-none",children:"Visited"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{R(!1),je()},className:"flex-1 rounded border p-2",children:"Cancel"}),e.jsx("button",{type:"submit",className:"flex-1 rounded bg-blue-600 p-2 text-white",children:v?"Save":"Add"})]})]})]})})]})},ke=13,Nt=[51.505,-.09],It=3,Re={duration:.5},St=()=>{const t=Ce(),{items:r,setSelectedItem:o}=Z();return React.useEffect(()=>{const d=new L.Control({position:"topleft"});return d.onAdd=()=>{const u=L.DomUtil.create("div","leaflet-bar leaflet-control"),c=L.DomUtil.create("a","leaflet-control-reset",u);return c.innerHTML='<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: block;"><path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8M3 16.2V21m0 0h4.8M3 21l6-6M21 7.8V3m0 0h-4.8M21 3l-6 6M3 7.8V3m0 0h4.8M3 3l6 6"/></svg>',c.href="#",c.title="Reset View",c.style.backgroundColor="white",c.style.cursor="pointer",c.style.width="30px",c.style.height="30px",c.style.lineHeight="30px",L.DomEvent.on(c,"click",g=>{L.DomEvent.stop(g),o(null);const S=r.filter(m=>m.latitude!==null&&m.latitude!==void 0&&!m.exclude_initial_map);if(S.length>0){const m=L.latLngBounds(S.map(b=>[b.latitude,b.longitude]));t.flyToBounds(m,{padding:[50,50],maxZoom:ke})}else t.flyTo(Nt,It)}),u},t.addControl(d),()=>{t.removeControl(d)}},[t,r,o]),null},kt=()=>{const t=Ce(),{items:r,selectedItem:o,shouldFocusItem:d,currentList:u,mobileView:c}=Z(),g=React.useRef(null),S=React.useRef(null),m=React.useRef(!1);return React.useEffect(()=>{const b=t.getContainer();if(b.clientWidth===0||b.clientHeight===0)return;c==="map"&&t.invalidateSize();const l=o?.id??null,C=u?.id??null;S.current!==C&&(m.current=!1,S.current=C);const G=g.current!==l,q=r.filter(_=>_.latitude!==null&&_.latitude!==void 0).filter(_=>!_.exclude_initial_map);if((q.length>0||o&&o.latitude!==null)&&(!m.current||G)){if(o&&o.latitude!==null&&o.latitude!==void 0&&(d||!m.current)){const _=m.current?t.getZoom():ke;t.flyTo([o.latitude,o.longitude],_,Re)}else if(q.length>0&&!o){const _=L.latLngBounds(q.map(R=>[R.latitude,R.longitude]));t.flyToBounds(_,{padding:[50,50],maxZoom:ke,...Re})}g.current=l,m.current=!0}},[r,o,d,u,t,c]),null},Ct=({children:t})=>e.jsxs(me,{position:"topright",children:[e.jsx(me.BaseLayer,{checked:!0,name:"Map",children:e.jsx(ve,{attribution:"Esri, HERE, Garmin, Intermap, increment P Corp., GEBCO, USGS, FAO, NPS, NRCAN, GeoBase, IGN, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), (c) OpenStreetMap contributors, and the GIS User Community",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",maxZoom:19})}),e.jsx(me.BaseLayer,{name:"3D Terrain",children:e.jsx(ve,{attribution:'<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",maxZoom:20})}),e.jsx(me.BaseLayer,{name:"Satellite",children:e.jsx(ve,{attribution:"Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, GIS",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})}),t]}),Lt=()=>{const t=Ce();return React.useEffect(()=>{window.leafletMap=t},[t]),null},_t=(t,r,o)=>{const d=Ae(r),u=o?"bg-blue-600 text-white":"bg-white text-gray-900",c=o?"bg-blue-600":"bg-white",g=d;return new L.DivIcon({className:"custom-div-icon",html:`
      <div class="flex items-center justify-center transition-all duration-300 ${o?"scale-125 z-50":"hover:scale-110"}">
        <div class="px-2 py-1 rounded-lg font-black text-xs shadow-lg border-2 whitespace-nowrap ${u}" style="border-color: ${g}">
          ${t}
        </div>
        <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 rotate-45 border-r-2 border-b-2 ${c}" style="border-color: ${g}"></div>
      </div>
    `,iconSize:[100,30],iconAnchor:[50,30]})},Et=()=>{const{groups:t,items:r,selectedItem:o,setSelectedItem:d,setShowAddItem:u,setEditingItem:c,isReadOnly:g,setMobileView:S}=Z();return e.jsx("div",{className:"h-full w-full",children:e.jsxs(ot,{center:[51.505,-.09],zoom:3,style:{height:"100%",width:"100%"},className:"z-0",zoomControl:!1,attributionControl:!1,zoomSnap:0,doubleClickZoom:!1,children:[e.jsxs(Ct,{children:[e.jsx(Lt,{}),t.map(m=>{const b=r.filter(l=>l.group_id===m.id&&!l.visited&&l.latitude!==null&&l.latitude!==void 0&&l.longitude!==null&&l.longitude!==void 0);return console.log(`Group ${m.name} has ${b.length} items on map (total ${r.filter(l=>l.group_id===m.id).length})`),b.length===0?null:e.jsx(me.Overlay,{checked:!0,name:m.name,children:e.jsx(bt,{children:b.map(l=>{const C=o?.id===l.id;return e.jsx(nt,{position:[l.latitude,l.longitude],icon:_t(l.name,l.group_color||"#3b82f6",C),zIndexOffset:C?1e3:0,eventHandlers:{click:()=>d(l,!0)},children:e.jsx(lt,{children:e.jsxs("div",{className:"min-w-[150px] text-center",children:[e.jsx("div",{className:"mb-1 border-b pb-1 font-bold",children:l.name}),l.note&&e.jsx("div",{className:"mb-2 text-xs whitespace-pre-wrap text-gray-600 italic",children:l.note}),e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[l.url_item&&e.jsx("a",{href:l.url_item,target:"_blank",rel:"noopener noreferrer",onClick:p=>p.stopPropagation(),className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-blue-50 hover:text-blue-500",title:"Open Item URL",children:e.jsx(De,{className:"size-4"})}),e.jsx("a",{href:l.url_google||`https://www.google.com/maps/search/?api=1&query=${l.latitude},${l.longitude}`,target:"_blank",rel:"noopener noreferrer",onClick:p=>p.stopPropagation(),className:"rounded-lg p-1 text-gray-400 transition-all hover:bg-blue-50 hover:text-blue-500",title:"Open in Google Maps",children:e.jsx(be,{className:"size-4"})}),!g&&e.jsx("button",{onClick:()=>{c(l),u(!0),S("list")},className:"flex items-center justify-center text-gray-600 transition-colors hover:text-indigo-600",title:"Edit Location",children:e.jsx(Ie,{className:"size-4"})})]})]})})},l.id)})})},m.id)})]}),e.jsx(wt,{position:"topleft"}),e.jsx(St,{}),e.jsx(kt,{})]})})},Gt=({onClose:t})=>{const{lists:r,createList:o,deleteList:d}=Z(),{successToast:u}=it(),[c,g]=React.useState(""),[S,m]=React.useState(null),b=async p=>{p.preventDefault(),c.trim()&&(await o(c),g(""))},l=async(p,G)=>{window.confirm(`Are you sure you want to delete "${G}" and all its groups/points?`)&&await d(p)},C=(p,G)=>{const J=`${window.location.origin}${window.location.pathname}?share_token=${p}`;navigator.clipboard.writeText(J),m(G),u("Share link copied to clipboard!"),setTimeout(()=>m(null),2e3)};return e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"flex max-h-full w-full max-w-md flex-col rounded-2xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Manage Lists"}),e.jsx("button",{onClick:t,className:"rounded-lg p-1 hover:bg-gray-100",children:e.jsx(dt,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{"data-testid":"list-manager-content",className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("form",{onSubmit:b,className:"mb-6 flex gap-2",children:[e.jsx("input",{autoFocus:!0,className:"flex-1 rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500/20 focus:outline-none",placeholder:"New list name...",value:c,onChange:p=>g(p.target.value),"data-testid":"new-list-input"}),e.jsx("button",{type:"submit",className:"flex h-10 w-10 items-center justify-center rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-200 transition-all hover:bg-blue-700",children:e.jsx(Ne,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-xs font-black tracking-tight text-gray-400 uppercase",children:"Your Lists"}),r.length===0&&e.jsx("p",{className:"py-4 text-center text-sm text-gray-500",children:"No lists created yet."}),r.map(p=>e.jsxs("div",{className:"group flex items-center justify-between rounded-xl border border-gray-100 bg-gray-50 p-3 transition-all hover:border-gray-200 hover:bg-white hover:shadow-sm",children:[e.jsx("span",{className:"font-bold text-gray-700",children:p.name}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>C(p.share_token,p.id),className:`rounded-lg p-1.5 transition-all ${S===p.id?"bg-green-100 text-green-600":"text-gray-400 hover:bg-blue-50 hover:text-blue-600"}`,title:"Copy Share Link",children:S===p.id?e.jsx(ut,{className:"h-4 w-4"}):e.jsx(ft,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>l(p.id,p.name),className:"rounded-lg p-1.5 text-gray-400 hover:bg-red-50 hover:text-red-500",children:e.jsx(Se,{className:"h-4 w-4"})})]})]},p.id))]})]}),e.jsx("div",{className:"border-t p-4",children:e.jsx("button",{onClick:t,className:"w-full rounded-xl bg-gray-100 py-2.5 text-sm font-bold text-gray-600 transition-all hover:bg-gray-200",children:"Done"})})]})})},Rt=()=>{const{user:t,lists:r,currentList:o,setCurrentList:d,logout:u,isReadOnly:c,mobileView:g,setMobileView:S}=Z(),[m,b]=React.useState(!1);return e.jsxs("header",{className:"z-30 flex flex-col justify-between gap-4 border-b border-gray-200 bg-white px-4 py-3 shadow-sm md:flex-row md:items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-xl bg-blue-600 text-white shadow-lg",children:e.jsx(be,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-extrabold tracking-tight text-gray-900",children:"Maps"}),e.jsx("p",{className:"text-xs font-medium tracking-wider text-gray-500 uppercase",children:o?.name||"No list selected"})]})]}),e.jsxs("div",{className:"flex flex-1 items-center justify-between gap-2",children:[c?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"rounded-full bg-blue-50 px-3 py-1 text-xs font-bold text-blue-600 uppercase",children:"Shared List"}),e.jsx("button",{onClick:()=>{window.location.href=window.location.pathname},className:"text-sm font-bold text-gray-500 hover:text-blue-600 hover:underline",children:"Back to My Maps"})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:"list-select",className:"ml-2 hidden text-xs font-black tracking-tight text-gray-400 uppercase md:block",children:"List"}),e.jsxs("div",{className:"group relative",children:[e.jsxs("select",{id:"list-select",value:o?.id||"",onChange:l=>{const C=r.find(p=>p.id===Number(l.target.value));C&&d(C)},className:"relative cursor-pointer appearance-none rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 pr-10 text-sm font-bold text-blue-600 transition-all focus:ring-2 focus:ring-blue-500/20 focus:outline-none",children:[r.length===0&&e.jsx("option",{value:"",children:"No lists"}),r.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]}),e.jsx("div",{className:"pointer-events-none absolute top-1/2 right-3 -translate-y-1/2 text-blue-600",children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsxs("button",{onClick:()=>b(!0),className:"flex h-9 items-center justify-center gap-2 rounded-xl bg-gray-100 px-2 text-gray-600 transition-all hover:bg-gray-200 md:px-3",title:"Manage Lists",children:[e.jsx(pt,{className:"h-5 w-5"}),e.jsx("span",{className:"hidden text-sm font-semibold md:block",children:"Settings"})]}),e.jsxs("div",{className:"ml-4 flex items-center gap-2",children:[e.jsx("span",{className:"hidden text-sm font-semibold text-gray-600 md:block",children:t?.first_name}),e.jsx("button",{onClick:u,className:"flex h-9 w-9 items-center justify-center rounded-xl text-gray-500 transition-colors hover:bg-red-50 hover:text-red-500",title:"Logout",children:e.jsx(gt,{className:"h-5 w-5"})})]})]}),e.jsx("button",{onClick:()=>S(g==="map"?"list":"map"),className:"flex h-9 items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 text-white transition-all hover:bg-blue-700 md:hidden",title:g==="map"?"Show List":"Show Map",children:g==="map"?e.jsx(ht,{className:"h-5 w-5"}):e.jsx(be,{className:"h-5 w-5"})})]}),m&&e.jsx(Gt,{onClose:()=>b(!1)})]})},Mt=()=>{const{user:t,isLoading:r,mobileView:o,handleAuthSuccess:d}=Z();return r?e.jsx("div",{className:"flex h-screen items-center justify-center",children:"Loading..."}):t?e.jsxs("div",{className:"flex h-screen w-full flex-col overflow-hidden bg-gray-50",children:[e.jsx(Rt,{}),e.jsxs("main",{className:"relative flex flex-1 flex-col overflow-hidden md:flex-row",children:[e.jsx("div",{className:`h-full border-r border-gray-200 bg-white md:w-1/3 ${o==="list"?"block":"hidden md:block"}`,children:e.jsx(vt,{})}),e.jsx("div",{className:`relative h-full overflow-hidden md:w-2/3 ${o==="map"?"block":"hidden md:block"}`,children:e.jsx(Et,{})})]})]}):e.jsx(Xe,{appName:"Maps",loginEndpoint:"/maps/auth/login",registerEndpoint:"/maps/auth/register",onSuccess:(u,c)=>d(u.access_token,u.user,c)})};function $t(){return e.jsx(ct,{children:e.jsx(yt,{children:e.jsx(Mt,{})})})}ReactDOM.createRoot(document.getElementById("root")).render(e.jsx(React.StrictMode,{children:e.jsx($t,{})}));
