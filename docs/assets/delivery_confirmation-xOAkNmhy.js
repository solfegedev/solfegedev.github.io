import"./modulepreload-polyfill-B5Qt9EMX.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{A as pe}from"./api-CH_Pe6Vg.js";const _e=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),j=a=>{const c=typeof a=="string"?new Date(a):a;return _e.format(c)},X=a=>a==="pending"?"Pending":a==="validated"?"Complete":"Locked",je=(a,c,i)=>a==="validated"&&c?"Code accepted â€” this delivery is now complete.":a==="locked"?"Maximum attempts reached. Delivery is locked.":c?"Attempt verified.":i===1?"Incorrect code. One attempt left.":`Incorrect code. ${i} attempts left.`,p=`${pe}/delivery_confirmation`,v=a=>({Authorization:`Bearer ${a}`,"Content-Type":"application/json"}),N=async(a,c)=>{try{if((a.headers.get("content-type")??"").includes("application/json")){const n=await a.json();if(typeof n=="string")return n;if(Array.isArray(n)){const l=n[0];if(typeof l=="string")return l;if(l&&typeof l=="object"){const m=l.message;if(typeof m=="string")return m}}if(n&&typeof n=="object"){const l=n,m=["detail","message","error"];for(const o of m){const _=l[o];if(typeof _=="string")return _}}}return(await a.text()).trim()||c}catch(i){return console.error("Failed to parse error response",i),c}},xe=()=>{const[a,c]=React.useState(null),[i,I]=React.useState(""),[n,l]=React.useState(""),[m,o]=React.useState(null),[_,L]=React.useState(!1),[g,h]=React.useState(!1),[T,$]=React.useState(!1),[F,y]=React.useState(null),[O,b]=React.useState([]),[x,w]=React.useState({}),[S,D]=React.useState(""),[R,C]=React.useState(null),[P,M]=React.useState(!1),[U,q]=React.useState(""),[V,B]=React.useState(""),[u,A]=React.useState(null),[H,f]=React.useState(null),[k,J]=React.useState([]),[G,W]=React.useState(!1),[Y,z]=React.useState({}),ee=a?.role==="shop",se=a?.role==="driver";React.useEffect(()=>{a?.role==="shop"&&te(),a?.role==="driver"&&K()},[a?.role]);const te=async()=>{if(!a)return;const t=await fetch(`${p}/deliveries`,{headers:v(a.token)});if(!t.ok)return;const s=await t.json();b(s)},ae=async t=>{if(!a)return;const s=await fetch(`${p}/deliveries/${t}/attempts`,{headers:v(a.token)});if(!s.ok)return;const r=await s.json();w(d=>({...d,[t]:r.attempts}))},K=async()=>{if(!a)return;const t=await fetch(`${p}/attempts`,{headers:v(a.token)});if(!t.ok)return;const s=await t.json();J(s)},re=t=>{const s=t.replace(/\D/g,"").slice(0,6);B(s)},de=t=>{const s=t.replace(/\D/g,"");q(s)},ce=()=>{c(null),b([]),w({}),J([]),A(null),f(null),z({}),q(""),B(""),C(null),D(""),y(null)},ne=async t=>{t.preventDefault(),o(null),y(null),L(!0);try{const s=await fetch(`${p}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i.trim(),password:n})});if(!s.ok){const d=await N(s,"Unable to log in");throw new Error(d)}const r=await s.json();c({token:r.access_token,username:r.username,role:r.role})}catch(s){o(s instanceof Error?s.message:"Login failed")}finally{L(!1)}},ie=async()=>{const t=i.trim();if(y(null),o(null),!t){o("Username is required to reset password.");return}$(!0);try{const s=await fetch(`${p}/password_reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t})});if(!s.ok)throw new Error(await N(s,"Unable to request password reset"));const r=await s.json();y(r.message)}catch(s){o(s instanceof Error?s.message:"Reset failed")}finally{$(!1)}},le=async t=>{if(t.preventDefault(),!(!a||!S.trim())){M(!0);try{const s=await fetch(`${p}/deliveries`,{method:"POST",headers:v(a.token),body:JSON.stringify({address:S.trim()})});if(!s.ok)throw new Error(await N(s,"Unable to create delivery"));const r=await s.json();b(d=>[r,...d]),C(r),D("")}catch(s){C(null),o(s instanceof Error?s.message:"Unable to create delivery")}finally{M(!1)}}},oe=async t=>{if(t.preventDefault(),!a)return;const s=U.trim(),r=V.trim();if(!s){f("Delivery ID is required.");return}if(!/^\d{6}$/.test(r)){f("Code must be exactly 6 digits.");return}f(null),W(!0);try{const d=await fetch(`${p}/attempts`,{method:"POST",headers:v(a.token),body:JSON.stringify({delivery_id:Number(s),code:r})});if(!d.ok){const ue=await N(d,"Attempt rejected");throw new Error(ue)}const E=await d.json();A(E),await K()}catch(d){A(null),f(d instanceof Error?d.message:"Attempt failed")}finally{W(!1)}},me=React.useMemo(()=>a?a.role==="shop"?"Create deliveries, hand off the one-time code, and check delivery confirmations.":"Confirm deliveries.":"Generate and validate single-use delivery codes.",[a]),he=React.useMemo(()=>a?a.role==="shop"?"Shop":"Driver":null,[a]),Q=React.useMemo(()=>{if(!k.length)return[];const t=new Map;return k.forEach(s=>{t.has(s.delivery_id)||t.set(s.delivery_id,{delivery_id:s.delivery_id,address:s.address,status:s.status,attempts:[]});const r=t.get(s.delivery_id);r&&r.attempts.push(s)}),Array.from(t.values()).map(s=>({...s,attempts:[...s.attempts].sort((r,d)=>new Date(d.created_at).getTime()-new Date(r.created_at).getTime())})).sort((s,r)=>{const d=s.attempts[0]?.created_at??0,E=r.attempts[0]?.created_at??0;return new Date(E).getTime()-new Date(d).getTime()}).map(s=>({...s,status:s.attempts[0]?.status??s.status,address:s.attempts[0]?.address??s.address}))},[k]);return e.jsxs("div",{className:"dc-app",children:[e.jsxs("header",{className:"dc-app__header",children:[e.jsxs("div",{className:"dc-identity",children:[e.jsx("span",{className:"dc-identity__eyebrow",children:"Delivery Confirmation"}),e.jsx("h1",{className:"dc-identity__title",children:"One-time codes"}),e.jsx("p",{className:"dc-identity__lede",children:me})]}),e.jsx("div",{className:"dc-status",children:a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dc-status__role",children:he}),e.jsxs("div",{className:"dc-status__user",children:["Signed in as ",a.username]}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:ce,children:"Log out"})]})})]}),!a&&e.jsxs("section",{className:"dc-panel dc-panel--login",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Sign in"}),e.jsx("p",{children:"Use your assigned username to manage or confirm deliveries."})]}),e.jsxs("form",{className:"dc-form",onSubmit:ne,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"username",children:"Username"}),e.jsx("input",{id:"username",name:"username",type:"text",value:i,onChange:t=>I(t.target.value),placeholder:"shop or driver",className:"dc-input",required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"password",children:"Password"}),e.jsxs("div",{className:"dc-input__wrapper",children:[e.jsx("input",{id:"password",name:"password",type:g?"text":"password",value:n,onChange:t=>l(t.target.value),className:"dc-input",required:!0}),e.jsx("button",{type:"button",className:"dc-input__toggle","aria-label":g?"Hide characters":"Show characters","aria-controls":"password","aria-pressed":g,onMouseDown:()=>h(!0),onMouseUp:()=>h(!1),onMouseLeave:()=>h(!1),onBlur:()=>h(!1),onTouchStart:()=>h(!0),onTouchEnd:()=>h(!1),onTouchCancel:()=>h(!1),"aria-live":"polite",children:"ðŸ‘"})]})]}),m&&e.jsx("div",{className:"dc-form__error",children:m}),e.jsxs("div",{className:"dc-form__actions",children:[e.jsx("button",{className:"dc-button",type:"submit",disabled:_,children:_?"Signing in...":"Sign in"}),e.jsx("button",{className:"dc-button dc-button--ghost",type:"button",onClick:ie,disabled:T||_,children:T?"Requesting...":"Forgot password?"})]}),F&&e.jsx("div",{className:"dc-alert",children:F})]})]}),ee&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Create delivery"}),e.jsx("p",{children:"Generate a delivery ID and one-time code tied to the address."})]}),e.jsxs("form",{className:"dc-form",onSubmit:le,children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"address",children:"Delivery address"}),e.jsx("textarea",{id:"address",name:"address",className:"dc-input dc-input--multiline",value:S,onChange:t=>D(t.target.value),placeholder:"12 Finchley rd, London, NW3 5JD",rows:3,required:!0})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:P,children:P?"Creating...":"Generate code"}),R&&e.jsxs("div",{className:"dc-alert",children:[e.jsx("div",{className:"dc-alert__title",children:"Delivery created"}),e.jsxs("div",{className:"dc-alert__codes",children:[e.jsxs("span",{children:["Delivery ID: ",R.delivery_id]}),e.jsxs("span",{children:["Secret code: ",R.secret_code]})]}),e.jsx("div",{className:"dc-alert__hint",children:"Share these with the recipient securely."})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsx("div",{className:"dc-panel__header",children:e.jsx("h2",{children:"Your deliveries"})}),O.length===0?e.jsx("p",{className:"dc-empty",children:"No deliveries yet."}):e.jsx("div",{className:"dc-list",children:O.map(t=>e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",t.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:t.address})]}),e.jsx("span",{className:`dc-chip dc-chip--${t.status}`,children:X(t.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Secret code"}),e.jsx("dd",{className:"dc-code",children:t.secret_code})]}),e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Created"}),e.jsx("dd",{children:j(t.created_at)})]}),t.validated_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Completed"}),e.jsx("dd",{children:j(t.validated_at)})]}),t.locked_at&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Locked"}),e.jsx("dd",{children:j(t.locked_at)})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>x[t.delivery_id]?w(s=>{const r={...s};return delete r[t.delivery_id],r}):ae(t.delivery_id),children:x[t.delivery_id]?"Close":"View attempts"})}),x[t.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"User"}),e.jsx("span",{children:"Result"})]}),x[t.delivery_id].map(s=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:s.attempt_number}),e.jsx("span",{children:j(s.created_at)}),e.jsx("span",{children:s.delivery_person}),e.jsx("span",{className:s.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:s.success?"Verified":"Failed"})]},s.attempt_number)),x[t.delivery_id].length===0&&e.jsx("div",{className:"dc-table__row dc-table__row--muted",children:"No attempts yet."})]})]},t.delivery_id))})]})]}),se&&e.jsxs("section",{className:"dc-grid dc-grid--single-column",children:[e.jsxs("div",{className:"dc-panel dc-panel--accent",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Validate a delivery"}),e.jsx("p",{children:"Enter the delivery ID and the 6-digit code provided by the shop team."})]}),e.jsxs("form",{className:"dc-form",onSubmit:oe,children:[e.jsxs("div",{className:"dc-form__group",children:[e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"deliveryId",children:"Delivery ID"}),e.jsx("input",{id:"deliveryId",name:"deliveryId",type:"text",inputMode:"numeric",pattern:"^[0-9]+$",className:"dc-input",value:U,onChange:t=>de(t.target.value),required:!0})]}),e.jsxs("div",{className:"dc-form__field",children:[e.jsx("label",{className:"dc-form__label",htmlFor:"secretCode",children:"Secret code"}),e.jsx("input",{id:"secretCode",name:"secretCode",type:"text",inputMode:"numeric",autoComplete:"one-time-code",pattern:"^[0-9]{6}$",maxLength:6,className:"dc-input",value:V,onChange:t=>re(t.target.value),required:!0})]})]}),e.jsx("button",{className:"dc-button",type:"submit",disabled:G,children:G?"Submitting...":"Submit attempt"}),H&&e.jsx("div",{className:"dc-form__error",children:H}),u&&e.jsxs("div",{className:`dc-alert ${u.success?"dc-alert--success":""}`,children:[e.jsxs("div",{className:"dc-alert__title",children:["Attempt ",u.attempt_number," Â· Delivery ",u.delivery_id]}),e.jsx("p",{className:"dc-alert__hint",children:je(u.status,u.success,u.remaining_attempts)})]})]})]}),e.jsxs("div",{className:"dc-panel",children:[e.jsxs("div",{className:"dc-panel__header",children:[e.jsx("h2",{children:"Recent attempts"}),e.jsx("p",{children:"Your attempts grouped by delivery"})]}),Q.length===0?e.jsx("p",{className:"dc-empty",children:"No attempts logged yet."}):e.jsx("div",{className:"dc-list",children:Q.map(t=>{const s=t.attempts[0];return e.jsxs("article",{className:"dc-card",children:[e.jsxs("header",{className:"dc-card__header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"dc-card__eyebrow",children:["Delivery ",t.delivery_id]}),e.jsx("h3",{className:"dc-card__title",children:t.address}),s&&e.jsxs("p",{className:"dc-card__hint",children:["Last attempt #",s.attempt_number," Â·"," ",j(s.created_at)]})]}),e.jsx("span",{className:`dc-chip dc-chip--${t.status}`,children:X(t.status)})]}),e.jsxs("dl",{className:"dc-meta",children:[e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Total attempts"}),e.jsx("dd",{children:t.attempts.length})]}),s&&e.jsxs("div",{className:"dc-meta__row",children:[e.jsx("dt",{children:"Latest result"}),e.jsx("dd",{className:s.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:s.success?"Verified":"Failed"})]})]}),e.jsx("footer",{className:"dc-card__footer",children:e.jsx("button",{type:"button",className:"dc-button dc-button--ghost",onClick:()=>z(r=>({...r,[t.delivery_id]:!r[t.delivery_id]})),children:Y[t.delivery_id]?"Hide attempts":"View attempts"})}),Y[t.delivery_id]&&e.jsxs("div",{className:"dc-table",children:[e.jsxs("div",{className:"dc-table__head",children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"When"}),e.jsx("span",{children:"Result"})]}),t.attempts.map(r=>e.jsxs("div",{className:"dc-table__row",children:[e.jsx("span",{children:r.attempt_number}),e.jsx("span",{children:j(r.created_at)}),e.jsx("span",{className:r.success?"dc-pill dc-pill--success":"dc-pill dc-pill--danger",children:r.success?"Verified":"Failed"})]},`${r.delivery_id}-${r.attempt_number}`))]})]},t.delivery_id)})})]})]})]})},Z=document.getElementById("root");if(!Z)throw new Error("Root element #root not found");ReactDOM.createRoot(Z).render(e.jsx(React.StrictMode,{children:e.jsx(xe,{})}));
