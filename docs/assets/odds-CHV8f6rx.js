import"./modulepreload-polyfill-B5Qt9EMX.js";import{j as t}from"./jsx-runtime-u17CrQMm.js";import{A as G}from"./api-CH_Pe6Vg.js";const Q="label";function z(a,n){typeof a=="function"?a(n):a&&(a.current=n)}function ae(a,n){const i=a.options;i&&n&&Object.assign(i,n)}function Y(a,n){a.labels=n}function X(a,n,i=Q){const l=[];a.datasets=n.map(o=>{const p=a.datasets.find(e=>e[i]===o[i]);return!p||!o.data||l.includes(p)?{...o}:(l.push(p),Object.assign(p,o),p)})}function re(a,n=Q){const i={labels:[],datasets:[]};return Y(i,a.labels),X(i,a.datasets,n),i}function ne(a,n){const{height:i=150,width:l=300,redraw:o=!1,datasetIdKey:p,type:e,data:b,options:f,plugins:M=[],fallbackContent:L,updateMode:N,...h}=a,C=React.useRef(null),m=React.useRef(null),E=()=>{C.current&&(m.current=new Chart.Chart(C.current,{type:e,data:re(b,p),options:f&&{...f},plugins:M}),z(n,m.current))},j=()=>{z(n,null),m.current&&(m.current.destroy(),m.current=null)};return React.useEffect(()=>{!o&&m.current&&f&&ae(m.current,f)},[o,f]),React.useEffect(()=>{!o&&m.current&&Y(m.current.config.data,b.labels)},[o,b.labels]),React.useEffect(()=>{!o&&m.current&&b.datasets&&X(m.current.config.data,b.datasets,p)},[o,b.datasets]),React.useEffect(()=>{m.current&&(o?(j(),setTimeout(E)):m.current.update(N))},[o,f,b.labels,b.datasets,N]),React.useEffect(()=>{m.current&&(j(),setTimeout(E))},[e]),React.useEffect(()=>(E(),()=>j()),[]),t.jsx("canvas",{ref:C,role:"img",height:i,width:l,...h,children:L})}const se=React.forwardRef(ne);function T(a,n){return Chart.Chart.register(n),React.forwardRef((i,l)=>t.jsx(se,{...i,ref:l,type:a}))}Chart.LineController;const oe=T("bar",Chart.BarController);Chart.RadarController;Chart.DoughnutController;Chart.PolarAreaController;Chart.BubbleController;const ie=T("pie",Chart.PieController);Chart.ScatterController;const le=a=>a.state?.status==="ACTIVE",ce=a=>a.state?.status==="LOSER",de=a=>a.state?.status==="WINNER",V=a=>{if(!a||a.length===0)return null;const[n]=a;return typeof n.price!="number"||typeof n.size!="number"?null:{price:n.price,size:n.size}},ue=(a,n,i,l)=>{const o=[],p=f=>typeof f!="number"?1:f<=0?0:1/f;if(typeof a=="number"&&a>0&&o.push({price:a,weight:p(i)}),typeof n=="number"&&n>0&&o.push({price:n,weight:p(l)}),o.length===0)return null;const e=o.reduce((f,M)=>f+M.weight,0);return e===0?null:1/(o.reduce((f,M)=>f+M.price*M.weight,0)/e)},J="* ",F="1.244214540",pe=a=>{const n="https://ero.betfair.com/www/sports/exchange/readonly/v1/bymarket",i=[["rollupLimit","10"],["rollupModel","STAKE"],["currencyCode","GBP"],["locale","en_GB"]],l="MARKET_STATE,MARKET_DESCRIPTION,RUNNER_DESCRIPTION,RUNNER_EXCHANGE_PRICES_BEST,RUNNER_STATE",o=new URLSearchParams;return i.forEach(([p,e])=>o.append(p,e)),o.append("marketIds",a),o.append("types",l),`${n}?${o.toString()}`},fe=(a,n)=>{const i=a.eventTypes?.[0]?.eventNodes?.[0]?.marketNodes?.[0],l=i?{marketId:i.marketId,status:i.state.status,inplay:i.state.inplay,numberOfWinners:i.state.numberOfWinners,description:i.description,runners:i.runners}:void 0,o=l?.description?.marketName??"—",p=l?.runners??[],e=p.filter(le),b=p.filter(ce),f=p.filter(de),M=k=>{const _=k.description?.runnerName??"Unknown runner",I=V(k.exchange?.availableToBack),S=V(k.exchange?.availableToLay),P=I?.price??(typeof k.state?.lastPriceTraded=="number"?k.state?.lastPriceTraded:null),A=S?.price??null,D=I?.size??null,r=S?.size??null,d=k.state?.status,y=d==="ACTIVE"||d==="LOSER"||d==="WINNER"?d:"UNKNOWN",u=y==="WINNER",w=u?J+_:_,s=u?1:ue(P,A,D,r),c=u?1:typeof A=="number"&&A>0?1/A:null,x=u?1:typeof P=="number"&&P>0?1/P:null;return{id:k.selectionId,name:w,status:y,bestBack:P,bestLay:A,impliedProbability:s,probabilityMin:c,probabilityMax:x}},N=[...[...e,...f].map(M)].sort((k,_)=>{const I=k.impliedProbability??0,S=_.impliedProbability??0;if(I!==S)return S-I;const P=k.bestBack??Number.POSITIVE_INFINITY,A=_.bestBack??Number.POSITIVE_INFINITY;return P!==A?P-A:0}),h=N.filter(k=>(k.impliedProbability??0)>=.01),C=h.reduce((k,_)=>k+(_.impliedProbability??0),0),m=Math.max(0,1-C),E=N.length-h.length,j={id:-1,name:E>0?`Others ${E}`:"Others",bestBack:null,bestLay:null,status:"AGGREGATE",impliedProbability:m,probabilityMin:m,probabilityMax:m},$=[...h,j].sort((k,_)=>{const I=k.impliedProbability??0,S=_.impliedProbability??0;return I!==S?S-I:0});return{marketId:l?.marketId??"unknown",marketName:o,runners:$,fetchedAt:n.toISOString(),status:l?.status??"UNKNOWN",inplay:!!l?.inplay,numberOfWinners:l?.numberOfWinners??1,activeRunnerCount:e.length,loserRunnerCount:b.length,winnerRunnerCount:f.length,totalRunners:e.length+b.length+f.length}},K=a=>{const n=a.filter(l=>l.favorite===1),i=a.filter(l=>l.favorite!==1);return[...n,...i]},me=(a,n)=>{const i=[];return a.forEach(l=>{const o=`group-${l.id}`;i.push({kind:"group",id:o,groupId:l.id,label:l.label}),n.has(l.id)&&l.markets.forEach(p=>{i.push({kind:"option",id:`option-${p.id}`,groupId:l.id,marketId:p.id,label:p.label})})}),i},he=(a,n)=>a.find(i=>i.markets.some(l=>l.id===n)),H=a=>a.flatMap(n=>n.markets),Z=({favorite:a})=>a!==1?null:t.jsx("span",{className:"select__favorite","aria-hidden":"true",children:"★"}),q=({label:a,favorite:n,closeDate:i})=>t.jsxs("span",{className:"select__option-label",children:[t.jsx(Z,{favorite:n}),t.jsx("span",{children:a}),i?t.jsxs("span",{className:"select__option-close-date",children:["(",i,")"]}):null]}),be=({groups:a,selectedMarketId:n,onSelect:i,requestState:l})=>{const o=React.useMemo(()=>a.map((r,d)=>({...r,id:`group-${d}-${r.label||"group"}`,markets:K(r.markets)})),[a]),p=React.useMemo(()=>{const r=H(o).filter(d=>d.favorite===1);return r.length===0?null:{id:"group-favorites",label:"Favorites",markets:K(r),isFavorites:!0}},[o]),e=React.useMemo(()=>p?[p,...o]:o,[o,p]),[b,f]=React.useState(!1),[M,L]=React.useState(new Set),[N,h]=React.useState(null),[C,m]=React.useState({}),E=React.useRef(null),j=React.useRef(null),$=React.useRef(new Map),k=React.useMemo(()=>H(e),[e]),_=React.useMemo(()=>k.length===0?{id:n,label:l==="loading"?"Loading markets...":"No markets available"}:k.find(r=>r.id===n)??k[0],[k,n,l]),I=React.useMemo(()=>me(e,M),[e,M]);React.useEffect(()=>{if(!b)return;const r=he(e,n)??e[0];L(u=>{const w=r?new Set([r.id]):new Set;return u.size===w.size&&[...w].every(c=>u.has(c))?u:w});const d=r?.markets[0],y=r?.markets.find(u=>u.id===n)?.id??d?.id;h(y?`option-${y}`:null)},[e,b,n]),React.useEffect(()=>{const r=d=>{E.current&&!E.current.contains(d.target)&&f(!1)};return b&&document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[b]),React.useEffect(()=>{if(!b||!N)return;$.current.get(N)?.focus()},[N,b]),React.useEffect(()=>{if(!b)return;const r=()=>{if(!j.current)return;const d=j.current.getBoundingClientRect(),y=window.innerHeight,u=window.innerWidth,w=12,s=Math.min(720,u-w*2),x=d.left+d.width/2-s/2,R=Math.min(Math.max(x,w),Math.max(w,u-s-w)),g=y-d.bottom-w,v=d.top-w,O=g<240&&v>g,te=Math.max(140,Math.min(720,O?v:g));m({position:"fixed",width:`${s}px`,maxHeight:`${te}px`,left:`${R}px`,transform:"none",top:O?void 0:`${d.bottom+8}px`,bottom:O?`${y-d.top+8}px`:void 0})};return r(),window.addEventListener("resize",r),window.addEventListener("scroll",r,{passive:!0}),()=>{window.removeEventListener("resize",r),window.removeEventListener("scroll",r)}},[b,e,n]);const S=r=>{L(d=>d.has(r)?new Set:new Set([r]))},P=r=>{if(I.length===0)return;const d=I.findIndex(s=>s.id===N),y=d===-1?0:d,u=Math.min(I.length-1,Math.max(0,y+r)),w=I[u];h(w?.id??null)},A=(r,d)=>{if(r.key==="ArrowDown"&&(r.preventDefault(),P(1)),r.key==="ArrowUp"&&(r.preventDefault(),P(-1)),r.key==="Escape"){r.preventDefault(),f(!1);return}const y=I.find(u=>u.id===d);y&&(y.kind==="group"&&(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),S(y.groupId)),y.kind==="option"&&(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),i(y.marketId),f(!1)))},D=(r,d)=>{$.current.set(r,d)};return t.jsxs("div",{className:"select",ref:E,children:[t.jsxs("button",{type:"button",className:"select__toggle","aria-haspopup":"listbox","aria-expanded":b,onClick:()=>f(r=>!r),onKeyDown:r=>{r.key==="Escape"&&f(!1)},ref:j,children:[t.jsx(q,{label:_?.label??"",favorite:_?.favorite,closeDate:_?.close_date}),t.jsx("span",{className:"select__caret","aria-hidden":"true",children:"▾"})]}),b&&t.jsx("ul",{className:"select__list",role:"listbox","aria-label":"Choose market",style:C,children:e.length===0?t.jsx("li",{children:t.jsx("span",{className:"select__option","aria-disabled":"true",children:l==="loading"?"Loading markets...":"No markets available"})}):e.map(r=>{const d=M.has(r.id),y=`group-${r.id}`;return t.jsxs("li",{className:"select__group",children:[t.jsxs("button",{type:"button",className:"select__group-header","aria-expanded":d,"aria-controls":`${r.id}-options`,onClick:()=>S(r.id),onKeyDown:u=>A(u,y),"data-kind":"group",tabIndex:N===y?0:-1,ref:u=>D(y,u),onFocus:()=>h(y),children:[t.jsxs("span",{className:"select__group-label",children:[r.isFavorites?t.jsx(Z,{favorite:1}):null,t.jsx("span",{children:r.label})]}),t.jsx("span",{className:d?"select__group-caret":"select__group-caret select__group-caret--collapsed","aria-hidden":"true",children:"▾"})]}),d&&t.jsx("ul",{className:"select__group-options",id:`${r.id}-options`,role:"group",children:r.markets.map(u=>{const w=`option-${u.id}`,s=u.id===n;return t.jsx("li",{children:t.jsx("button",{type:"button",className:s?"select__option is-active":"select__option",role:"option","aria-selected":s,onClick:()=>{i(u.id),f(!1)},onKeyDown:c=>A(c,w),"data-kind":"option",tabIndex:N===w?0:-1,ref:c=>D(w,c),onFocus:()=>h(w),children:t.jsx(q,{label:u.label,favorite:u.favorite,closeDate:u.close_date})})},w)})})]},r.id)})})]})},Re={id:"valueLabel",afterDatasetsDraw(a,n,i){const l=a.config.type;if(l&&l!=="bar")return;const{ctx:o,data:p}=a,e=i?.color??"#e8ecf5";o.save();const b=a.getSortedVisibleDatasetMetas(),f=b[b.length-1];f&&(f.data.forEach((M,L)=>{const N=i?.impliedProbabilities?.[L],h=typeof N=="number"?N:p.datasets?.reduce((m,E)=>{const j=E?.data?.[L];return typeof j=="number"?m+j:m},0);if(typeof h!="number"||h<=0)return;const C=M.tooltipPosition(!0);C.x===null||C.y===null||(o.fillStyle=e,o.font='600 12px "Inter", system-ui, -apple-system, sans-serif',o.textBaseline="middle",o.textAlign="left",o.fillText(`${h.toFixed(1)}%`,C.x+6,C.y))}),o.restore())}};Chart.Chart.register(Chart.ArcElement,Chart.BarElement,Chart.CategoryScale,Chart.LinearScale,Chart.Legend,Chart.Title,Chart.Tooltip,Re);const B=["#ba0034","#0293d9","#ff901a","#50469d","#eb9fa2","#87365c","#97d76f","#ed2fa4","#0b6109","#ffa1e4","#01dbc6"],W=()=>typeof window>"u"?F:new URLSearchParams(window.location.search).get("marketId")??F,U=a=>a===null||Number.isNaN(a)?"—":`${(a*100).toFixed(1)}%`,xe=()=>{const[a,n]=React.useState([]),[i,l]=React.useState("idle"),[o,p]=React.useState(null),[e,b]=React.useState(null),[f,M]=React.useState("idle"),[L,N]=React.useState(null),[h,C]=React.useState(()=>W()),m=React.useMemo(()=>a.flatMap(s=>s.markets),[a]),E=React.useCallback(s=>s&&m.some(c=>c.id===s)?s:m.length>0?m[0].id:F,[m]),j=React.useCallback(async()=>{l("loading"),p(null);try{const s=await fetch(`${G}/markets/`);if(!s.ok)throw new Error(`Market list request failed with status ${s.status}`);const c=await s.json(),x=Array.isArray(c)?c:c?.markets??[],R=x.flatMap(v=>v.markets),g=R.find(v=>v.id===W())?.id??R[0]?.id??F;n(x),C(v=>v===g?v:g),l("success")}catch(s){console.error("Failed to fetch market list",s),l("error"),p("Unable to load available markets. Please retry.")}},[G]),$=React.useCallback(async s=>{M("loading"),N(null);try{const c=await fetch(pe(s),{mode:"cors"});if(!c.ok)throw new Error(`Request failed with status ${c.status}`);const x=await c.json(),R=fe(x,new Date);b(R),M("success")}catch(c){console.error("Failed to fetch market",c),M("error"),N("We could not load market prices. Please retry.")}},[]);React.useEffect(()=>{j()},[j]),React.useEffect(()=>{$(h)},[$,h]),React.useEffect(()=>{if(typeof window>"u")return;const s=new URLSearchParams(window.location.search),c=s.get("marketId");if(h&&c!==h){s.set("marketId",h);const x=`${window.location.pathname}?${s.toString()}${window.location.hash}`;window.history.replaceState({},"",x)}},[h]),React.useEffect(()=>{const s=()=>{const c=W(),x=E(c);C(R=>R===x?R:x)};return window.addEventListener("popstate",s),()=>window.removeEventListener("popstate",s)},[E]),React.useEffect(()=>{if(m.length===0)return;const s=E(h);s!==h&&C(s)},[m,E,h]);const k=React.useMemo(()=>`https://www.betfair.com/exchange/plus/politics/market/${h}`,[h]),_=React.useMemo(()=>e?new Date(e.fetchedAt).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",weekday:"short",month:"short",day:"numeric"}):null,[e]),I=React.useMemo(()=>{if(!e)return null;const s=e.runners.map(g=>g.name),c=e.runners.map((g,v)=>g.name.startsWith("Others")?"#9aa0ae":B[v%B.length]),x=e.runners.map(g=>Math.max(0,g.probabilityMin??0)*100),R=e.runners.map(g=>{const v=Math.max(0,g.probabilityMin??0),O=Math.max(v,g.probabilityMax??v);return Math.max(0,O-v)*100});return{labels:s,datasets:[{label:"Minimum probability (%)",data:x,backgroundColor:c,borderColor:c,borderWidth:1,borderSkipped:!1,stack:"probability"},{label:"Spread from min to max (%)",data:R,backgroundColor:"#ffffff",borderColor:"#ffffff",borderWidth:1,borderRadius:{topRight:3,bottomRight:3,topLeft:0,bottomLeft:0},borderSkipped:!1,stack:"probability"}]}},[e]),S=React.useMemo(()=>{if(!e)return null;const s=e.runners.map(R=>(R.impliedProbability??0)*100),c=e.runners.reduce((R,g)=>{const v=(g.probabilityMax??0)*100;return v>R?v:R},0),x=Math.max(5,c);return{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,animation:!1,transitions:{active:{animation:{duration:0}},resize:{animation:{duration:0}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label(R){const g=e.runners[R.dataIndex],v=U(g.probabilityMin),O=U(g.probabilityMax);return`${g.name} — ${v} to ${O}`}}},valueLabel:{color:"#e8ecf5",impliedProbabilities:s}},scales:{x:{stacked:!0,grid:{color:"rgba(232, 236, 245, 0.50)"},ticks:{color:"#e8ecf5",callback:R=>`${R}%`},suggestedMax:x},y:{stacked:!0,grid:{display:!1},ticks:{color:R=>{const g=R.tick?.label;if(typeof g=="string"){if(g.startsWith(J))return"#ff3b30";if(g.startsWith("Others"))return"#9aa0ae"}return"#e8ecf5"},autoSkip:!1}}}}},[e]),P=React.useMemo(()=>{if(!e)return null;const s=e.runners.map(x=>x.name),c=e.runners.map((x,R)=>x.name.startsWith("Others")?"#9aa0ae":B[R%B.length]);return{labels:s,datasets:[{label:"Implied probability",data:e.runners.map(x=>(x.impliedProbability??0)*100),backgroundColor:c,borderWidth:0}]}},[e]),A=React.useMemo(()=>e?{animation:!1,transitions:{active:{animation:{duration:0}},resize:{animation:{duration:0}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label(s){const c=e.runners[s.dataIndex];return`${c.name}: ${U(c.impliedProbability)}`}}}}}:null,[e]),D=React.useMemo(()=>e?Math.max(320,e.runners.length*34):320,[e]),r=React.useMemo(()=>{if(!e)return"bar-empty";const s=e.runners.map(c=>c.id).join("-");return`${e.marketId}-${s}-${e.fetchedAt}`},[e]),d=React.useMemo(()=>{if(!e)return null;const s=e.runners.filter(R=>R.status==="ACTIVE"&&!R.name.startsWith("Others")).length,c=Math.max(0,e.activeRunnerCount-s),x=e.numberOfWinners-e.winnerRunnerCount;return[`${e.activeRunnerCount} still active`,c>0?` (${s} displayed + ${c} others below 1%)`:"",e.winnerRunnerCount>0?` + ${e.winnerRunnerCount} already won`:"",e.loserRunnerCount>0?` + ${e.loserRunnerCount} already lost`:"",e.winnerRunnerCount+e.loserRunnerCount>0?` = ${e.totalRunners} starters`:"",x>1?` ; ${x} winning spots left`:""].join("")},[e]),y=f==="loading"&&!e,u=e?.runners.length===0,w=e?.inplay??!1;return t.jsxs("div",{className:"arsenal-page",children:[t.jsx("header",{className:"arsenal-header",children:t.jsxs("div",{className:"arsenal-header__text",children:[t.jsx("h1",{children:"Odds"}),t.jsx("div",{className:"meta","aria-live":"polite",children:_?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"pill pill--good","aria-label":"Market status",children:e?.status??"Unknown"}),w&&t.jsx("span",{className:"pill pill--live","aria-label":"Market live",children:"LIVE"}),t.jsxs("span",{className:"timestamp",children:["Updated ",_]})]}):t.jsx("span",{className:"pill pill--muted",children:"Fetching market..."})}),t.jsxs("div",{className:"arsenal-header__controls",children:[t.jsx(be,{groups:a,selectedMarketId:h,onSelect:C,requestState:i}),t.jsx("div",{children:t.jsx("a",{href:k,target:"_blank",rel:"noreferrer noopener",children:"Original data"})}),d&&t.jsx("div",{className:"pill","aria-label":"Total runners",children:d})]})]})}),o&&t.jsxs("div",{className:"alert",role:"alert","aria-live":"assertive",children:[t.jsxs("div",{children:[t.jsx("p",{className:"alert__title",children:"Market list unavailable"}),t.jsx("p",{className:"alert__body",children:o})]}),t.jsx("button",{type:"button",className:"button button--ghost",onClick:()=>void j(),children:"Retry"})]}),L&&t.jsxs("div",{className:"alert",role:"alert","aria-live":"assertive",children:[t.jsxs("div",{children:[t.jsx("p",{className:"alert__title",children:"Price fetch failed"}),t.jsx("p",{className:"alert__body",children:L})]}),t.jsx("button",{type:"button",className:"button button--ghost",onClick:()=>void $(h),children:"Retry"})]}),t.jsx("section",{className:"cards",children:t.jsxs("div",{className:"card chart-card",children:[t.jsx("div",{className:"card__header",children:t.jsx("div",{children:t.jsx("h2",{children:"Probability"})})}),y&&t.jsx("div",{className:"skeleton-stack","aria-hidden":"true",children:Array.from({length:5}).map((s,c)=>t.jsx("div",{className:"skeleton-bar"},c))}),!y&&e&&!u&&t.jsxs("div",{className:"chart-grid",children:[t.jsx("div",{className:"chart-panel","aria-label":"Horizontal bar chart of implied probabilities",children:I&&t.jsx("div",{className:"chart-shell",role:"img","aria-label":"Implied probability bar chart",style:{height:`${D}px`},children:S&&t.jsx(oe,{data:I,options:S},r)})}),t.jsx("div",{className:"chart-panel","aria-label":"Pie chart of implied probabilities",children:P&&t.jsx("div",{className:"chart-shell",role:"img","aria-label":"Implied probability pie chart",children:A&&t.jsx(ie,{data:P,options:A})})})]}),!y&&u&&t.jsx("p",{className:"empty",role:"status",children:"No runners available right now."})]})})]})},ee=document.getElementById("root");if(!ee)throw new Error("Root element #root not found");ReactDOM.createRoot(ee).render(t.jsx(React.StrictMode,{children:t.jsx(xe,{})}));
