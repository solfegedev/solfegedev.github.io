import"./index-BvBwvoZY.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{A as y}from"./api-CH_Pe6Vg.js";import{B as I}from"./index-DU4OXEBq.js";Chart.Chart.register(Chart.CategoryScale,Chart.LinearScale,Chart.BarElement,Chart.Title,Chart.Tooltip,Chart.Legend);const M={id:"varWidth",beforeDatasetsDraw(s){const{scales:{x:h}}=s,n=s.getDatasetMeta(0),m=s.getDatasetMeta(1);[n,m].forEach(i=>{i.type==="bar"&&i.data.forEach((l,x)=>{const o=s.data.datasets[i.index].data[x];if(o&&o.start!==void 0&&o.end!==void 0){const c=h.getPixelForValue(o.start),g=h.getPixelForValue(o.end);l.x=(c+g)/2,l.width=Math.max(1,g-c-1)}})})}},v=s=>new Date(s).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}),W=()=>{const[s,h]=React.useState([]),[n,m]=React.useState(null),[i,l]=React.useState(""),[x,o]=React.useState(""),[c,g]=React.useState(new Date().toISOString().slice(0,16)),[O,D]=React.useState(!1),[S,w]=React.useState(null),f=React.useCallback(async()=>{D(!0);try{const t=await fetch(`${y}/electricity_meter/`);if(!t.ok)throw new Error("Failed to fetch readings");const a=await t.json();h(a)}catch(t){w(t instanceof Error?t.message:"An error occurred")}finally{D(!1)}},[]);React.useEffect(()=>{f()},[f]);const C=async t=>{if(t.preventDefault(),!i||!x||!c)return;const a={reading_day:parseFloat(i),reading_night:parseFloat(x),date:new Date(c).toISOString()};try{const r=n?`${y}/electricity_meter/${n}`:`${y}/electricity_meter/`;if(!(await fetch(r,{method:n?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error(`Failed to ${n?"update":"add"} reading`);l(""),o(""),m(null),f()}catch(r){w(r instanceof Error?r.message:"An error occurred")}},E=t=>{m(t.id),l(t.reading_day.toString()),o(t.reading_night.toString()),g(new Date(t.date).toISOString().slice(0,16))},_=()=>{m(null),l(""),o(""),g(new Date().toISOString().slice(0,16))},T=async t=>{try{if(!(await fetch(`${y}/electricity_meter/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete reading");f()}catch(a){w(a instanceof Error?a.message:"An error occurred")}},R=React.useMemo(()=>{if(s.length<2)return null;const t=[...s].sort((d,u)=>new Date(d.date).getTime()-new Date(u.date).getTime()),a=[],r=[];for(let d=0;d<t.length-1;d++){const u=t[d],j=t[d+1],b=new Date(u.date).getTime(),p=new Date(j.date).getTime(),N=(p-b)/(1e3*60*60*24);if(N>0){const A=(j.reading_day-u.reading_day)/N,$=(j.reading_night-u.reading_night)/N;a.push({x:(b+p)/2,y:A,start:b,end:p}),r.push({x:(b+p)/2,y:$,start:b,end:p})}}return{datasets:[{label:"Day Tariff (kWh/day)",data:a,backgroundColor:"rgba(251, 191, 36, 0.6)",borderColor:"rgba(251, 191, 36, 1)",borderWidth:1},{label:"Night Tariff (kWh/day)",data:r,backgroundColor:"rgba(79, 70, 229, 0.6)",borderColor:"rgba(79, 70, 229, 1)",borderWidth:1}]}},[s]);return e.jsx("div",{className:"flex items-center justify-center px-4 py-8 md:px-6 md:py-10 font-sans",children:e.jsxs("div",{className:"w-full max-w-5xl rounded-[32px] border border-slate-400/20 bg-slate-900/70 p-6 md:p-14 shadow-[0_25px_60px_rgba(2,6,23,0.8)] backdrop-blur-[18px]",children:[e.jsx("h1",{className:"text-4xl font-bold mb-8 text-center bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-amber-400",children:"Electricity Meter"}),S&&e.jsx("div",{className:"bg-red-500/20 border border-red-500/50 text-red-200 p-4 rounded-xl mb-6",children:S}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("section",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-800/50 p-6 rounded-2xl border border-slate-700",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:n?"Edit Reading":"Add New Reading"}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-amber-400/80 mb-1",children:"Day Reading (kWh)"}),e.jsx("input",{type:"number",step:"0.1",value:i,onChange:t=>l(t.target.value),className:"w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition-all",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-indigo-400/80 mb-1",children:"Night Reading (kWh)"}),e.jsx("input",{type:"number",step:"0.1",value:x,onChange:t=>o(t.target.value),className:"w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Date & Time"}),e.jsx("input",{type:"datetime-local",value:c,onChange:t=>g(t.target.value),className:"w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all",required:!0})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"submit",className:"flex-grow bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 rounded-lg transition-colors shadow-lg shadow-indigo-500/20",children:n?"Update Reading":"Save Reading"}),n&&e.jsx("button",{type:"button",onClick:_,className:"bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors",children:"Cancel"})]})]})]}),e.jsxs("div",{className:"bg-slate-800/50 p-6 rounded-2xl border border-slate-700",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"History"}),e.jsx("div",{className:"max-height-[300px] overflow-y-auto space-y-2 pr-2 custom-scrollbar",children:s.length===0?e.jsx("p",{className:"text-slate-500 text-center py-4",children:"No readings yet."}):s.sort((t,a)=>new Date(a.date).getTime()-new Date(t.date).getTime()).map(t=>e.jsxs("div",{className:`flex justify-between items-center p-3 rounded-lg border transition-all cursor-pointer ${n===t.id?"bg-indigo-600/20 border-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.2)]":"bg-slate-900/50 border-slate-700/50 hover:border-slate-500"}`,onClick:()=>E(t),children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-3 font-mono text-sm",children:[e.jsxs("span",{className:"text-amber-400",children:["D: ",t.reading_day]}),e.jsxs("span",{className:"text-indigo-400",children:["N: ",t.reading_night]})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:new Date(t.date).toLocaleString()})]}),e.jsx("button",{onClick:a=>{a.stopPropagation(),T(t.id)},className:"text-slate-600 hover:text-red-400 transition-colors p-2",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]})})]},t.id))})]})]}),e.jsxs("section",{className:"bg-slate-800/50 p-6 rounded-2xl border border-slate-700 flex flex-col",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Average Consumption"}),e.jsx("div",{className:"flex-grow flex items-center justify-center",children:R?e.jsx("div",{className:"w-full h-[400px]",children:e.jsx(I,{data:R,plugins:[M],options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{color:"#94a3b8"}},tooltip:{backgroundColor:"rgba(15, 23, 42, 0.9)",titleColor:"#94a3b8",bodyColor:"#f1f5f9",borderColor:"rgba(71, 85, 105, 0.5)",borderWidth:1,callbacks:{title:t=>{const r=t[0].raw;return`${v(new Date(r.start).toISOString())} - ${v(new Date(r.end).toISOString())}`},label:t=>{const a=t.dataset.label||"",r=t.parsed.y;return`${a}: ${r!==null?r.toFixed(2):"0.00"} kWh/day`}}}},scales:{y:{stacked:!0,beginAtZero:!0,grid:{color:"rgba(71, 85, 105, 0.2)"},ticks:{color:"#94a3b8"}},x:{type:"linear",stacked:!0,grid:{display:!1},ticks:{color:"#94a3b8",maxRotation:45,minRotation:45,callback:t=>v(new Date(t).toISOString())}}}}})}):e.jsx("div",{className:"text-center text-slate-500",children:e.jsx("p",{children:"Add at least two readings to see the graph."})})})]})]}),e.jsx("div",{className:"mt-8 text-center",children:e.jsx("a",{href:"/menuall/",className:"text-indigo-400 hover:text-indigo-300 text-sm font-medium transition-colors",children:"‚Üê Back to Menu"})})]})})},k=document.getElementById("root");k&&ReactDOM.createRoot(k).render(e.jsx(React.StrictMode,{children:e.jsx(W,{})}));
