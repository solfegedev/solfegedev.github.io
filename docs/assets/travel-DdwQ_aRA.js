import"./index-Cm_Ydr0l.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{u as Te,T as ft}from"./Toast-COaeoAQl.js";import{A as X}from"./api-CH_Pe6Vg.js";import{c as Ze,a as he}from"./button-D6DGr86I.js";import{A as bt,P as Ne}from"./Auth-uEj7rJlD.js";import{X as Ce}from"./x-BS-d4QNZ.js";import{T as Ee}from"./trash-2-DQbJ9aIh.js";import{c as V}from"./createLucideIcon-DtX1aPOG.js";import{C as vt}from"./chevron-down-3_LVzg6l.js";import{M as ze}from"./map-pin-BZQ0wcyB.js";import{L as ae}from"./LayersControl-bsTFKbeJ.js";import{c as yt,b as jt,e as wt,T as pe,M as _t,P as Be,a as He,u as ge,d as Nt}from"./TileLayer-KcMz5fwj.js";import{M as me}from"./map-BMvedaBo.js";import{P as We}from"./pencil-DHu_drsE.js";import{D as kt,U as St}from"./upload--Rbr-3Yq.js";import{S as Ct}from"./settings-G074OJw9.js";import{L as $t}from"./list-BhDG0LsZ.js";import{U as Mt}from"./users-IjmMAbyY.js";import{L as Rt}from"./log-out-B0TqtotO.js";import{C as Tt}from"./copy-CzC7y2Qs.js";import{G as Et}from"./grip-vertical-BjGCJcsX.js";import"./circle-check-F4iM422t.js";import"./clsx-B-dksMZM.js";import"./eye-Jn_UhOO1.js";const zt=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],Pt=V("activity",zt);const At=[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]],Dt=V("arrow-up-down",At);const Lt=[["path",{d:"M2 4v16",key:"vw9hq8"}],["path",{d:"M2 8h18a2 2 0 0 1 2 2v10",key:"1dgv2r"}],["path",{d:"M2 17h20",key:"18nfp3"}],["path",{d:"M6 8v9",key:"1yriud"}]],Ft=V("bed",Lt);const Ot=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],Ut=V("camera",Ot);const Bt=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],Ht=V("chevron-up",Bt);const Vt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],$e=V("circle-plus",Vt);const Gt=[["path",{d:"m14 15-5 5-5-5",key:"1eia93"}],["path",{d:"M20 4h-7a4 4 0 0 0-4 4v12",key:"nbpdq2"}]],It=V("corner-left-down",Gt);const Zt=[["path",{d:"m15 14 5-5-5-5",key:"12vg1m"}],["path",{d:"M4 20v-7a4 4 0 0 1 4-4h12",key:"1lu4f8"}]],Wt=V("corner-up-right",Zt);const Yt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"22",x2:"18",y1:"12",y2:"12",key:"l9bcsi"}],["line",{x1:"6",x2:"2",y1:"12",y2:"12",key:"13hhkx"}],["line",{x1:"12",x2:"12",y1:"6",y2:"2",key:"10w3f3"}],["line",{x1:"12",x2:"12",y1:"22",y2:"18",key:"15g9kq"}]],qt=V("crosshair",Yt);const Jt=[["path",{d:"M10 18v-7",key:"wt116b"}],["path",{d:"M11.12 2.198a2 2 0 0 1 1.76.006l7.866 3.847c.476.233.31.949-.22.949H3.474c-.53 0-.695-.716-.22-.949z",key:"1m329m"}],["path",{d:"M14 18v-7",key:"vav6t3"}],["path",{d:"M18 18v-7",key:"aexdmj"}],["path",{d:"M3 22h18",key:"8prr45"}],["path",{d:"M6 18v-7",key:"1ivflk"}]],Xt=V("landmark",Jt);const Kt=[["path",{d:"M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z",key:"1v9wt8"}]],Qt=V("plane",Kt);const es=[["path",{d:"M8 3.1V7a4 4 0 0 0 8 0V3.1",key:"1v71zp"}],["path",{d:"m9 15-1-1",key:"1yrq24"}],["path",{d:"m15 15 1-1",key:"1t0d6s"}],["path",{d:"M9 19c-2.8 0-5-2.2-5-5v-4a8 8 0 0 1 16 0v4c0 2.8-2.2 5-5 5Z",key:"1p0hjs"}],["path",{d:"m8 19-2 3",key:"13i0xs"}],["path",{d:"m16 19 2 3",key:"xo31yx"}]],ts=V("train-front",es);const ss=[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]],as=V("utensils",ss),Ve=yt(function({positions:r,...g},i){const b=new L.Polyline(r,g);return jt(b,wt(i,{overlayContainer:b}))},function(r,g,i){g.positions!==i.positions&&r.setLatLngs(g.positions)}),ns=({auth:c,onClose:r})=>{const{warningToast:g}=Te(),[i,b]=React.useState([]),[N,f]=React.useState(!0),[u,v]=React.useState(""),[x,y]=React.useState(""),[k,T]=React.useState(""),[w,M]=React.useState(""),[S,O]=React.useState("user"),[U,E]=React.useState(null),P=async()=>{try{const h=await fetch(`${X}/travel/admin/users`,{headers:{Authorization:`Bearer ${c.access_token}`}});if(!h.ok)throw new Error("Failed to fetch users");const C=await h.json();b(C)}catch(h){console.error("Failed to fetch users",h)}finally{f(!1)}};React.useEffect(()=>{P()},[c]);const o=async h=>{h.preventDefault(),E(null);try{const C=await fetch(`${X}/travel/admin/users`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({email:u,password:x,role:S,first_name:k,last_name:w})}),W=await C.json();if(!C.ok)throw new Error(W.detail||"Failed to create user");b([...i,W]),v(""),y(""),T(""),M("")}catch(C){E(C.message)}},A=async h=>{if(h===c.user.id){g("You cannot delete yourself.");return}if(confirm("Are you sure? All their trips will be lost."))try{if(!(await fetch(`${X}/travel/admin/users/${h}`,{method:"DELETE",headers:{Authorization:`Bearer ${c.access_token}`}})).ok)throw new Error("Failed to delete user");b(i.filter(W=>W.id!==h))}catch(C){console.error("Failed to delete user",C)}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"flex max-h-[90vh] w-full max-w-4xl flex-col overflow-hidden rounded-2xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-slate-100 p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:"User Management"}),e.jsx("button",{onClick:r,className:"text-slate-400 hover:text-slate-600",children:e.jsx(Ce,{size:24})})]}),e.jsxs("div",{className:"flex-1 space-y-8 overflow-y-auto p-6",children:[e.jsxs("section",{children:[e.jsx("h3",{className:"mb-4 text-lg font-bold text-slate-800",children:"Add New User"}),e.jsxs("form",{onSubmit:o,className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx("input",{type:"email",placeholder:"Email",required:!0,autoComplete:"email",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:u,onChange:h=>v(h.target.value)}),e.jsx("input",{type:"password",placeholder:"Password",required:!0,autoComplete:"new-password",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:x,onChange:h=>y(h.target.value)}),e.jsx("input",{type:"text",placeholder:"First Name",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:k,onChange:h=>T(h.target.value)}),e.jsx("input",{type:"text",placeholder:"Last Name",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:w,onChange:h=>M(h.target.value)}),e.jsxs("select",{className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:S,onChange:h=>O(h.target.value),children:[e.jsx("option",{value:"user",children:"User"}),e.jsx("option",{value:"admin",children:"Admin"})]}),e.jsx("button",{type:"submit",className:"rounded-lg bg-indigo-600 py-2 font-bold text-white hover:bg-indigo-700",children:"Create User"})]}),U&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:U})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"mb-4 text-lg font-bold text-slate-800",children:"Existing Users"}),N?e.jsx("p",{children:"Loading..."}):e.jsx("div",{className:"overflow-hidden rounded-xl border border-slate-100",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"border-b border-slate-100 bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-sm font-bold text-slate-600",children:"User"}),e.jsx("th",{className:"px-4 py-3 text-sm font-bold text-slate-600",children:"Role"}),e.jsx("th",{className:"px-4 py-3 text-sm font-bold text-slate-600",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-bold text-slate-600",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:i.map(h=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-slate-900",children:h.email}),e.jsxs("div",{className:"text-xs text-slate-500",children:[h.first_name," ",h.last_name]})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`rounded px-2 py-0.5 text-[10px] font-bold uppercase ${h.role==="admin"?"bg-indigo-100 text-indigo-700":"bg-blue-100 text-blue-700"}`,children:h.role})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("span",{className:`flex items-center gap-1.5 text-xs ${h.is_active?"text-amber-600":"text-red-600"}`,children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${h.is_active?"bg-amber-500":"bg-red-500"}`}),h.is_active?"Active":"Inactive"]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:h.id!==c.user.id&&e.jsx("button",{onClick:()=>A(h.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Ee,{size:18})})})]},h.id))})]})})]})]})]})})},Me=({text:c,className:r,textClassName:g,maxLines:i=3,badge:b})=>{const[N,f]=React.useState(!1),[u,v]=React.useState(!1),x=React.useRef(null);return React.useEffect(()=>{const y=()=>{if(x.current){const k=x.current.cloneNode(!0);k.style.webkitLineClamp="unset",k.style.display="block",k.style.visibility="hidden",k.style.position="absolute",k.style.width=`${x.current.clientWidth}px`,document.body.appendChild(k);const T=k.scrollHeight,w=x.current.cloneNode(!0);w.style.webkitLineClamp=i.toString(),w.style.display="-webkit-box",w.style.webkitBoxOrient="vertical",w.style.visibility="hidden",w.style.position="absolute",w.style.width=`${x.current.clientWidth}px`,document.body.appendChild(w);const M=w.clientHeight;document.body.removeChild(k),document.body.removeChild(w),v(T>M)}};return y(),window.addEventListener("resize",y),()=>window.removeEventListener("resize",y)},[c,i]),c?e.jsxs("div",{className:r,children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[b,e.jsx("div",{ref:x,className:Ze("whitespace-pre-line",!N&&"overflow-hidden",g),style:N?{display:"block"}:{display:"-webkit-box",WebkitLineClamp:i,WebkitBoxOrient:"vertical"},children:c})]}),u&&e.jsx("button",{onClick:y=>{y.stopPropagation(),f(!N)},className:"mt-0.5 flex items-center gap-1 text-[10px] font-bold text-slate-400 uppercase hover:text-slate-500",children:N?e.jsxs(e.Fragment,{children:[e.jsx(Ht,{size:12}),"Show Less"]}):e.jsxs(e.Fragment,{children:[e.jsx(vt,{size:12}),"Show More"]})})]}):null},Re=12,Ye=[51.477,0],qe=2,J=`${X}/travel/trips`,ie=[{id:"hotel",label:"Hotel",icon:Ft},{id:"restaurant",label:"Restaurant",icon:as},{id:"museum",label:"Museum",icon:Xt},{id:"airport",label:"Airport",icon:Qt},{id:"station",label:"Station",icon:ts},{id:"sightseeing",label:"Sightseeing",icon:Ut},{id:"activity",label:"Activity",icon:Pt},{id:"other",label:"Other",icon:ze}],Je=(c,r,g)=>{if(!c||!c.includes("booking.com"))return c;try{const i=new URL(c);return i.searchParams.set("group_adults","1"),i.searchParams.set("no_rooms","1"),r&&i.searchParams.set("checkin",r),g&&i.searchParams.set("checkout",g),i.toString()}catch{return c}},os=c=>{const r=c.filter(f=>!f.parent_id),g=c.reduce((f,u)=>(u.parent_id&&(f[u.parent_id]||(f[u.parent_id]=[]),f[u.parent_id].push(u)),f),{}),i=(f,u)=>f.date!==u.date?f.date?u.date?f.date.localeCompare(u.date):-1:1:f.time!==u.time?f.time?u.time?f.time.localeCompare(u.time):-1:1:0,b=[],N=f=>{[...f].sort(i).forEach(v=>{b.push(v);const x=g[v.id]||[];x.length>0&&N(x)})};return N(r),b},rs=({polylinePoints:c,spokeLines:r})=>e.jsxs(ae,{position:"topright",children:[e.jsx(ae.BaseLayer,{checked:!0,name:"Map",children:e.jsx(pe,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:19})}),e.jsx(ae.BaseLayer,{name:"3D Terrain",children:e.jsx(pe,{attribution:'<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",maxZoom:20})}),e.jsx(ae.BaseLayer,{name:"3D topography",children:e.jsx(pe,{attribution:'Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",maxZoom:17})}),e.jsx(ae.BaseLayer,{name:"Satellite",children:e.jsx(pe,{attribution:"Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, GIS",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})}),c.length>1&&e.jsx(ae.Overlay,{checked:!0,name:"Show Route",children:e.jsx(Ve,{positions:c,color:"var(--color-red-600)",weight:5,opacity:.8,dashArray:"10, 10"})}),r.length>0&&e.jsx(ae.Overlay,{checked:!0,name:"Show Activities",children:e.jsx(Ve,{positions:r,color:"var(--color-green-600)",weight:3,opacity:.8,dashArray:"5, 5"})})]}),ke=ie.reduce((c,r)=>({...c,[r.id]:r.icon}),{}),ls=ie.reduce((c,r)=>({...c,[r.id]:r.label}),{}),ue={hotel:'<path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/>',restaurant:'<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/>',museum:'<line x1="3" y1="22" x2="21" y2="22"/><line x1="6" y1="18" x2="6" y2="11"/><line x1="10" y1="18" x2="10" y2="11"/><line x1="14" y1="18" x2="14" y2="11"/><line x1="18" y1="18" x2="18" y2="11"/><polyline points="12 2 20 7 4 7 12 2"/>',airport:'<path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/>',station:'<path d="M4 3h16a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/><path d="M6 8h12"/><path d="m16.8 22-1.5-3"/><path d="m7.2 22 1.5-3"/><path d="M2 13h20"/><circle cx="12" cy="16" r="2"/>',sightseeing:'<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>',activity:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',other:'<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>'},xe={duration:0},Ge=(c,r,g,i)=>{const b=g&&ue[g]?ue[g]:ue.other,N=g&&ue[g]?g:"map-pin",f=String(c),u=i?1.2:1,v=(f.length>2?50:42)*u,x=32*u,y=v,k=x,T=14*u,w=(f.length>3?10:12)*u,M=`<svg width="${T}" height="${T}" viewBox="0 0 24 24" fill="none" stroke="${r}" stroke-width="${i?3:2.5}" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-${N}">${b}</svg>`,S=`
    <div style="position: relative; width: ${y}px; height: ${k}px;">
      <svg width="${y}" height="${k}" viewBox="0 0 ${v} ${x}" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
        <!-- Horizontal Oval/Pill shape with a bottom point -->
        <path d="M ${v/2} ${x} L ${v/2-6} ${x-6} H 12 A 12 12 0 0 1 12 2 H ${v-12} A 12 12 0 0 1 ${v-12} 26 H ${v/2+6} Z" fill="${r}"/>
        <!-- Inner white pill -->
        <rect x="3" y="3" width="${v-6}" height="${x-12}" rx="9" fill="white"/>
      </svg>
      <div style="position: absolute; top: ${k/2-3}px; left: ${y/2}px; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; gap: 4px; width: ${y-10}px;">
        <div style="display: flex; align-items: center; justify-content: center; height: ${T}px;">${M}</div>
        <div style="font-size: ${w}px; font-weight: 900; color: ${r}; line-height: 1;">
          ${c}
        </div>
      </div>
    </div>
  `;return L.divIcon({html:S,className:"custom-div-icon",iconSize:[y,k],iconAnchor:[y/2,k],popupAnchor:[0,-k]})},Q=c=>typeof c.lat=="number"&&Number.isFinite(c.lat)&&typeof c.lng=="number"&&Number.isFinite(c.lng),is=({items:c,onClearSelection:r})=>{const g=ge();return React.useEffect(()=>{const i=new L.Control({position:"topleft"});return i.onAdd=()=>{const b=L.DomUtil.create("div","leaflet-bar leaflet-control"),N=L.DomUtil.create("a","leaflet-control-reset",b);return N.innerHTML='<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: block; margin: 0 auto;"><path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8M3 16.2V21m0 0h4.8M3 21l6-6M21 7.8V3m0 0h-4.8M21 3l-6 6M3 7.8V3m0 0h4.8M3 3l6 6"/></svg>',N.href="#",N.title="Reset View",N.style.backgroundColor="white",N.style.cursor="pointer",L.DomEvent.on(N,"click",f=>{L.DomEvent.stop(f),r();const u=c.filter(v=>Q(v)&&!v.hide_from_map);if(u.length>0){const v=L.latLngBounds(u.map(x=>[x.lat,x.lng]));g.flyToBounds(v,{...xe,padding:[50,50],maxZoom:Re})}else g.flyTo(Ye,qe,xe)}),b},g.addControl(i),()=>{g.removeControl(i)}},[g,c,r]),null},ds=({isCollapsed:c})=>{const r=ge();return React.useEffect(()=>{if(!c){const g=setTimeout(()=>{r.invalidateSize()},100);return()=>clearTimeout(g)}},[c,r]),null},cs=({tripId:c,items:r,selectedItem:g,isCollapsed:i})=>{const b=ge(),N=React.useRef(void 0),f=React.useRef(void 0),u=React.useRef(i),v=React.useRef(void 0);return React.useEffect(()=>{if(i){u.current=i;return}const x=b.getContainer();if(x.clientWidth===0||x.clientHeight===0)return;const y=g?.id??null,k=f.current!==c,T=N.current!==y,w=u.current===!0&&i===!1,M=r.length>0&&v.current!==c;if(k||T||w||M){const O=setTimeout(()=>{if(g&&r.some(E=>E.id===g.id)&&g&&Q(g))try{const E=b.getZoom(),P=Math.max(E,Re);b.flyTo([g.lat,g.lng],P,xe),(M||w)&&(v.current=c)}catch(E){console.error("Failed to fly to selected item",E)}else if(k||w||M||T&&!g){const E=r.filter(P=>Q(P)&&!P.hide_from_map);if(E.length>0)try{const P=L.latLngBounds(E.map(o=>[o.lat,o.lng]));b.flyToBounds(P,{...xe,padding:[50,50],maxZoom:Re}),v.current=c}catch(P){console.error("Failed to fly to bounds",P)}}N.current=y,f.current=c,u.current=i},w?150:0);return()=>clearTimeout(O)}},[r,g,c,b,i]),null},ps=({isSelecting:c})=>{const r=ge();return React.useEffect(()=>{c?r.getContainer().style.cursor="crosshair":r.getContainer().style.cursor=""},[c,r]),null},us=({onLocationSelect:c,onMapClick:r,isSelectingLocation:g})=>(Nt({click(i){g&&c?c(i.latlng.lat,i.latlng.lng):r&&r(i.latlng.lat,i.latlng.lng)}}),null);function hs({tripId:c,items:r,selectedItem:g,editingItemId:i,editingItemLocation:b,onSelectItem:N,onEdit:f,onLocationSelect:u,onAddAtLocation:v,onCancelLocationSelect:x,isSelectingLocation:y,isCollapsed:k,isReadOnly:T}){const[w,M]=React.useState(null),S=React.useMemo(()=>r.filter(o=>!o.parent_id),[r]),O=React.useMemo(()=>S.filter(o=>o.is_connected),[S]),U=O.length,E=React.useMemo(()=>O.filter(o=>Q(o)&&!o.hide_from_map).map(o=>[o.lat,o.lng]),[O]),P=React.useMemo(()=>{const o=[];return r.forEach(A=>{if(A.parent_id&&Q(A)&&!A.hide_from_map){const h=r.find(C=>C.id===A.parent_id);h&&Q(h)&&!h.hide_from_map&&o.push([[h.lat,h.lng],[A.lat,A.lng]])}}),o},[r]);return e.jsxs("div",{className:"relative z-0 h-full w-full overflow-hidden rounded-lg border border-slate-200",children:[e.jsxs(_t,{center:Ye,zoom:qe,zoomSnap:0,zoomDelta:.1,wheelPxPerZoomLevel:120,scrollWheelZoom:!0,doubleClickZoom:!1,className:"h-full w-full",attributionControl:!1,children:[e.jsx(ds,{isCollapsed:k}),e.jsx(rs,{polylinePoints:E,spokeLines:P}),e.jsx(cs,{tripId:c,items:r,selectedItem:g,isCollapsed:k}),e.jsx(ps,{isSelecting:!!y}),e.jsx(is,{items:r,onClearSelection:()=>N(null)}),e.jsx(us,{onLocationSelect:u,onMapClick:(o,A)=>M([o,A]),isSelectingLocation:y}),w&&e.jsx(Be,{position:w,eventHandlers:{remove:()=>M(null)},minWidth:0,className:"map-click-popup",children:e.jsxs("div",{className:"flex w-max flex-col gap-1 p-0.5",children:[!T&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{v?.(w[0],w[1],"next"),M(null)},className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-xs font-bold whitespace-nowrap text-slate-700 transition-colors hover:bg-slate-100",children:[e.jsx($e,{size:14,className:"text-indigo-600"}),"Add as next item"]}),e.jsxs("button",{onClick:()=>{v?.(w[0],w[1],"child"),M(null)},className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-xs font-bold whitespace-nowrap text-slate-700 transition-colors hover:bg-slate-100 disabled:opacity-50 disabled:hover:bg-transparent",disabled:!g,title:g?"":"Select an item first to add a child",children:[e.jsx($e,{size:14,className:"text-green-600"}),"Add as child"]})]}),e.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${w[0]},${w[1]}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-xs font-bold whitespace-nowrap text-slate-700 transition-colors hover:bg-slate-100",children:[e.jsx(me,{size:14,className:"text-amber-500"}),"Google Maps"]})]})}),r.map(o=>{let A=o.lat,h=o.lng,C=o.category;const W=o.id===i;if(W&&b){if(b.hide_from_map)return null;A=b.lat,h=b.lng,C=b.category||o.category}else if(o.hide_from_map)return null;if(!Q({lat:A,lng:h}))return null;const H=o.id===g?.id||W,Y=!!o.parent_id,fe=H?"var(--color-red-600)":Y?"var(--color-green-600)":o.is_connected?"var(--color-indigo-500)":"var(--color-amber-500)";let ne="•";if(Y){const F=r.find(G=>G.id===o.parent_id);if(F){const G=S.findIndex(B=>B.id===F.id);if(G!==-1){const B=F.is_connected?G+1:String.fromCharCode(65+(G-U)),de=r.filter(q=>q.parent_id===o.parent_id).findIndex(q=>q.id===o.id);de!==-1&&(ne=`${B}.${de+1}`)}}}else{const F=S.findIndex(G=>G.id===o.id);F!==-1&&(ne=o.is_connected?F+1:String.fromCharCode(65+(F-U)))}return e.jsx(He,{position:[A,h],icon:Ge(ne,fe,C,H),eventHandlers:{click:()=>N(o)},children:e.jsx(Be,{maxWidth:2e3,children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"mb-1 flex items-center gap-2",children:[C&&ke[C]&&e.jsx("div",{className:Y?"text-green-600":o.is_connected?"text-indigo-500":"text-amber-500",children:(()=>{const F=ke[C];return e.jsx(F,{size:14})})()}),e.jsx("h3",{className:"font-bold",children:o.location}),e.jsx("div",{className:"ml-auto flex items-center gap-1.5",children:o.is_tba&&e.jsx("span",{className:"shrink-0 rounded border border-green-200 bg-green-100 px-1 py-0.5 text-[10px] font-bold tracking-wider text-green-700 uppercase",children:"TBA"})})]}),(o.date||o.time||o.date_departure||o.time_departure)&&e.jsxs("div",{className:"text-[11px] font-bold tracking-wider text-slate-500 uppercase",children:[[o.date?he(o.date,!0):null,o.time?o.time.substring(0,5):null].filter(Boolean).join(" @ "),(o.date_departure||o.time_departure)&&e.jsxs(e.Fragment,{children:[" → ",[o.date_departure?he(o.date_departure):null,o.time_departure?o.time_departure.substring(0,5):null].filter(Boolean).join(" @ ")]})]}),o.description&&e.jsx(Me,{text:o.description,className:"mt-1",textClassName:"text-sm text-slate-600"}),(o.url_booking||o.url_map||f)&&e.jsxs("div",{className:"mt-2 flex gap-2",children:[f&&e.jsx("button",{onClick:F=>{F.stopPropagation(),f(o)},className:"rounded-md bg-indigo-100 p-1 text-indigo-400 text-slate-400 transition-colors hover:text-indigo-600",title:"Edit",children:e.jsx(We,{size:14})}),o.url_booking&&e.jsx("a",{href:Je(o.url_booking,o.date,o.date_departure),target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 rounded border border-blue-500 bg-blue-50 px-2 py-0.5 text-[10px] font-bold !text-blue-800 uppercase transition-colors hover:!text-blue-900",children:(()=>{const F=o.category&&ke[o.category]||ze,G=o.category&&ls[o.category]||"Other";return e.jsxs(e.Fragment,{children:[e.jsx(F,{size:10}),G]})})()}),o.url_map&&e.jsxs("a",{href:o.url_map,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 rounded border border-amber-500 bg-amber-50 px-2 py-0.5 text-[10px] font-bold !text-amber-600 uppercase transition-colors hover:!text-amber-800",children:[e.jsx(me,{size:10}),"Google Map"]})]})]})})},o.id)}),!i&&b&&!b.hide_from_map&&Q(b)&&e.jsx(He,{position:[b.lat,b.lng],icon:Ge(String.fromCharCode(65+(S.length-U)),"var(--color-amber-500)",b.category,!0)})]}),y&&e.jsxs("div",{className:"absolute top-4 left-1/2 z-[1000] flex -translate-x-1/2 flex-col items-center gap-2",children:[e.jsx("div",{className:"rounded-full border border-indigo-200 bg-white px-4 py-2 text-sm font-bold text-indigo-600 shadow-lg",children:"Select new location on map"}),x&&e.jsx("button",{onClick:o=>{o.stopPropagation(),x()},className:"rounded-full border border-slate-200 bg-white px-4 py-1.5 text-xs font-bold text-slate-500 shadow-md transition-all hover:bg-slate-50",children:"Cancel"})]})]})}const ms=({auth:c,trip:r,onUpdate:g,onDelete:i,onExport:b,onImport:N,onClose:f})=>{const{infoToast:u}=Te(),[v,x]=React.useState(""),[y,k]=React.useState(r.collaborator_emails||[]),[T,w]=React.useState(!1),[M,S]=React.useState(null),O=c.user.id===r.user_id,U=h=>{if(h.preventDefault(),!!v.trim()){if(y.includes(v.trim())){S("User already added");return}k([...y,v.trim()]),x(""),S(null)}},E=h=>{k(y.filter(C=>C!==h))},P=async()=>{w(!0),S(null);try{const h=await fetch(`${X}/travel/trips/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({collaborator_emails:y})}),C=await h.json();if(!h.ok)throw new Error(C.detail||"Failed to update collaborators");g(C),f()}catch(h){S(h.message)}finally{w(!1)}},o=`${window.location.origin}${window.location.pathname}?share_token=${r.share_token}`,A=()=>{navigator.clipboard.writeText(o),u("Copied to clipboard!")};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"flex w-full max-w-md flex-col overflow-hidden rounded-2xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-slate-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900","data-testid":"share-trip-modal-heading",children:"Trip Settings"}),e.jsx("button",{onClick:f,className:"text-slate-400 hover:text-slate-600",children:e.jsx(Ce,{size:24})})]}),e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("section",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Public Share Link"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{readOnly:!0,"data-testid":"share-link-input",className:"flex-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-500 outline-none",value:o}),e.jsx("button",{onClick:A,className:"rounded-lg bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600 hover:bg-slate-200",children:"Copy"})]}),e.jsx("p",{className:"mt-1 text-[10px] text-slate-400",children:"Anyone with this link can view the trip (read-only)."})]}),e.jsxs("section",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Collaborators"}),e.jsx("p",{className:"mb-3 text-xs text-slate-500",children:"Add other users to give them editing rights."}),e.jsxs("form",{onSubmit:U,className:"mb-4 flex gap-2",children:[e.jsx("input",{type:"email",autoComplete:"email",placeholder:"user@example.com",className:"flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500",value:v,onChange:h=>x(h.target.value)}),e.jsx("button",{type:"submit",className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-bold text-white hover:bg-indigo-700",children:"Add"})]}),e.jsxs("div",{className:"max-h-40 space-y-2 overflow-y-auto pr-2",children:[y.length===0&&e.jsx("p",{className:"text-sm text-slate-400 italic",children:"No collaborators yet."}),y.map(h=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg bg-slate-50 px-3 py-2",children:[e.jsx("span",{className:"truncate text-sm text-slate-700",children:h}),e.jsx("button",{onClick:()=>E(h),className:"text-slate-400 hover:text-red-500",children:e.jsx(Ce,{size:16})})]},h))]})]}),e.jsxs("section",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Data Management"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:b,className:"flex flex-1 items-center justify-center gap-2 rounded-lg bg-slate-100 py-2.5 text-sm font-bold text-slate-600 transition-all hover:bg-slate-200","data-testid":"export-trip-button-modal",children:[e.jsx(kt,{size:18}),"Export YAML"]}),e.jsxs("button",{onClick:N,className:"flex flex-1 items-center justify-center gap-2 rounded-lg bg-slate-100 py-2.5 text-sm font-bold text-slate-600 transition-all hover:bg-slate-200","data-testid":"import-trip-button-modal",children:[e.jsx(St,{size:18}),"Import YAML"]})]}),e.jsx("p",{className:"mt-1 text-[10px] text-slate-400",children:"Backup your trip or restore it from a YAML file."})]}),M&&e.jsx("p",{className:"text-sm text-red-500",children:M})]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 border-t border-slate-100 bg-slate-50 p-6",children:[e.jsx("div",{children:O&&e.jsxs("button",{onClick:()=>{i(r.id),f()},className:"flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-bold text-red-500 transition-colors hover:bg-red-50","data-testid":"delete-trip-button-modal",children:[e.jsx(Ee,{size:18}),"Delete Trip"]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:f,className:"px-4 py-2 text-sm font-bold text-slate-600 hover:text-slate-800",children:"Cancel"}),e.jsx("button",{onClick:P,disabled:T,className:"rounded-lg bg-indigo-600 px-6 py-2 text-sm font-bold text-white hover:bg-indigo-700 disabled:opacity-50",children:T?"Saving...":"Save Changes"})]})]})]})})},Se=({className:c,variant:r="slate",children:g,...i})=>{const b={slate:"bg-slate-100 text-slate-600 hover:bg-slate-200",indigo:"bg-indigo-600 text-white hover:bg-indigo-700","indigo-light":"bg-indigo-50 text-indigo-700 hover:bg-indigo-100"};return e.jsx("button",{className:Ze("flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold transition-all",b[r],c),...i,children:g})},xs=()=>{const{successToast:c,errorToast:r,infoToast:g}=Te(),[i,b]=React.useState(null),[N,f]=React.useState([]),[u,v]=React.useState(()=>{const t=localStorage.getItem("travel_selected_trip_id");return t?Number(t):null});React.useEffect(()=>{u!==null?localStorage.setItem("travel_selected_trip_id",String(u)):localStorage.removeItem("travel_selected_trip_id")},[u]);const[x,y]=React.useState([]),[k,T]=React.useState(!0),[w,M]=React.useState(null),[S,O]=React.useState(null),[U,E]=React.useState(!1),[P,o]=React.useState(!1),[A,h]=React.useState(!1),[C,W]=React.useState(""),[H,Y]=React.useState(null),[fe,ne]=React.useState(!1),[F,G]=React.useState(!1),[B,be]=React.useState(null),[de,q]=React.useState(null),[z,Pe]=React.useState(!1),[Xe,K]=React.useState(""),oe=React.useRef(null),ce=React.useRef(null),ee=React.useRef(null),Ae=React.useRef(x),te=React.useRef(null);React.useEffect(()=>{Ae.current=x},[x]),React.useEffect(()=>{let t;if(B!==null){const a=n=>{ee.current={y:n.clientY}};return window.addEventListener("dragover",a,!0),window.addEventListener("mousemove",a,!0),window.addEventListener("pointermove",a,!0),t=window.setInterval(()=>{if(!ce.current||!ee.current)return;const n=ce.current.getBoundingClientRect(),l=ee.current.y-n.top,p=n.height*.2;if(l<p&&l>=-50){const d=Math.max(2,(1-l/p)*12);ce.current.scrollTop-=d}else if(l>n.height-p&&l<=n.height+50){const d=l-(n.height-p),s=Math.max(2,d/p*12);ce.current.scrollTop+=s}},16),()=>{t&&clearInterval(t),window.removeEventListener("dragover",a,!0),window.removeEventListener("mousemove",a,!0),window.removeEventListener("pointermove",a,!0)}}},[B]),React.useEffect(()=>{if(S){const t=document.getElementById(`travel-item-${S.id}`);t&&t.scrollIntoView({block:"nearest"})}},[S]);const[m,R]=React.useState({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!1,parent_id:null}),ve=new URLSearchParams(window.location.search).get("share_token"),D=!!ve;React.useEffect(()=>{const t=localStorage.getItem("travel_auth")||sessionStorage.getItem("travel_auth");if(t)try{b(JSON.parse(t))}catch{localStorage.removeItem("travel_auth"),sessionStorage.removeItem("travel_auth")}},[]);const Ke=(t,a)=>{b(t),a?localStorage.setItem("travel_auth",JSON.stringify(t)):sessionStorage.setItem("travel_auth",JSON.stringify(t))},ye=async()=>{try{await fetch(`${X}/bookmarks/logout`,{method:"POST",credentials:"include"})}catch(t){console.error("Logout API call failed",t)}b(null),localStorage.removeItem("travel_auth"),sessionStorage.removeItem("travel_auth"),f([]),y([])},I=React.useCallback(async(t,a={})=>{const n={...a.headers||{},...i?{Authorization:`Bearer ${i.access_token}`}:{}};return fetch(t,{...a,headers:n,credentials:"include"})},[i]),De=React.useCallback(async()=>{if(!(D||!i))try{const t=await I(J);if(t.status===401){ye();return}if(!t.ok)throw new Error("Failed to fetch trips");const a=await t.json();f(a),a.length>0?(u===null||!a.some(n=>n.id===u))&&v(a[0].id):v(null)}catch(t){console.error(t)}},[u,D,i,I]),Le=React.useCallback(async()=>{if(D){T(!0);try{const t=await fetch(`${X}/travel/shared/${ve}`);if(!t.ok)throw new Error("Failed to fetch shared trip");const a=await t.json();f([a.trip]),v(a.trip.id);const n=a.items.map((l,p)=>({...l,is_connected:p<a.trip.active_count}));y(n),M(null)}catch(t){M("Failed to load shared itinerary. It may have been deleted or the link is invalid."),console.error(t)}finally{T(!1)}return}if(!i||u===null){y([]),T(!1);return}T(!0);try{const t=await I(`${J}/${u}/items`);if(t.status===401){ye();return}if(!t.ok)throw new Error("Failed to fetch itinerary items");const a=await t.json(),n=a.items.map((l,p)=>({...l,is_connected:p<a.active_count}));y(n),M(null)}catch(t){M("Failed to load itinerary. Please try again."),console.error(t)}finally{T(!1)}},[u,D,ve,i,I]);React.useEffect(()=>{De()},[De]),React.useEffect(()=>{Le(),D||(O(null),Y(null),E(!1),R({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!1,parent_id:null}))},[Le,D]);const se=React.useMemo(()=>N.find(t=>t.id===u),[N,u]),Qe=React.useMemo(()=>i&&se&&i.user.id===se.user_id,[i,se]),et=()=>{if(Qe)G(!0);else if(se){const t=`${window.location.origin}${window.location.pathname}?share_token=${se.share_token}`;navigator.clipboard.writeText(t),g("Copied to clipboard!")}},tt=async()=>{if(u!==null)try{const t=await I(`${J}/${u}/export`);if(!t.ok)throw new Error("Failed to export trip");const a=await t.blob(),n=t.headers.get("Content-Disposition");let l="trip_backup.yml";if(n){const s=n.match(/filename="?([^"]+)"?/);s&&(l=s[1])}const p=URL.createObjectURL(a),d=document.createElement("a");d.href=p,d.download=l,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(p)}catch(t){r("Failed to export trip"),console.error(t)}},st=async t=>{const a=t.target.files?.[0];if(a){if(!confirm("This will import the trip as a new trip. Continue?")){oe.current&&(oe.current.value="");return}try{const n=await a.text(),l=await I(`${J}/import`,{method:"POST",headers:{"Content-Type":"text/yaml"},body:n});if(!l.ok){const d=await l.json();throw new Error(d.detail||"Failed to import trip")}const p=await l.json();f(d=>[...d,p]),v(p.id),c("Successfully imported trip!")}catch(n){r(`Failed to import: ${n instanceof Error?n.message:String(n)}`),console.error(n)}finally{oe.current&&(oe.current.value="")}}},at=async t=>{if(t.preventDefault(),!!C.trim())try{const a=await I(J,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:C})});if(!a.ok)throw new Error("Failed to create trip");const n=await a.json();f(l=>[...l,n]),v(n.id),W(""),h(!1)}catch(a){r("Failed to create trip"),console.error(a)}},nt=async t=>{if(confirm("Are you sure you want to delete this trip and all its items?"))try{if(!(await I(`${J}/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete trip");f(n=>n.filter(l=>l.id!==t)),u===t&&v(N.find(n=>n.id!==t)?.id||null)}catch(a){r("Failed to delete trip"),console.error(a)}},je=(t=null)=>{Y(null),R({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!0,parent_id:t}),K(""),E(!0)},ot=(t,a,n)=>{const l=n==="child"&&S?.id||null,p=S?.date||null;Y(null),R({...m,location:"",description:"",description_private:"",date:p,time:null,lat:t,lng:a,category:"other",is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!0,parent_id:l,date_departure:null,time_departure:null}),K(`${t.toFixed(6)}, ${a.toFixed(6)}`),E(!0)},re=async t=>{if(u===null)return;te.current&&(clearTimeout(te.current),te.current=null);const a=[...t].sort((l,p)=>l.is_connected!==p.is_connected?l.is_connected?-1:1:0),n=a.filter(l=>l.is_connected).length;try{const l=await I(`${J}/${u}/items`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:a,connections:[],active_count:n})});if(!l.ok)throw new Error("Failed to sync trip items");const p=await l.json(),d=p.items.map((s,j)=>({...s,is_connected:j<p.active_count}));y(d)}catch(l){throw console.error("Sync error:",l),l}},rt=async()=>{if(!confirm("Are you sure you want to sort all items by date?"))return;const t=os(x);try{await re(t)}catch(a){r("Failed to reorder items"),console.error(a)}},lt=async(t,a)=>{try{const n=x.filter(_=>_.parent_id===a.id),l=n.length>0?n[n.length-1]:null,p=x.filter(_=>_.id!==t.id),d=p.findIndex(_=>_.id===a.id),s=l?p.findIndex(_=>_.id===l.id)+1:d+1,j=[...p];j.splice(s,0,{...t,parent_id:a.id}),await re(j)}catch(n){r("Failed to indent item"),console.error(n)}},it=async t=>{try{const a=x.findIndex(d=>d.id===t.parent_id),l=[...x.filter(d=>d.id!==t.id)],p={...t,parent_id:null,is_connected:!0};if(a!==-1){const d=l.findIndex(s=>s.id===t.parent_id);l.splice(d+1,0,p)}else l.push(p);await re(l)}catch(a){r("Failed to outdent item"),console.error(a)}},Fe=t=>{Y(t.id),R({date:t.date,time:t.time,location:t.location,description:t.description,description_private:t.description_private,category:t.category||"other",lat:t.lat,lng:t.lng,date_departure:t.date_departure,time_departure:t.time_departure,is_tba:t.is_tba,url_booking:t.url_booking||"",url_map:t.url_map||"",hide_from_map:t.hide_from_map,is_connected:t.is_connected,parent_id:t.parent_id}),K(t.lat&&t.lng?`${t.lat}, ${t.lng}`:""),E(!0)},dt=async t=>{if(t.preventDefault(),u!==null)try{const a=H?`${X}/travel/items/${H}`:`${J}/${u}/items`,l=await I(a,{method:H?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:m.date,time:m.time,location:m.location,description:m.description,description_private:m.description_private,category:m.category,lat:m.lat,lng:m.lng,date_departure:m.date_departure,time_departure:m.time_departure,is_tba:m.is_tba,url_booking:m.url_booking,url_map:m.url_map,hide_from_map:m.hide_from_map,parent_id:m.parent_id})});if(!l.ok)throw new Error("Failed to save item");const p=await l.json();let d;H?d=x.map(s=>s.id===H?{...s,...p,is_connected:m.is_connected}:s):d=[...x,{...p,is_connected:m.is_connected}],await re(d),E(!1),Y(null),R({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!1,parent_id:null})}catch(a){r("Failed to save item"),console.error(a)}},ct=async t=>{if(confirm("Are you sure you want to delete this item?"))try{if(!(await I(`${X}/travel/items/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete item");const n=x.filter(d=>d.parent_id===t),p=[...x.filter(d=>d.id!==t&&d.parent_id!==t),...n.map(d=>({...d,parent_id:null,is_connected:!1}))];await re(p),S?.id===t&&O(null)}catch(a){r("Failed to delete item"),console.error(a)}},pt=async t=>{if(confirm("Are you sure you want to duplicate this item?"))try{const a=await I(`${J}/${u}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:t.date,time:t.time,location:t.location,description:`**DUPLICATED**
${t.description}`,description_private:t.description_private,category:t.category,lat:t.lat,lng:t.lng,date_departure:t.date_departure,time_departure:t.time_departure,is_tba:!0,url_booking:t.url_booking,url_map:t.url_map,parent_id:t.parent_id})});if(!a.ok)throw new Error("Failed to duplicate item");const n=await a.json();y(l=>[...l,{...n,is_connected:!1}])}catch(a){r("Failed to duplicate item"),console.error(a)}},ut=t=>{be(t)},ht=(t,a)=>{t.preventDefault(),ee.current={y:t.clientY},!(B===null||B===a)&&y(n=>{const l=n.findIndex(Z=>Z.id===B),p=n.findIndex(Z=>Z.id===a);if(l===-1||p===-1)return n;const d=[...n],[s]=d.splice(l,1),j=n.filter(Z=>Z.is_connected).length;s.is_connected=p<j,d.splice(p,0,s);const _=n.map(Z=>`${Z.id}-${Z.is_connected}`).join(","),le=d.map(Z=>`${Z.id}-${Z.is_connected}`).join(",");return _!==le?d:n})},mt=async()=>{B===null||u===null||(be(null),q(null),ee.current=null,te.current&&clearTimeout(te.current),te.current=setTimeout(async()=>{try{await re(Ae.current)}catch(t){r("Failed to save reordered items"),console.error(t)}finally{te.current=null}},100))},xt=t=>{t.preventDefault(),B!==null&&y(a=>{const n=a.findIndex(_=>_.id===B);if(n===-1)return a;const l=[...a],[p]=l.splice(n,1),d=a.filter(_=>_.id!==B&&_.is_connected).length;p.is_connected=!1,l.splice(d,0,p);const s=a.map(_=>`${_.id}-${_.is_connected}`).join(","),j=l.map(_=>`${_.id}-${_.is_connected}`).join(",");return s!==j?l:a})};React.useMemo(()=>x.filter(t=>!t.hide_from_map),[x]);const Oe=React.useMemo(()=>x.filter(t=>t.is_connected).length,[x]);return!i&&!D?e.jsx(bt,{appName:"Travel Planner",loginEndpoint:"/travel/login",onSuccess:(t,a)=>Ke(t,a)}):e.jsxs("div",{className:"flex h-full flex-col overflow-hidden border bg-slate-50 font-sans text-slate-900 md:rounded-2xl md:border-slate-200/50 md:shadow-2xl",children:[e.jsxs("header",{className:"z-10 flex flex-wrap items-center justify-between gap-4 border-b border-slate-200 bg-white px-6 py-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:"/favicon_travel.png",alt:"Travel Planner",className:"h-10 w-10 shrink-0 rounded-xl shadow-lg shadow-indigo-200"}),e.jsx("h1",{className:"hidden text-2xl font-bold tracking-tight text-slate-900 md:block","data-testid":"travel-planner-heading",children:"Travel Planner"})]}),e.jsx("div",{className:"flex max-w-md flex-1 items-center gap-3",children:A?e.jsxs("form",{onSubmit:at,className:"flex w-full gap-2",children:[e.jsx("input",{autoFocus:!0,type:"text","data-testid":"trip-name-input",placeholder:"Trip name...",className:"flex-1 rounded-lg border border-slate-200 px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500",value:C,onChange:t=>W(t.target.value)}),e.jsx("button",{type:"submit",className:"rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-bold text-white hover:bg-indigo-700","data-testid":"save-trip-name-button",children:"Save"}),e.jsx("button",{type:"button",onClick:()=>h(!1),className:"rounded-lg bg-slate-100 px-3 py-1.5 text-xs font-bold text-slate-600 hover:bg-slate-200","data-testid":"cancel-trip-name-button",children:"Cancel"})]}):e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsxs("select",{className:"flex-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-default disabled:opacity-70",value:u||"",onChange:t=>v(Number(t.target.value)),disabled:D,children:[N.length===0&&e.jsx("option",{value:"",children:"No trips created"}),N.map(t=>e.jsxs("option",{value:t.id,children:[t.name,i&&t.user_id!==i.user.id?" (Shared)":""]},t.id))]}),!D&&e.jsx(e.Fragment,{children:e.jsx("button",{onClick:()=>h(!0),className:"shrink-0 rounded-lg bg-slate-100 p-2 text-slate-600 transition-colors hover:bg-slate-200",title:"Create New Trip","data-testid":"create-trip-button",children:e.jsx(Ne,{size:20})})})]})}),e.jsxs("div",{className:"flex items-center gap-4",children:[u&&e.jsx("div",{className:"flex items-center gap-2",children:!D&&e.jsxs(Se,{onClick:et,title:"Trip Settings","data-testid":"share-trip-button",children:[e.jsx(Ct,{size:18}),e.jsx("span",{className:"hidden md:inline",children:"Trip settings"})]})}),e.jsx("input",{type:"file",ref:oe,onChange:st,accept:".yaml,.yml",className:"hidden"}),e.jsxs(Se,{variant:"indigo",onClick:()=>Pe(!z),title:z?"Show Map":"List View","data-testid":"map-list-toggle-button",children:[z?e.jsx(me,{size:18}):e.jsx($t,{size:18}),e.jsx("span",{className:"hidden md:inline",children:z?"Show Map":"List View"})]}),!D&&e.jsxs(e.Fragment,{children:[i?.user.role==="admin"&&e.jsxs(Se,{variant:"indigo-light",onClick:()=>ne(!0),title:"Manage Users",children:[e.jsx(Mt,{size:18}),e.jsx("span",{className:"hidden md:inline",children:"Users"})]}),e.jsx("span",{className:"text-sm font-semibold text-slate-600",children:i?.user.first_name}),e.jsx("button",{onClick:ye,className:"p-2 text-slate-500 transition-colors hover:text-red-500",title:"Logout",children:e.jsx(Rt,{size:20})})]})]})]}),e.jsxs("main",{className:"relative flex flex-1 overflow-hidden",children:[e.jsx("div",{className:`${z||U&&!P?"flex w-full":"hidden md:flex md:w-1/3"} z-20 flex-col overflow-hidden border-r border-slate-200 bg-white shadow-xl`,children:U?e.jsxs("div",{className:"overflow-y-auto p-6",children:[e.jsx("h2",{className:"mb-6 text-xl font-bold text-slate-800",children:H?"Edit Destination":"Add New Destination"}),e.jsxs("form",{onSubmit:dt,className:"space-y-5",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{E(!1),Y(null)},className:"flex-1 rounded-lg bg-slate-100 py-3 font-bold text-slate-600 transition-all hover:bg-slate-200","data-testid":"cancel-item-button",children:"Cancel"}),e.jsx("button",{type:"submit",className:"flex-[2] rounded-lg bg-indigo-600 py-3 font-bold text-white shadow-lg shadow-indigo-100 transition-all hover:bg-indigo-700","data-testid":"save-item-button",children:H?"Save Changes":"Save to Itinerary"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[" ",e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-date",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Date"}),e.jsx("input",{id:"travel-date","data-testid":"travel-date",type:"date",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.date||"",onChange:t=>R({...m,date:t.target.value||null})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-time",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Time"}),e.jsx("input",{id:"travel-time","data-testid":"travel-time",type:"time",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.time||"",onChange:t=>R({...m,time:t.target.value||null})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-departure-date",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Departure Date"}),e.jsx("input",{id:"travel-departure-date","data-testid":"travel-departure-date",type:"date",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.date_departure||"",onChange:t=>R({...m,date_departure:t.target.value||null}),onFocus:()=>{!m.date_departure&&m.date&&R({...m,date_departure:m.date})}})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-departure-time",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Departure Time"}),e.jsx("input",{id:"travel-departure-time","data-testid":"travel-departure-time",type:"time",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.time_departure||"",onChange:t=>R({...m,time_departure:t.target.value||null})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Category"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:ie.map(t=>{const a=t.icon,n=m.category===t.id;return e.jsxs("button",{type:"button",onClick:()=>R({...m,category:t.id}),"data-testid":"category-button",className:`flex flex-col items-center gap-1.5 rounded-lg border p-2 transition-all ${n?"border-indigo-200 bg-indigo-50 text-indigo-600 shadow-sm":"border-slate-100 bg-white text-slate-400 hover:border-slate-200 hover:bg-slate-50"}`,children:[e.jsx(a,{size:18}),e.jsx("span",{className:"text-[10px] font-bold tracking-wider uppercase",children:t.label})]},t.id)})})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500",checked:m.is_tba,onChange:t=>R({...m,is_tba:t.target.checked})}),e.jsx("span",{className:"text-sm font-semibold text-slate-700",children:"TBA (To Be Amended)"})]}),e.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500",checked:m.hide_from_map,onChange:t=>R({...m,hide_from_map:t.target.checked})}),e.jsx("span",{className:"text-sm font-semibold text-slate-700",children:"Hide from map"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:["Location Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",required:!0,"data-testid":"location-input",placeholder:"e.g. Paris, France",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.location,onChange:t=>R({...m,location:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Description"}),e.jsx("textarea",{rows:6,"data-testid":"description-input",placeholder:"What are you planning to do there?",className:"w-full resize-y rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.description,onChange:t=>R({...m,description:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Private Note (hidden on shared links)"}),e.jsx("textarea",{rows:6,placeholder:"Personal notes, booking references, etc.",className:"w-full resize-y rounded-lg border border-slate-200 bg-green-50/30 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.description_private,onChange:t=>R({...m,description_private:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Coordinates"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text","data-testid":"gps-input",placeholder:"GPS 'lat, lng' or Google Maps link https://www.google.com/maps/place/...",className:"flex-1 rounded-lg border border-slate-200 px-4 py-2 text-sm transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:Xe,onChange:t=>{const a=t.target.value;if(K(a),a.startsWith("http")){const n=a.match(/!3d(-?\d+(?:\.\d+)?)/),l=a.match(/!4d(-?\d+(?:\.\d+)?)/);if(n&&l){const p=parseFloat(n[1]),d=parseFloat(l[1]);!isNaN(p)&&!isNaN(d)&&(R({...m,lat:p,lng:d}),K(`${p}, ${d}`))}else{const p=a.match(/@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/);if(p){const d=parseFloat(p[1]),s=parseFloat(p[2]);!isNaN(d)&&!isNaN(s)&&(R({...m,lat:d,lng:s}),K(`${d}, ${s}`))}}}else{const n=a.split(/[\s,]+/);if(n.length>=2){const l=parseFloat(n[0]),p=parseFloat(n[1]);!isNaN(l)&&!isNaN(p)&&R({...m,lat:l,lng:p})}}}}),e.jsx("button",{type:"button",onClick:()=>{o(!0),Pe(!1)},className:"flex shrink-0 items-center justify-center rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-2 font-bold text-indigo-700 shadow-sm transition-all hover:bg-indigo-100",title:"Pick location on map","data-testid":"select-on-map-button",children:e.jsx(qt,{size:20})})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:["Google Map URL (or"," ",e.jsx("a",{href:"https://developers.google.com/maps/documentation/javascript/examples/places-placeid-finder",target:"_blank",rel:"noopener noreferrer",className:"font-normal text-indigo-600 hover:underline",onClick:t=>t.stopPropagation(),children:"Google Place ID"}),")"]}),e.jsx("input",{type:"url","data-testid":"map-url-input",placeholder:"e.g. https://google.com/maps/... or ChIJ3S-JXmauEmsRUcIaWtf4MzE",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 text-sm transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.url_map,onChange:t=>{let a=t.target.value;a&&!a.startsWith("http")&&(a=`https://www.google.com/maps/search/?api=1&query_place_id=${a}&query=a`);const n=a.match(/!3d(-?\d+(?:\.\d+)?)/),l=a.match(/!4d(-?\d+(?:\.\d+)?)/);let p=null,d=null;if(n&&l)p=parseFloat(n[1]),d=parseFloat(l[1]);else{const s=a.match(/@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/);s&&(p=parseFloat(s[1]),d=parseFloat(s[2]))}p!==null&&d!==null&&!isNaN(p)&&!isNaN(d)?(R({...m,url_map:a,lat:p,lng:d}),K(`${p}, ${d}`)):R({...m,url_map:a})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Place URL"}),e.jsx("input",{type:"url",placeholder:"e.g. https://booking.com/... or https://www.tripadvisor.co.uk/...",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 text-sm transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:m.url_booking,onChange:t=>{let a=t.target.value;a.startsWith("https://www.booking.com/")&&(a=a.split("?")[0]),R({...m,url_booking:a})}})]})]})]})]}):e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-slate-100 p-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-baseline items-center gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:"Itinerary"}),(()=>{const t=x.find(s=>s.date);if(!t||!t.date)return null;const a=new Date,p=(new Date(`${t.date}T${t.time||"12:00"}`).getTime()-a.getTime())/(1e3*60*60*24),d=Math.round(p*10)/10;return d>0?e.jsxs("span",{className:"text-md inline-flex items-center rounded-full px-2.5 py-0.5 font-semibold text-red-700",children:["starting in ",d.toFixed(1)," day",d!==1&&"s"]}):null})()]}),e.jsxs("p",{className:"mt-1 text-sm text-slate-500",children:[Oe," stops and ",x.length-Oe," unconnected points"]})]}),!D&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{disabled:u===null,onClick:()=>je(),className:"rounded-lg bg-indigo-600 p-2 text-white shadow-sm transition-all hover:bg-indigo-700 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50",title:"Add Stop","data-testid":"add-stop-button",children:e.jsx(Ne,{size:20})}),e.jsx("button",{disabled:u===null,onClick:()=>rt(),className:"rounded-lg bg-indigo-600 p-2 text-white shadow-sm transition-all hover:bg-indigo-700 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50",title:"Sort by Date","data-testid":"sort-by-date-button",children:e.jsx(Dt,{size:20})})]})]}),e.jsx("div",{ref:ce,"data-testid":"timeline-container",className:"scrollbar-thin scrollbar-thumb-slate-200 flex-1 overflow-y-auto p-6",onDragOver:t=>{t.preventDefault(),ee.current={y:t.clientY}},children:k?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-b-2 border-indigo-600"})}):w?e.jsx("div",{className:"px-4 py-12 text-center font-medium text-red-500",children:w}):x.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-slate-50 text-slate-400",children:e.jsx($e,{size:32})}),e.jsx("p",{className:"font-medium text-slate-500",children:"No stops added yet."}),!D&&e.jsx("button",{disabled:u===null,onClick:()=>je(),className:"mt-2 text-sm font-bold text-indigo-600 hover:underline disabled:opacity-50","data-testid":"add-stop-empty-state-button",children:u===null?"Create a trip first":"Start planning now"})]}):e.jsx("div",{className:"relative flex flex-col space-y-2",children:(()=>{const t=x.filter(s=>!s.parent_id),a=x.reduce((s,j)=>(j.parent_id&&(s[j.parent_id]||(s[j.parent_id]=[]),s[j.parent_id].push(j)),s),{}),n=t.filter(s=>s.is_connected).length,l=s=>e.jsxs("div",{className:`relative ${z?"py-2":"py-6"}`,onDragOver:xt,children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-dashed border-slate-200"})}),e.jsx("div",{className:"relative flex justify-center",children:e.jsx("span",{className:"bg-white px-4 text-[10px] font-bold tracking-[0.2em] text-slate-400 uppercase",children:"Extra Locations"})})]},s),p=(s,j,_,le)=>{const Ue=t[_].is_connected?_+1:String.fromCharCode(65+(_-n)),gt=j?`${Ue}.${le+1}`:Ue;return e.jsxs("div",{id:`travel-item-${s.id}`,className:`relative ${j?"py-0 pr-0 pl-16":"py-1 pl-10"} ${B===s.id?"opacity-20":""} ${de===s.id?"select-none":""}`,onClick:()=>O(s),"data-testid":`travel-item-${s.id}`,draggable:!D&&de===s.id&&H!==s.id,onDragStart:()=>ut(s.id),onDrag:$=>{$.clientY!==0&&(ee.current={y:$.clientY})},onDragOver:$=>ht($,s.id),onDragEnd:mt,children:[_<n&&e.jsxs(e.Fragment,{children:[(_<n-1||_===n-1&&j)&&e.jsx("div",{className:"absolute top-0 bottom-0 left-4 z-0 w-[3px] -translate-x-1/2 bg-indigo-200"}),_===n-1&&!j&&e.jsx("div",{className:"absolute top-0 left-4 z-0 h-4 w-[3px] -translate-x-1/2 bg-indigo-200"}),(_>0||j)&&e.jsx("div",{className:`absolute left-4 ${z?"-top-2 h-2":"-top-4 h-4"} z-0 w-[3px] -translate-x-1/2 bg-indigo-200`})]}),j&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-0 bottom-1/2 left-10 z-0 h-full w-4 w-[2px] -translate-x-1/2 rounded-bl-lg border-b-2 border-l-2 border-slate-200 bg-slate-200"}),le>0&&e.jsx("div",{className:`absolute left-10 ${z?"-top-2 h-2":"-top-4 h-4"} z-0 w-[2px] -translate-x-1/2 bg-slate-200`})]}),e.jsx("div",{"data-testid":`travel-item-dot-${s.id}`,"data-connected":s.is_connected?"true":"false",className:`absolute ${j?"left-6 mt-1.5 h-7 w-7":"top-1.5 left-0 h-8 w-8"} z-20 flex items-center justify-center rounded-full border-[3px] shadow-sm transition-colors ${S?.id===s.id||H===s.id?"border-slate-300 bg-red-400 text-white":j?"border-indigo-200 bg-green-50 text-slate-500":s.is_connected?"border-indigo-200 bg-slate-200 text-slate-500":"border-indigo-200 bg-amber-500 text-white"}`,children:e.jsx("span",{"data-testid":`travel-item-label-${s.id}`,className:"text-[0.8rem] font-bold",children:gt})}),!D&&S?.id===s.id&&e.jsx("button",{onClick:$=>{$.stopPropagation(),je(j?s.parent_id:s.id)},className:`absolute ${j?"left-[30px] h-5 w-5":"left-1 h-6 w-6"} bottom-1.5 z-20 flex items-center justify-center rounded-full border-2 border-indigo-100 bg-white text-indigo-300 shadow-sm transition-colors hover:border-indigo-200 hover:text-indigo-400`,title:"Add item after this","data-testid":`add-item-after-button-${s.id}`,children:e.jsx(Ne,{size:j?10:12})}),e.jsxs("div",{"data-testid":`travel-item-content-${s.id}`,className:`${z?"p-2":"p-4"} group/item relative z-10 flex flex-col rounded-xl border shadow-sm ${s.hide_from_map?"bg-white":j?"bg-green-50":s.is_connected?"bg-indigo-50":"bg-amber-50"} ${S?.id===s.id?"border-indigo-200":j?"border-green-200 hover:border-green-300":s.is_connected?"border-indigo-200 hover:border-indigo-300":"border-amber-200 hover:border-amber-300"}`,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[(s.date||s.time||s.date_departure||s.time_departure)&&e.jsx("div",{className:"mb-1 flex items-start justify-between",children:e.jsxs("span",{className:`text-xs font-bold tracking-wider uppercase ${j?"text-green-600":s.is_connected?"text-indigo-600":"text-amber-600"}`,children:[[s.date?he(s.date,!0):null,s.time?s.time.substring(0,5):null].filter(Boolean).join(" @ "),(s.date_departure||s.time_departure)&&e.jsxs(e.Fragment,{children:[" → ",[s.date_departure?he(s.date_departure):null,s.time_departure?s.time_departure.substring(0,5):null].filter(Boolean).join(" @ ")]})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.category&&e.jsx("div",{className:`shrink-0 ${j?"text-green-400":s.is_connected?"text-indigo-400":"text-amber-400"}`,children:(()=>{const $=ie.find(_e=>_e.id===s.category),we=$?$.icon:ze;return e.jsx(we,{size:16})})()}),e.jsx("h3",{className:`${z?"text-sm":"text-base"} truncate font-bold text-slate-900`,children:s.location}),s.is_tba&&e.jsx("span",{"data-testid":"tba-pill",className:"shrink-0 rounded border border-pink-200 bg-pink-100 px-1.5 py-0.5 text-[10px] font-bold tracking-wider text-pink-700 uppercase",children:"TBA"})]}),(s.url_booking||s.url_map)&&e.jsxs("div",{className:"mt-1 flex gap-2",children:[s.url_booking&&e.jsx("a",{href:Je(s.url_booking,s.date,s.date_departure),target:"_blank",rel:"noopener noreferrer",onClick:$=>$.stopPropagation(),className:"inline-flex items-center gap-1 rounded border border-blue-500 bg-blue-50 px-2 py-0.5 text-[10px] font-bold text-blue-800 uppercase transition-colors hover:text-blue-900",children:(()=>{const $=ie.find(_e=>_e.id===s.category)||ie[7],we=$.icon;return e.jsxs(e.Fragment,{children:[e.jsx(we,{size:10}),$.label]})})()}),s.url_map&&e.jsxs("a",{href:s.url_map,target:"_blank",rel:"noopener noreferrer",onClick:$=>$.stopPropagation(),className:"inline-flex items-center gap-1 rounded border border-amber-500 bg-amber-50 px-2 py-0.5 text-[10px] font-bold text-amber-600 uppercase transition-colors hover:text-amber-800",children:[e.jsx(me,{size:10}),"Google Map"]})]}),!z&&e.jsxs(e.Fragment,{children:[s.description&&e.jsx(Me,{text:s.description,className:"mt-1",textClassName:"text-sm text-slate-600"}),!D&&s.description_private&&e.jsx(Me,{text:s.description_private,className:"mt-1.5 rounded-md border border-slate-100/50 bg-slate-50/50 p-1.5",textClassName:"text-sm text-slate-700/80",badge:e.jsx("span",{className:"mt-0.5 shrink-0 rounded bg-slate-200 px-1 text-[10px] font-bold text-slate-800 uppercase",children:"Private"})})]})]}),!D&&S?.id===s.id&&e.jsxs("div",{className:"ml-auto flex shrink-0 items-center gap-3","data-testid":`list-control-icons-${s.id}`,children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:$=>{$.stopPropagation(),Fe(s)},className:"rounded-md p-1.5 text-indigo-400 transition-all hover:bg-red-50 hover:text-red-600",title:"Edit","data-testid":`edit-item-button-${s.id}`,children:e.jsx(We,{size:z?14:16})}),e.jsx("button",{onClick:$=>{$.stopPropagation(),pt(s)},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-indigo-50 hover:text-indigo-600",title:"Duplicate","data-testid":`duplicate-item-button-${s.id}`,children:e.jsx(Tt,{size:z?14:16})}),!j&&_>0&&e.jsx("button",{onClick:$=>{$.stopPropagation(),lt(s,t[_-1])},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-indigo-50 hover:text-indigo-600",title:"Make Child of Previous Item","data-testid":`indent-item-button-${s.id}`,children:e.jsx(Wt,{size:z?14:16})}),j&&e.jsx("button",{onClick:$=>{$.stopPropagation(),it(s)},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-indigo-50 hover:text-indigo-600",title:"Make it a Parent Item","data-testid":`outdent-item-button-${s.id}`,children:e.jsx(It,{size:z?14:16})}),e.jsx("button",{onClick:$=>{$.stopPropagation(),ct(s.id)},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-red-50 hover:text-red-600",title:"Delete","data-testid":`delete-item-button-${s.id}`,children:e.jsx(Ee,{size:z?14:16})})]}),e.jsx("div",{"data-testid":`drag-handle-${s.id}`,className:"cursor-grab touch-none p-1 text-slate-400 transition-all hover:text-slate-600 active:cursor-grabbing",onMouseDown:()=>q(s.id),onMouseUp:()=>q(null),onTouchStart:()=>q(s.id),onTouchEnd:()=>q(null),onTouchCancel:()=>q(null),children:e.jsx(Et,{size:z?16:20})})]})]})]},s.id)},d=[];return t.forEach((s,j)=>{j===n&&d.push(l(`marker-${j}`)),d.push(p(s,!1,j,0)),a[s.id]?.forEach((_,le)=>d.push(p(_,!0,j,le)))}),n===t.length&&t.length>0&&d.push(l("marker-end")),d})()})})]})}),e.jsx("div",{className:`${z||U&&!P?"hidden md:block":"block"} ${z?"md:hidden":""} h-full flex-1`,children:e.jsx(hs,{tripId:u,items:x,selectedItem:S,editingItemId:H,editingItemLocation:U?{lat:m.lat,lng:m.lng,category:m.category,is_connected:m.is_connected,hide_from_map:m.hide_from_map}:null,onSelectItem:O,onEdit:Fe,onLocationSelect:(t,a)=>{R({...m,lat:t,lng:a}),K(`${t.toFixed(6)}, ${a.toFixed(6)}`),o(!1)},onAddAtLocation:ot,onCancelLocationSelect:()=>o(!1),isSelectingLocation:P,isCollapsed:z,isReadOnly:D})})]}),fe&&i&&e.jsx(ns,{auth:i,onClose:()=>ne(!1)}),F&&i&&se&&e.jsx(ms,{auth:i,trip:se,onClose:()=>G(!1),onUpdate:t=>{f(a=>a.map(n=>n.id===t.id?t:n))},onDelete:nt,onExport:tt,onImport:()=>oe.current?.click()})]})},Ie=document.getElementById("root");Ie&&(document.body.classList.add("travel-page"),ReactDOM.createRoot(Ie).render(e.jsx(React.StrictMode,{children:e.jsx(ft,{children:e.jsx(xs,{})})})));
