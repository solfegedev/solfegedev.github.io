import"./index-F_Pwjxo7.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{A as J}from"./api-CH_Pe6Vg.js";import{c as Ve,f as xe}from"./utils-Bp7-rn4K.js";import{X as Ce}from"./x-BS-d4QNZ.js";import{T as Me}from"./trash-2-DQbJ9aIh.js";import{C as bt}from"./chevron-up-DUwvjlA1.js";import{C as yt,M as Ee}from"./map-pin-DpUOG5tc.js";import{c as V}from"./createLucideIcon-DtX1aPOG.js";import{b as Ge,c as vt,d as jt,e as Ze,f as Te,L as wt,g as _t,T as ue,M as Nt,P as Oe,a as Ue,u as ge,h as kt}from"./TileLayer-DwRFwdKq.js";import{M as me,L as Ct}from"./map-KwUVJvQx.js";import{P as qe}from"./pencil-DHu_drsE.js";import{D as St,U as $t,G as Rt}from"./upload-CK6mc6ZD.js";import{P as _e}from"./plus-DDkdk0pc.js";import{S as Mt,U as Et}from"./users-BSGUDG_u.js";import{L as Tt}from"./log-out-B0TqtotO.js";import{C as Lt}from"./copy-CzC7y2Qs.js";import"./clsx-B-dksMZM.js";const Pt=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],zt=V("activity",Pt);const Ft=[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]],Dt=V("arrow-up-down",Ft);const At=[["path",{d:"M2 4v16",key:"vw9hq8"}],["path",{d:"M2 8h18a2 2 0 0 1 2 2v10",key:"1dgv2r"}],["path",{d:"M2 17h20",key:"18nfp3"}],["path",{d:"M6 8v9",key:"1yriud"}]],Ot=V("bed",At);const Ut=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],Bt=V("camera",Ut);const It=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],Se=V("circle-plus",It);const Ht=[["path",{d:"m14 15-5 5-5-5",key:"1eia93"}],["path",{d:"M20 4h-7a4 4 0 0 0-4 4v12",key:"nbpdq2"}]],Vt=V("corner-left-down",Ht);const Gt=[["path",{d:"m15 14 5-5-5-5",key:"12vg1m"}],["path",{d:"M4 20v-7a4 4 0 0 1 4-4h12",key:"1lu4f8"}]],Zt=V("corner-up-right",Gt);const qt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"22",x2:"18",y1:"12",y2:"12",key:"l9bcsi"}],["line",{x1:"6",x2:"2",y1:"12",y2:"12",key:"13hhkx"}],["line",{x1:"12",x2:"12",y1:"6",y2:"2",key:"10w3f3"}],["line",{x1:"12",x2:"12",y1:"22",y2:"18",key:"15g9kq"}]],Wt=V("crosshair",qt);const Yt=[["path",{d:"M10 18v-7",key:"wt116b"}],["path",{d:"M11.12 2.198a2 2 0 0 1 1.76.006l7.866 3.847c.476.233.31.949-.22.949H3.474c-.53 0-.695-.716-.22-.949z",key:"1m329m"}],["path",{d:"M14 18v-7",key:"vav6t3"}],["path",{d:"M18 18v-7",key:"aexdmj"}],["path",{d:"M3 22h18",key:"8prr45"}],["path",{d:"M6 18v-7",key:"1ivflk"}]],Jt=V("landmark",Yt);const Xt=[["path",{d:"M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z",key:"1v9wt8"}]],Kt=V("plane",Xt);const Qt=[["path",{d:"M8 3.1V7a4 4 0 0 0 8 0V3.1",key:"1v71zp"}],["path",{d:"m9 15-1-1",key:"1yrq24"}],["path",{d:"m15 15 1-1",key:"1t0d6s"}],["path",{d:"M9 19c-2.8 0-5-2.2-5-5v-4a8 8 0 0 1 16 0v4c0 2.8-2.2 5-5 5Z",key:"1p0hjs"}],["path",{d:"m8 19-2 3",key:"13i0xs"}],["path",{d:"m16 19 2 3",key:"xo31yx"}]],ea=V("train-front",Qt);const ta=[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]],aa=V("utensils",ta);function sa(n){return function(o){const p=Ge(),r=n(o,p),{instance:b}=r.current,d=React.useRef(o.position),{position:m}=o;return React.useEffect(function(){return b.addTo(p.map),function(){b.remove()}},[p.map,b]),React.useEffect(function(){m!=null&&m!==d.current&&(b.setPosition(m),d.current=m)},[b,m]),r}}const na=jt(function({children:i,...o},p){const r=new L.Control.Layers(void 0,void 0,o);return Ze(r,Te(p,{layersControl:r}))},function(i,o,p){o.collapsed!==p.collapsed&&(o.collapsed===!0?i.collapse():i.expand())}),oa=sa(na),Y=vt(oa);function We(n){return function(o){const p=Ge(),r=React.useRef(o),[b,d]=React.useState(null),{layersControl:m,map:j}=p,y=React.useCallback(N=>{m!=null&&(r.current.checked&&j.addLayer(N),n(m,N,r.current.name),d(N))},[n,m,j]),_=React.useCallback(N=>{m?.removeLayer(N),d(null)},[m]),w=React.useMemo(()=>Te(p,{layerContainer:{addLayer:y,removeLayer:_}}),[p,y,_]);return React.useEffect(()=>{b!==null&&r.current!==o&&(o.checked===!0&&(r.current.checked==null||r.current.checked===!1)?j.addLayer(b):r.current.checked===!0&&(o.checked==null||o.checked===!1)&&j.removeLayer(b),r.current=o)}),o.children?React.createElement(wt,{value:w},o.children):null}}Y.BaseLayer=We(function(i,o,p){i.addBaseLayer(o,p)});Y.Overlay=We(function(i,o,p){i.addOverlay(o,p)});const Be=_t(function({positions:i,...o},p){const r=new L.Polyline(i,o);return Ze(r,Te(p,{overlayContainer:r}))},function(i,o,p){o.positions!==p.positions&&i.setLatLngs(o.positions)}),ra=({auth:n,onClose:i})=>{const[o,p]=React.useState([]),[r,b]=React.useState(!0),[d,m]=React.useState(""),[j,y]=React.useState(""),[_,w]=React.useState(""),[N,k]=React.useState(""),[$,z]=React.useState("user"),[B,I]=React.useState(null),F=async()=>{try{const g=await fetch(`${J}/travel/admin/users`,{headers:{Authorization:`Bearer ${n.access_token}`}});if(!g.ok)throw new Error("Failed to fetch users");const C=await g.json();p(C)}catch(g){console.error("Failed to fetch users",g)}finally{b(!1)}};React.useEffect(()=>{F()},[n]);const D=async g=>{g.preventDefault(),I(null);try{const C=await fetch(`${J}/travel/admin/users`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.access_token}`},body:JSON.stringify({email:d,password:j,role:$,first_name:_,last_name:N})}),M=await C.json();if(!C.ok)throw new Error(M.detail||"Failed to create user");p([...o,M]),m(""),y(""),w(""),k("")}catch(C){I(C.message)}},c=async g=>{if(g===n.user.id){alert("You cannot delete yourself.");return}if(confirm("Are you sure? All their trips will be lost."))try{if(!(await fetch(`${J}/travel/admin/users/${g}`,{method:"DELETE",headers:{Authorization:`Bearer ${n.access_token}`}})).ok)throw new Error("Failed to delete user");p(o.filter(M=>M.id!==g))}catch(C){console.error("Failed to delete user",C)}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"flex max-h-[90vh] w-full max-w-4xl flex-col overflow-hidden rounded-2xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-slate-100 p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:"User Management"}),e.jsx("button",{onClick:i,className:"text-slate-400 hover:text-slate-600",children:e.jsx(Ce,{size:24})})]}),e.jsxs("div",{className:"flex-1 space-y-8 overflow-y-auto p-6",children:[e.jsxs("section",{children:[e.jsx("h3",{className:"mb-4 text-lg font-bold text-slate-800",children:"Add New User"}),e.jsxs("form",{onSubmit:D,className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx("input",{type:"email",placeholder:"Email",required:!0,autoComplete:"email",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:d,onChange:g=>m(g.target.value)}),e.jsx("input",{type:"password",placeholder:"Password",required:!0,autoComplete:"new-password",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:j,onChange:g=>y(g.target.value)}),e.jsx("input",{type:"text",placeholder:"First Name",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:_,onChange:g=>w(g.target.value)}),e.jsx("input",{type:"text",placeholder:"Last Name",className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:N,onChange:g=>k(g.target.value)}),e.jsxs("select",{className:"rounded-lg border border-slate-200 px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500",value:$,onChange:g=>z(g.target.value),children:[e.jsx("option",{value:"user",children:"User"}),e.jsx("option",{value:"admin",children:"Admin"})]}),e.jsx("button",{type:"submit",className:"rounded-lg bg-indigo-600 py-2 font-bold text-white hover:bg-indigo-700",children:"Create User"})]}),B&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:B})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"mb-4 text-lg font-bold text-slate-800",children:"Existing Users"}),r?e.jsx("p",{children:"Loading..."}):e.jsx("div",{className:"overflow-hidden rounded-xl border border-slate-100",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"border-b border-slate-100 bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-sm font-bold text-slate-600",children:"User"}),e.jsx("th",{className:"px-4 py-3 text-sm font-bold text-slate-600",children:"Role"}),e.jsx("th",{className:"px-4 py-3 text-sm font-bold text-slate-600",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-bold text-slate-600",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:o.map(g=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-slate-900",children:g.email}),e.jsxs("div",{className:"text-xs text-slate-500",children:[g.first_name," ",g.last_name]})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`rounded px-2 py-0.5 text-[10px] font-bold uppercase ${g.role==="admin"?"bg-indigo-100 text-indigo-700":"bg-blue-100 text-blue-700"}`,children:g.role})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("span",{className:`flex items-center gap-1.5 text-xs ${g.is_active?"text-amber-600":"text-red-600"}`,children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${g.is_active?"bg-amber-500":"bg-red-500"}`}),g.is_active?"Active":"Inactive"]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:g.id!==n.user.id&&e.jsx("button",{onClick:()=>c(g.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Me,{size:18})})})]},g.id))})]})})]})]})]})})},la=({onLogin:n})=>{const[i,o]=React.useState(""),[p,r]=React.useState(""),[b,d]=React.useState(null),[m,j]=React.useState(!1),y=async _=>{_.preventDefault(),j(!0),d(null);try{const w=await fetch(`${J}/travel/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i,password:p})}),N=await w.json();if(!w.ok)throw new Error(N.detail||"Login failed");n(N)}catch(w){d(w.message||"Login failed")}finally{j(!1)}};return e.jsxs("div",{className:"mx-auto mt-20 max-w-md rounded-2xl border border-slate-100 bg-white p-8 shadow-xl",children:[e.jsxs("div",{className:"mb-8 flex flex-col items-center",children:[e.jsx("img",{src:"/favicon_travel.png",alt:"Travel Planner",className:"mb-4 h-16 w-16 rounded-2xl shadow-lg shadow-indigo-200"}),e.jsx("h2",{className:"text-center text-3xl font-bold text-slate-900",children:"Travel Planner"}),e.jsx("p",{className:"mt-2 text-slate-500",children:"Sign in to manage your trips"})]}),e.jsxs("form",{onSubmit:y,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Email Address"}),e.jsx("input",{type:"email",required:!0,autoComplete:"email","data-testid":"login-email",className:"w-full rounded-xl border border-slate-200 px-4 py-3 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",placeholder:"you@example.com",value:i,onChange:_=>o(_.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Password"}),e.jsx("input",{type:"password",required:!0,autoComplete:"current-password","data-testid":"login-password",className:"w-full rounded-xl border border-slate-200 px-4 py-3 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",placeholder:"••••••••",value:p,onChange:_=>r(_.target.value)})]}),b&&e.jsx("div",{className:"rounded-lg border border-red-100 bg-red-50 p-3 text-sm font-medium text-red-600",children:b}),e.jsx("button",{type:"submit",disabled:m,"data-testid":"login-button",className:"w-full rounded-xl bg-indigo-600 py-4 text-lg font-bold text-white shadow-lg shadow-indigo-100 transition-all hover:bg-indigo-700 active:scale-[0.98] disabled:cursor-not-allowed disabled:opacity-70",children:m?"Signing in...":"Sign In"})]})]})},$e=({text:n,className:i,textClassName:o,maxLines:p=3,badge:r})=>{const[b,d]=React.useState(!1),[m,j]=React.useState(!1),y=React.useRef(null);return React.useEffect(()=>{const _=()=>{if(y.current){const w=y.current.cloneNode(!0);w.style.webkitLineClamp="unset",w.style.display="block",w.style.visibility="hidden",w.style.position="absolute",w.style.width=`${y.current.clientWidth}px`,document.body.appendChild(w);const N=w.scrollHeight,k=y.current.cloneNode(!0);k.style.webkitLineClamp=p.toString(),k.style.display="-webkit-box",k.style.webkitBoxOrient="vertical",k.style.visibility="hidden",k.style.position="absolute",k.style.width=`${y.current.clientWidth}px`,document.body.appendChild(k);const $=k.clientHeight;document.body.removeChild(w),document.body.removeChild(k),j(N>$)}};return _(),window.addEventListener("resize",_),()=>window.removeEventListener("resize",_)},[n,p]),n?e.jsxs("div",{className:i,children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[r,e.jsx("div",{ref:y,className:Ve("whitespace-pre-line",!b&&"overflow-hidden",o),style:b?{display:"block"}:{display:"-webkit-box",WebkitLineClamp:p,WebkitBoxOrient:"vertical"},children:n})]}),m&&e.jsx("button",{onClick:_=>{_.stopPropagation(),d(!b)},className:"mt-0.5 flex items-center gap-1 text-[10px] font-bold text-slate-400 uppercase hover:text-slate-500",children:b?e.jsxs(e.Fragment,{children:[e.jsx(bt,{size:12}),"Show Less"]}):e.jsxs(e.Fragment,{children:[e.jsx(yt,{size:12}),"Show More"]})})]}):null},Re=12,Ye=[51.477,0],Je=2,W=`${J}/travel/trips`,le=[{id:"hotel",label:"Hotel",icon:Ot},{id:"restaurant",label:"Restaurant",icon:aa},{id:"museum",label:"Museum",icon:Jt},{id:"airport",label:"Airport",icon:Kt},{id:"station",label:"Station",icon:ea},{id:"sightseeing",label:"Sightseeing",icon:Bt},{id:"activity",label:"Activity",icon:zt},{id:"other",label:"Other",icon:Ee}],Xe=(n,i,o)=>{if(!n||!n.includes("booking.com"))return n;try{const p=new URL(n);return p.searchParams.set("group_adults","1"),p.searchParams.set("no_rooms","1"),i&&p.searchParams.set("checkin",i),o&&p.searchParams.set("checkout",o),p.toString()}catch{return n}},ia=n=>{const i=n.filter(d=>!d.parent_id),o=n.reduce((d,m)=>(m.parent_id&&(d[m.parent_id]||(d[m.parent_id]=[]),d[m.parent_id].push(m)),d),{}),p=(d,m)=>d.date!==m.date?d.date?m.date?d.date.localeCompare(m.date):-1:1:d.time!==m.time?d.time?m.time?d.time.localeCompare(m.time):-1:1:0,r=[],b=d=>{[...d].sort(p).forEach(j=>{r.push(j);const y=o[j.id]||[];y.length>0&&b(y)})};return b(i),r},da=({polylinePoints:n,spokeLines:i})=>e.jsxs(Y,{position:"topright",children:[e.jsx(Y.BaseLayer,{checked:!0,name:"Map",children:e.jsx(ue,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:19})}),e.jsx(Y.BaseLayer,{name:"3D Terrain",children:e.jsx(ue,{attribution:'<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",maxZoom:20})}),e.jsx(Y.BaseLayer,{name:"3D topography",children:e.jsx(ue,{attribution:'Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",maxZoom:17})}),e.jsx(Y.BaseLayer,{name:"Satellite",children:e.jsx(ue,{attribution:"Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, GIS",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})}),n.length>1&&e.jsx(Y.Overlay,{checked:!0,name:"Show Route",children:e.jsx(Be,{positions:n,color:"var(--color-red-600)",weight:5,opacity:.8,dashArray:"10, 10"})}),i.length>0&&e.jsx(Y.Overlay,{checked:!0,name:"Show Activities",children:e.jsx(Be,{positions:i,color:"var(--color-green-600)",weight:3,opacity:.8,dashArray:"5, 5"})})]}),Ne=le.reduce((n,i)=>({...n,[i.id]:i.icon}),{}),ca=le.reduce((n,i)=>({...n,[i.id]:i.label}),{}),he={hotel:'<path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/>',restaurant:'<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/>',museum:'<line x1="3" y1="22" x2="21" y2="22"/><line x1="6" y1="18" x2="6" y2="11"/><line x1="10" y1="18" x2="10" y2="11"/><line x1="14" y1="18" x2="14" y2="11"/><line x1="18" y1="18" x2="18" y2="11"/><polyline points="12 2 20 7 4 7 12 2"/>',airport:'<path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/>',station:'<path d="M4 3h16a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/><path d="M6 8h12"/><path d="m16.8 22-1.5-3"/><path d="m7.2 22 1.5-3"/><path d="M2 13h20"/><circle cx="12" cy="16" r="2"/>',sightseeing:'<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>',activity:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',other:'<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>'},fe={duration:0},Ie=(n,i,o,p)=>{const r=o&&he[o]?he[o]:he.other,b=o&&he[o]?o:"map-pin",d=String(n),m=p?1.2:1,j=(d.length>2?50:42)*m,y=32*m,_=j,w=y,N=14*m,k=(d.length>3?10:12)*m,$=`<svg width="${N}" height="${N}" viewBox="0 0 24 24" fill="none" stroke="${i}" stroke-width="${p?3:2.5}" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-${b}">${r}</svg>`,z=`
    <div style="position: relative; width: ${_}px; height: ${w}px;">
      <svg width="${_}" height="${w}" viewBox="0 0 ${j} ${y}" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
        <!-- Horizontal Oval/Pill shape with a bottom point -->
        <path d="M ${j/2} ${y} L ${j/2-6} ${y-6} H 12 A 12 12 0 0 1 12 2 H ${j-12} A 12 12 0 0 1 ${j-12} 26 H ${j/2+6} Z" fill="${i}"/>
        <!-- Inner white pill -->
        <rect x="3" y="3" width="${j-6}" height="${y-12}" rx="9" fill="white"/>
      </svg>
      <div style="position: absolute; top: ${w/2-3}px; left: ${_/2}px; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; gap: 4px; width: ${_-10}px;">
        <div style="display: flex; align-items: center; justify-content: center; height: ${N}px;">${$}</div>
        <div style="font-size: ${k}px; font-weight: 900; color: ${i}; line-height: 1;">
          ${n}
        </div>
      </div>
    </div>
  `;return L.divIcon({html:z,className:"custom-div-icon",iconSize:[_,w],iconAnchor:[_/2,w],popupAnchor:[0,-w]})},K=n=>typeof n.lat=="number"&&Number.isFinite(n.lat)&&typeof n.lng=="number"&&Number.isFinite(n.lng),pa=({items:n,onClearSelection:i})=>{const o=ge();return React.useEffect(()=>{const p=new L.Control({position:"topleft"});return p.onAdd=()=>{const r=L.DomUtil.create("div","leaflet-bar leaflet-control"),b=L.DomUtil.create("a","leaflet-control-reset",r);return b.innerHTML='<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: block; margin: 0 auto;"><path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8M3 16.2V21m0 0h4.8M3 21l6-6M21 7.8V3m0 0h-4.8M21 3l-6 6M3 7.8V3m0 0h4.8M3 3l6 6"/></svg>',b.href="#",b.title="Reset View",b.style.backgroundColor="white",b.style.cursor="pointer",L.DomEvent.on(b,"click",d=>{L.DomEvent.stop(d),i();const m=n.filter(j=>K(j)&&!j.hide_from_map);if(m.length>0){const j=L.latLngBounds(m.map(y=>[y.lat,y.lng]));o.flyToBounds(j,{...fe,padding:[50,50],maxZoom:Re})}else o.flyTo(Ye,Je,fe)}),r},o.addControl(p),()=>{o.removeControl(p)}},[o,n,i]),null},ua=({isCollapsed:n})=>{const i=ge();return React.useEffect(()=>{if(!n){const o=setTimeout(()=>{i.invalidateSize()},100);return()=>clearTimeout(o)}},[n,i]),null},ha=({tripId:n,items:i,selectedItem:o,isCollapsed:p})=>{const r=ge(),b=React.useRef(void 0),d=React.useRef(void 0),m=React.useRef(p),j=React.useRef(void 0);return React.useEffect(()=>{if(p){m.current=p;return}const y=r.getContainer();if(y.clientWidth===0||y.clientHeight===0)return;const _=o?.id??null,w=d.current!==n,N=b.current!==_,k=m.current===!0&&p===!1,$=i.length>0&&j.current!==n;if(w||N||k||$){const B=setTimeout(()=>{if(o&&i.some(F=>F.id===o.id)&&o&&K(o))try{const F=r.getZoom(),D=Math.max(F,Re);r.flyTo([o.lat,o.lng],D,fe),($||k)&&(j.current=n)}catch(F){console.error("Failed to fly to selected item",F)}else if(w||k||$||N&&!o){const F=i.filter(D=>K(D)&&!D.hide_from_map);if(F.length>0)try{const D=L.latLngBounds(F.map(c=>[c.lat,c.lng]));r.flyToBounds(D,{...fe,padding:[50,50],maxZoom:Re}),j.current=n}catch(D){console.error("Failed to fly to bounds",D)}}b.current=_,d.current=n,m.current=p},k?150:0);return()=>clearTimeout(B)}},[i,o,n,r,p]),null},xa=({isSelecting:n})=>{const i=ge();return React.useEffect(()=>{n?i.getContainer().style.cursor="crosshair":i.getContainer().style.cursor=""},[n,i]),null},ma=({onLocationSelect:n,onMapClick:i,isSelectingLocation:o})=>(kt({click(p){o&&n?n(p.latlng.lat,p.latlng.lng):i&&i(p.latlng.lat,p.latlng.lng)}}),null);function fa({tripId:n,items:i,selectedItem:o,editingItemId:p,editingItemLocation:r,onSelectItem:b,onEdit:d,onLocationSelect:m,onAddAtLocation:j,onCancelLocationSelect:y,isSelectingLocation:_,isCollapsed:w,isReadOnly:N}){const[k,$]=React.useState(null),z=React.useMemo(()=>i.filter(c=>!c.parent_id),[i]),B=React.useMemo(()=>z.filter(c=>c.is_connected),[z]),I=B.length,F=React.useMemo(()=>B.filter(c=>K(c)&&!c.hide_from_map).map(c=>[c.lat,c.lng]),[B]),D=React.useMemo(()=>{const c=[];return i.forEach(g=>{if(g.parent_id&&K(g)&&!g.hide_from_map){const C=i.find(M=>M.id===g.parent_id);C&&K(C)&&!C.hide_from_map&&c.push([[C.lat,C.lng],[g.lat,g.lng]])}}),c},[i]);return e.jsxs("div",{className:"relative z-0 h-full w-full overflow-hidden rounded-lg border border-slate-200",children:[e.jsxs(Nt,{center:Ye,zoom:Je,zoomSnap:0,zoomDelta:.1,wheelPxPerZoomLevel:120,scrollWheelZoom:!0,className:"h-full w-full",attributionControl:!1,children:[e.jsx(ua,{isCollapsed:w}),e.jsx(da,{polylinePoints:F,spokeLines:D}),e.jsx(ha,{tripId:n,items:i,selectedItem:o,isCollapsed:w}),e.jsx(xa,{isSelecting:!!_}),e.jsx(pa,{items:i,onClearSelection:()=>b(null)}),e.jsx(ma,{onLocationSelect:m,onMapClick:(c,g)=>$([c,g]),isSelectingLocation:_}),k&&e.jsx(Oe,{position:k,eventHandlers:{remove:()=>$(null)},minWidth:0,className:"map-click-popup",children:e.jsxs("div",{className:"flex w-max flex-col gap-1 p-0.5",children:[!N&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{j?.(k[0],k[1],"next"),$(null)},className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-xs font-bold whitespace-nowrap text-slate-700 transition-colors hover:bg-slate-100",children:[e.jsx(Se,{size:14,className:"text-indigo-600"}),"Add as next item"]}),e.jsxs("button",{onClick:()=>{j?.(k[0],k[1],"child"),$(null)},className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-xs font-bold whitespace-nowrap text-slate-700 transition-colors hover:bg-slate-100 disabled:opacity-50 disabled:hover:bg-transparent",disabled:!o,title:o?"":"Select an item first to add a child",children:[e.jsx(Se,{size:14,className:"text-green-600"}),"Add as child"]})]}),e.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${k[0]},${k[1]}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-xs font-bold whitespace-nowrap text-slate-700 transition-colors hover:bg-slate-100",children:[e.jsx(me,{size:14,className:"text-amber-500"}),"Google Maps"]})]})}),i.map(c=>{let g=c.lat,C=c.lng,M=c.category;const ae=c.id===p;if(ae&&r){if(r.hide_from_map)return null;g=r.lat,C=r.lng,M=r.category||c.category}else if(c.hide_from_map)return null;if(!K({lat:g,lng:C}))return null;const T=c.id===o?.id||ae,q=!!c.parent_id,pe=T?"var(--color-red-600)":q?"var(--color-green-600)":c.is_connected?"var(--color-indigo-500)":"var(--color-amber-500)";let ie="•";if(q){const O=i.find(G=>G.id===c.parent_id);if(O){const G=z.findIndex(Q=>Q.id===O.id);if(G!==-1){const Q=O.is_connected?G+1:String.fromCharCode(65+(G-I)),de=i.filter(se=>se.parent_id===c.parent_id).findIndex(se=>se.id===c.id);de!==-1&&(ie=`${Q}.${de+1}`)}}}else{const O=z.findIndex(G=>G.id===c.id);O!==-1&&(ie=c.is_connected?O+1:String.fromCharCode(65+(O-I)))}return e.jsx(Ue,{position:[g,C],icon:Ie(ie,pe,M,T),eventHandlers:{click:()=>b(c)},children:e.jsx(Oe,{maxWidth:2e3,children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"mb-1 flex items-center gap-2",children:[M&&Ne[M]&&e.jsx("div",{className:q?"text-green-600":c.is_connected?"text-indigo-500":"text-amber-500",children:(()=>{const O=Ne[M];return e.jsx(O,{size:14})})()}),e.jsx("h3",{className:"font-bold",children:c.location}),e.jsx("div",{className:"ml-auto flex items-center gap-1.5",children:c.is_tba&&e.jsx("span",{className:"shrink-0 rounded border border-green-200 bg-green-100 px-1 py-0.5 text-[10px] font-bold tracking-wider text-green-700 uppercase",children:"TBA"})})]}),(c.date||c.time||c.date_departure||c.time_departure)&&e.jsxs("div",{className:"text-[11px] font-bold tracking-wider text-slate-500 uppercase",children:[[c.date?xe(c.date,!0):null,c.time?c.time.substring(0,5):null].filter(Boolean).join(" @ "),(c.date_departure||c.time_departure)&&e.jsxs(e.Fragment,{children:[" → ",[c.date_departure?xe(c.date_departure):null,c.time_departure?c.time_departure.substring(0,5):null].filter(Boolean).join(" @ ")]})]}),c.description&&e.jsx($e,{text:c.description,className:"mt-1",textClassName:"text-sm text-slate-600"}),(c.url_booking||c.url_map||d)&&e.jsxs("div",{className:"mt-2 flex gap-2",children:[d&&e.jsx("button",{onClick:O=>{O.stopPropagation(),d(c)},className:"rounded-md bg-indigo-100 p-1 text-indigo-400 text-slate-400 transition-colors hover:text-indigo-600",title:"Edit",children:e.jsx(qe,{size:14})}),c.url_booking&&e.jsx("a",{href:Xe(c.url_booking,c.date,c.date_departure),target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 rounded border border-blue-500 bg-blue-50 px-2 py-0.5 text-[10px] font-bold !text-blue-800 uppercase transition-colors hover:!text-blue-900",children:(()=>{const O=c.category&&Ne[c.category]||Ee,G=c.category&&ca[c.category]||"Other";return e.jsxs(e.Fragment,{children:[e.jsx(O,{size:10}),G]})})()}),c.url_map&&e.jsxs("a",{href:c.url_map,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 rounded border border-amber-500 bg-amber-50 px-2 py-0.5 text-[10px] font-bold !text-amber-600 uppercase transition-colors hover:!text-amber-800",children:[e.jsx(me,{size:10}),"Google Map"]})]})]})})},c.id)}),!p&&r&&!r.hide_from_map&&K(r)&&e.jsx(Ue,{position:[r.lat,r.lng],icon:Ie(String.fromCharCode(65+(z.length-I)),"var(--color-amber-500)",r.category,!0)})]}),_&&e.jsxs("div",{className:"absolute top-4 left-1/2 z-[1000] flex -translate-x-1/2 flex-col items-center gap-2",children:[e.jsx("div",{className:"rounded-full border border-indigo-200 bg-white px-4 py-2 text-sm font-bold text-indigo-600 shadow-lg",children:"Select new location on map"}),y&&e.jsx("button",{onClick:c=>{c.stopPropagation(),y()},className:"rounded-full border border-slate-200 bg-white px-4 py-1.5 text-xs font-bold text-slate-500 shadow-md transition-all hover:bg-slate-50",children:"Cancel"})]})]})}const ga=({auth:n,trip:i,onUpdate:o,onDelete:p,onExport:r,onImport:b,onClose:d})=>{const[m,j]=React.useState(""),[y,_]=React.useState(i.collaborator_emails||[]),[w,N]=React.useState(!1),[k,$]=React.useState(null),[z,B]=React.useState(!1),[I,F]=React.useState(!1),D=n.user.id===i.user_id,c=T=>{if(T.preventDefault(),!!m.trim()){if(y.includes(m.trim())){$("User already added");return}_([...y,m.trim()]),j(""),$(null)}},g=T=>{_(y.filter(q=>q!==T))},C=async()=>{N(!0),$(null);try{const T=await fetch(`${J}/travel/trips/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.access_token}`},body:JSON.stringify({collaborator_emails:y})}),q=await T.json();if(!T.ok)throw new Error(q.detail||"Failed to update collaborators");o(q),d()}catch(T){$(T.message)}finally{N(!1)}},M=`${window.location.origin}${window.location.pathname}?share_token=${i.share_token}`,ae=()=>{navigator.clipboard.writeText(M),B(!0),F(!1),setTimeout(()=>{F(!0),setTimeout(()=>{B(!1),F(!1)},1e3)},2e3)};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 p-4 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex w-full max-w-md flex-col overflow-hidden rounded-2xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-slate-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900","data-testid":"share-trip-modal-heading",children:"Trip Settings"}),e.jsx("button",{onClick:d,className:"text-slate-400 hover:text-slate-600",children:e.jsx(Ce,{size:24})})]}),e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("section",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Public Share Link"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{readOnly:!0,"data-testid":"share-link-input",className:"flex-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-500 outline-none",value:M}),e.jsx("button",{onClick:ae,className:"rounded-lg bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600 hover:bg-slate-200",children:"Copy"})]}),e.jsx("p",{className:"mt-1 text-[10px] text-slate-400",children:"Anyone with this link can view the trip (read-only)."})]}),e.jsxs("section",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Collaborators"}),e.jsx("p",{className:"mb-3 text-xs text-slate-500",children:"Add other users to give them editing rights."}),e.jsxs("form",{onSubmit:c,className:"mb-4 flex gap-2",children:[e.jsx("input",{type:"email",autoComplete:"email",placeholder:"user@example.com",className:"flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500",value:m,onChange:T=>j(T.target.value)}),e.jsx("button",{type:"submit",className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-bold text-white hover:bg-indigo-700",children:"Add"})]}),e.jsxs("div",{className:"max-h-40 space-y-2 overflow-y-auto pr-2",children:[y.length===0&&e.jsx("p",{className:"text-sm text-slate-400 italic",children:"No collaborators yet."}),y.map(T=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg bg-slate-50 px-3 py-2",children:[e.jsx("span",{className:"truncate text-sm text-slate-700",children:T}),e.jsx("button",{onClick:()=>g(T),className:"text-slate-400 hover:text-red-500",children:e.jsx(Ce,{size:16})})]},T))]})]}),e.jsxs("section",{children:[e.jsx("label",{className:"mb-2 block text-sm font-semibold text-slate-700",children:"Data Management"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:r,className:"flex flex-1 items-center justify-center gap-2 rounded-lg bg-slate-100 py-2.5 text-sm font-bold text-slate-600 transition-all hover:bg-slate-200","data-testid":"export-trip-button-modal",children:[e.jsx(St,{size:18}),"Export YAML"]}),e.jsxs("button",{onClick:b,className:"flex flex-1 items-center justify-center gap-2 rounded-lg bg-slate-100 py-2.5 text-sm font-bold text-slate-600 transition-all hover:bg-slate-200","data-testid":"import-trip-button-modal",children:[e.jsx($t,{size:18}),"Import YAML"]})]}),e.jsx("p",{className:"mt-1 text-[10px] text-slate-400",children:"Backup your trip or restore it from a YAML file."})]}),k&&e.jsx("p",{className:"text-sm text-red-500",children:k})]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 border-t border-slate-100 bg-slate-50 p-6",children:[e.jsx("div",{children:D&&e.jsxs("button",{onClick:()=>{p(i.id),d()},className:"flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-bold text-red-500 transition-colors hover:bg-red-50","data-testid":"delete-trip-button-modal",children:[e.jsx(Me,{size:18}),"Delete Trip"]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:d,className:"px-4 py-2 text-sm font-bold text-slate-600 hover:text-slate-800",children:"Cancel"}),e.jsx("button",{onClick:C,disabled:w,className:"rounded-lg bg-indigo-600 px-6 py-2 text-sm font-bold text-white hover:bg-indigo-700 disabled:opacity-50",children:w?"Saving...":"Save Changes"})]})]})]}),z&&e.jsx("div",{className:`fixed top-8 left-1/2 z-50 -translate-x-1/2 rounded-full bg-slate-800 px-4 py-2 text-sm font-bold text-white shadow-lg transition-opacity duration-1000 ${I?"opacity-0":"opacity-100"}`,children:"Copied to clipboard!"})]})},ke=({className:n,variant:i="slate",children:o,...p})=>{const r={slate:"bg-slate-100 text-slate-600 hover:bg-slate-200",indigo:"bg-indigo-600 text-white hover:bg-indigo-700","indigo-light":"bg-indigo-50 text-indigo-700 hover:bg-indigo-100"};return e.jsx("button",{className:Ve("flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold transition-all",r[i],n),...p,children:o})},ba=()=>{const[n,i]=React.useState(null),[o,p]=React.useState([]),[r,b]=React.useState(()=>{const t=localStorage.getItem("travel_selected_trip_id");return t?Number(t):null});React.useEffect(()=>{r!==null?localStorage.setItem("travel_selected_trip_id",String(r)):localStorage.removeItem("travel_selected_trip_id")},[r]);const[d,m]=React.useState([]),[j,y]=React.useState(!0),[_,w]=React.useState(null),[N,k]=React.useState(null),[$,z]=React.useState(!1),[B,I]=React.useState(!1),[F,D]=React.useState(!1),[c,g]=React.useState(""),[C,M]=React.useState(null),[ae,T]=React.useState(!1),[q,pe]=React.useState(!1),[ie,O]=React.useState(!1),[G,Q]=React.useState(!1),[Z,de]=React.useState(null),[se,ne]=React.useState(null),[P,Le]=React.useState(!1),[Ke,X]=React.useState(""),oe=React.useRef(null),ce=React.useRef(null),ee=React.useRef(null);React.useEffect(()=>{let t;if(Z!==null){const s=l=>{ee.current={y:l.clientY}};return window.addEventListener("dragover",s,!0),window.addEventListener("mousemove",s,!0),window.addEventListener("pointermove",s,!0),t=window.setInterval(()=>{if(!ce.current||!ee.current)return;const l=ce.current.getBoundingClientRect(),u=ee.current.y-l.top,h=l.height*.2;if(u<h&&u>=-50){const x=Math.max(2,(1-u/h)*12);ce.current.scrollTop-=x}else if(u>l.height-h&&u<=l.height+50){const x=u-(l.height-h),a=Math.max(2,x/h*12);ce.current.scrollTop+=a}},16),()=>{t&&clearInterval(t),window.removeEventListener("dragover",s,!0),window.removeEventListener("mousemove",s,!0),window.removeEventListener("pointermove",s,!0)}}},[Z]),React.useEffect(()=>{if(N){const t=document.getElementById(`travel-item-${N.id}`);t&&t.scrollIntoView({block:"nearest"})}},[N]);const[f,R]=React.useState({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!1,parent_id:null}),be=new URLSearchParams(window.location.search).get("share_token"),A=!!be;React.useEffect(()=>{const t=localStorage.getItem("travel_auth");if(t)try{i(JSON.parse(t))}catch{localStorage.removeItem("travel_auth")}},[]);const Qe=t=>{i(t),localStorage.setItem("travel_auth",JSON.stringify(t))},ye=()=>{i(null),localStorage.removeItem("travel_auth"),p([]),m([])},H=React.useCallback(async(t,s={})=>{const l={...s.headers||{},...n?{Authorization:`Bearer ${n.access_token}`}:{}};return fetch(t,{...s,headers:l})},[n]),Pe=React.useCallback(async()=>{if(!(A||!n))try{const t=await H(W);if(t.status===401){ye();return}if(!t.ok)throw new Error("Failed to fetch trips");const s=await t.json();p(s),s.length>0?(r===null||!s.some(l=>l.id===r))&&b(s[0].id):b(null)}catch(t){console.error(t)}},[r,A,n,H]),ze=React.useCallback(async()=>{if(A){y(!0);try{const t=await fetch(`${J}/travel/shared/${be}`);if(!t.ok)throw new Error("Failed to fetch shared trip");const s=await t.json();p([s.trip]),b(s.trip.id);const l=s.items.map((u,h)=>({...u,is_connected:h<s.trip.active_count}));m(l),w(null)}catch(t){w("Failed to load shared itinerary. It may have been deleted or the link is invalid."),console.error(t)}finally{y(!1)}return}if(!n||r===null){m([]),y(!1);return}y(!0);try{const t=await H(`${W}/${r}/items`);if(t.status===401){ye();return}if(!t.ok)throw new Error("Failed to fetch itinerary items");const s=await t.json(),l=s.items.map((u,h)=>({...u,is_connected:h<s.active_count}));m(l),w(null)}catch(t){w("Failed to load itinerary. Please try again."),console.error(t)}finally{y(!1)}},[r,A,be,n,H]);React.useEffect(()=>{Pe()},[Pe]),React.useEffect(()=>{ze(),A||(k(null),M(null),z(!1),R({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!1,parent_id:null}))},[ze,A]);const te=React.useMemo(()=>o.find(t=>t.id===r),[o,r]),et=React.useMemo(()=>n&&te&&n.user.id===te.user_id,[n,te]),tt=()=>{if(et)pe(!0);else if(te){const t=`${window.location.origin}${window.location.pathname}?share_token=${te.share_token}`;navigator.clipboard.writeText(t),O(!0),Q(!1),setTimeout(()=>{Q(!0),setTimeout(()=>{O(!1),Q(!1)},1e3)},2e3)}},at=async()=>{if(r!==null)try{const t=await H(`${W}/${r}/export`);if(!t.ok)throw new Error("Failed to export trip");const s=await t.blob(),l=t.headers.get("Content-Disposition");let u="trip_backup.yml";if(l){const a=l.match(/filename="?([^"]+)"?/);a&&(u=a[1])}const h=URL.createObjectURL(s),x=document.createElement("a");x.href=h,x.download=u,document.body.appendChild(x),x.click(),document.body.removeChild(x),URL.revokeObjectURL(h)}catch(t){alert("Failed to export trip"),console.error(t)}},st=async t=>{const s=t.target.files?.[0];if(s){if(!confirm("This will import the trip as a new trip. Continue?")){oe.current&&(oe.current.value="");return}try{const l=await s.text(),u=await H(`${W}/import`,{method:"POST",headers:{"Content-Type":"text/yaml"},body:l});if(!u.ok){const x=await u.json();throw new Error(x.detail||"Failed to import trip")}const h=await u.json();p(x=>[...x,h]),b(h.id),alert("Successfully imported trip!")}catch(l){alert(`Failed to import: ${l instanceof Error?l.message:String(l)}`),console.error(l)}finally{oe.current&&(oe.current.value="")}}},nt=async t=>{if(t.preventDefault(),!!c.trim())try{const s=await H(W,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:c})});if(!s.ok)throw new Error("Failed to create trip");const l=await s.json();p(u=>[...u,l]),b(l.id),g(""),D(!1)}catch(s){alert("Failed to create trip"),console.error(s)}},ot=async t=>{if(confirm("Are you sure you want to delete this trip and all its items?"))try{if(!(await H(`${W}/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete trip");p(l=>l.filter(u=>u.id!==t)),r===t&&b(o.find(l=>l.id!==t)?.id||null)}catch(s){alert("Failed to delete trip"),console.error(s)}},ve=(t=null)=>{M(null),R({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!0,parent_id:t}),X(""),z(!0)},rt=(t,s,l)=>{const u=l==="child"&&N?.id||null,h=N?.date||null;M(null),R({...f,location:"",description:"",description_private:"",date:h,time:null,lat:t,lng:s,category:"other",is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!0,parent_id:u,date_departure:null,time_departure:null}),X(`${t.toFixed(6)}, ${s.toFixed(6)}`),z(!0)},re=async t=>{if(r===null)return;const s=[...t].sort((u,h)=>u.is_connected!==h.is_connected?u.is_connected?-1:1:0),l=s.filter(u=>u.is_connected).length;try{const u=await H(`${W}/${r}/items`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s,connections:[],active_count:l})});if(!u.ok)throw new Error("Failed to sync trip items");const h=await u.json(),x=h.items.map((a,v)=>({...a,is_connected:v<h.active_count}));m(x)}catch(u){throw console.error("Sync error:",u),u}},lt=async()=>{if(!confirm("Are you sure you want to sort all items by date?"))return;const t=ia(d);try{await re(t)}catch(s){alert("Failed to reorder items"),console.error(s)}},it=async(t,s)=>{try{const l=d.filter(E=>E.parent_id===s.id),u=l.length>0?l[l.length-1]:null,h=d.filter(E=>E.id!==t.id),x=h.findIndex(E=>E.id===s.id),a=u?h.findIndex(E=>E.id===u.id)+1:x+1,v=[...h];v.splice(a,0,{...t,parent_id:s.id}),await re(v)}catch(l){alert("Failed to indent item"),console.error(l)}},dt=async t=>{try{const s=d.findIndex(x=>x.id===t.parent_id),u=[...d.filter(x=>x.id!==t.id)],h={...t,parent_id:null,is_connected:!0};if(s!==-1){const x=u.findIndex(a=>a.id===t.parent_id);u.splice(x+1,0,h)}else u.push(h);await re(u)}catch(s){alert("Failed to outdent item"),console.error(s)}},Fe=t=>{M(t.id),R({date:t.date,time:t.time,location:t.location,description:t.description,description_private:t.description_private,category:t.category||"other",lat:t.lat,lng:t.lng,date_departure:t.date_departure,time_departure:t.time_departure,is_tba:t.is_tba,url_booking:t.url_booking||"",url_map:t.url_map||"",hide_from_map:t.hide_from_map,is_connected:t.is_connected,parent_id:t.parent_id}),X(t.lat&&t.lng?`${t.lat}, ${t.lng}`:""),z(!0)},ct=async t=>{if(t.preventDefault(),r!==null)try{const s=C?`${J}/travel/items/${C}`:`${W}/${r}/items`,u=await H(s,{method:C?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:f.date,time:f.time,location:f.location,description:f.description,description_private:f.description_private,category:f.category,lat:f.lat,lng:f.lng,date_departure:f.date_departure,time_departure:f.time_departure,is_tba:f.is_tba,url_booking:f.url_booking,url_map:f.url_map,hide_from_map:f.hide_from_map,parent_id:f.parent_id})});if(!u.ok)throw new Error("Failed to save item");const h=await u.json();let x;C?x=d.map(a=>a.id===C?{...a,...h,is_connected:f.is_connected}:a):x=[...d,{...h,is_connected:f.is_connected}],await re(x),z(!1),M(null),R({date:new Date().toISOString().split("T")[0],time:null,location:"",description:"",description_private:"",category:"other",lat:null,lng:null,date_departure:null,time_departure:null,is_tba:!1,url_booking:"",url_map:"",hide_from_map:!1,is_connected:!1,parent_id:null})}catch(s){alert("Failed to save item"),console.error(s)}},pt=async t=>{if(confirm("Are you sure you want to delete this item?"))try{if(!(await H(`${J}/travel/items/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete item");const l=d.filter(x=>x.parent_id===t),h=[...d.filter(x=>x.id!==t&&x.parent_id!==t),...l.map(x=>({...x,parent_id:null,is_connected:!1}))];await re(h),N?.id===t&&k(null)}catch(s){alert("Failed to delete item"),console.error(s)}},ut=async t=>{if(confirm("Are you sure you want to duplicate this item?"))try{const s=await H(`${W}/${r}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:t.date,time:t.time,location:t.location,description:`**DUPLICATED**
${t.description}`,description_private:t.description_private,category:t.category,lat:t.lat,lng:t.lng,date_departure:t.date_departure,time_departure:t.time_departure,is_tba:!0,url_booking:t.url_booking,url_map:t.url_map,parent_id:t.parent_id})});if(!s.ok)throw new Error("Failed to duplicate item");const l=await s.json();m(u=>[...u,{...l,is_connected:!1}])}catch(s){alert("Failed to duplicate item"),console.error(s)}},ht=t=>{de(t)},xt=(t,s)=>{if(t.preventDefault(),ee.current={y:t.clientY},Z===null||Z===s)return;const l=d.findIndex(U=>U.id===Z),u=d.findIndex(U=>U.id===s);if(l===-1||u===-1)return;const h=[...d],[x]=h.splice(l,1),a=d.filter(U=>U.is_connected).length;x.is_connected=u<a,h.splice(u,0,x);const v=d.map(U=>`${U.id}-${U.is_connected}`).join(","),E=h.map(U=>`${U.id}-${U.is_connected}`).join(",");v!==E&&m(h)},mt=async()=>{if(!(Z===null||r===null)){de(null),ne(null),ee.current=null;try{await re(d)}catch(t){alert("Failed to save reordered items"),console.error(t)}}},ft=t=>{if(t.preventDefault(),Z===null)return;const s=d.findIndex(v=>v.id===Z);if(s===-1)return;const l=[...d],[u]=l.splice(s,1),h=d.filter(v=>v.id!==Z&&v.is_connected).length;u.is_connected=!1,l.splice(h,0,u);const x=d.map(v=>`${v.id}-${v.is_connected}`).join(","),a=l.map(v=>`${v.id}-${v.is_connected}`).join(",");x!==a&&m(l)};React.useMemo(()=>d.filter(t=>!t.hide_from_map),[d]);const De=React.useMemo(()=>d.filter(t=>t.is_connected).length,[d]);return!n&&!A?e.jsx(la,{onLogin:Qe}):e.jsxs("div",{className:"flex h-full flex-col overflow-hidden border bg-slate-50 font-sans text-slate-900 md:rounded-2xl md:border-slate-200/50 md:shadow-2xl",children:[e.jsxs("header",{className:"z-10 flex flex-wrap items-center justify-between gap-4 border-b border-slate-200 bg-white px-6 py-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:"/favicon_travel.png",alt:"Travel Planner",className:"h-10 w-10 shrink-0 rounded-xl shadow-lg shadow-indigo-200"}),e.jsx("h1",{className:"hidden text-2xl font-bold tracking-tight text-slate-900 md:block","data-testid":"travel-planner-heading",children:"Travel Planner"})]}),e.jsx("div",{className:"flex max-w-md flex-1 items-center gap-3",children:F?e.jsxs("form",{onSubmit:nt,className:"flex w-full gap-2",children:[e.jsx("input",{autoFocus:!0,type:"text","data-testid":"trip-name-input",placeholder:"Trip name...",className:"flex-1 rounded-lg border border-slate-200 px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500",value:c,onChange:t=>g(t.target.value)}),e.jsx("button",{type:"submit",className:"rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-bold text-white hover:bg-indigo-700","data-testid":"save-trip-name-button",children:"Save"}),e.jsx("button",{type:"button",onClick:()=>D(!1),className:"rounded-lg bg-slate-100 px-3 py-1.5 text-xs font-bold text-slate-600 hover:bg-slate-200","data-testid":"cancel-trip-name-button",children:"Cancel"})]}):e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsxs("select",{className:"flex-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-default disabled:opacity-70",value:r||"",onChange:t=>b(Number(t.target.value)),disabled:A,children:[o.length===0&&e.jsx("option",{value:"",children:"No trips created"}),o.map(t=>e.jsxs("option",{value:t.id,children:[t.name,n&&t.user_id!==n.user.id?" (Shared)":""]},t.id))]}),!A&&e.jsx(e.Fragment,{children:e.jsx("button",{onClick:()=>D(!0),className:"shrink-0 rounded-lg bg-slate-100 p-2 text-slate-600 transition-colors hover:bg-slate-200",title:"Create New Trip","data-testid":"create-trip-button",children:e.jsx(_e,{size:20})})})]})}),e.jsxs("div",{className:"flex items-center gap-4",children:[r&&e.jsx("div",{className:"flex items-center gap-2",children:!A&&e.jsxs(ke,{onClick:tt,title:"Trip Settings","data-testid":"share-trip-button",children:[e.jsx(Mt,{size:18}),e.jsx("span",{className:"hidden md:inline",children:"Trip settings"})]})}),e.jsx("input",{type:"file",ref:oe,onChange:st,accept:".yaml,.yml",className:"hidden"}),e.jsxs(ke,{variant:"indigo",onClick:()=>Le(!P),title:P?"Show Map":"List View","data-testid":"map-list-toggle-button",children:[P?e.jsx(me,{size:18}):e.jsx(Ct,{size:18}),e.jsx("span",{className:"hidden md:inline",children:P?"Show Map":"List View"})]}),!A&&e.jsxs(e.Fragment,{children:[n?.user.role==="admin"&&e.jsxs(ke,{variant:"indigo-light",onClick:()=>T(!0),title:"Manage Users",children:[e.jsx(Et,{size:18}),e.jsx("span",{className:"hidden md:inline",children:"Users"})]}),e.jsx("span",{className:"text-sm font-semibold text-slate-600",children:n?.user.first_name}),e.jsx("button",{onClick:ye,className:"p-2 text-slate-500 transition-colors hover:text-red-500",title:"Logout",children:e.jsx(Tt,{size:20})})]})]})]}),e.jsxs("main",{className:"relative flex flex-1 overflow-hidden",children:[e.jsx("div",{className:`${P||$&&!B?"flex w-full":"hidden md:flex md:w-1/3"} z-20 flex-col overflow-hidden border-r border-slate-200 bg-white shadow-xl`,children:$?e.jsxs("div",{className:"overflow-y-auto p-6",children:[e.jsx("h2",{className:"mb-6 text-xl font-bold text-slate-800",children:C?"Edit Destination":"Add New Destination"}),e.jsxs("form",{onSubmit:ct,className:"space-y-5",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{z(!1),M(null)},className:"flex-1 rounded-lg bg-slate-100 py-3 font-bold text-slate-600 transition-all hover:bg-slate-200","data-testid":"cancel-item-button",children:"Cancel"}),e.jsx("button",{type:"submit",className:"flex-[2] rounded-lg bg-indigo-600 py-3 font-bold text-white shadow-lg shadow-indigo-100 transition-all hover:bg-indigo-700","data-testid":"save-item-button",children:C?"Save Changes":"Save to Itinerary"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[" ",e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-date",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Date"}),e.jsx("input",{id:"travel-date","data-testid":"travel-date",type:"date",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.date||"",onChange:t=>R({...f,date:t.target.value||null})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-time",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Time"}),e.jsx("input",{id:"travel-time","data-testid":"travel-time",type:"time",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.time||"",onChange:t=>R({...f,time:t.target.value||null})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-departure-date",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Departure Date"}),e.jsx("input",{id:"travel-departure-date","data-testid":"travel-departure-date",type:"date",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.date_departure||"",onChange:t=>R({...f,date_departure:t.target.value||null}),onFocus:()=>{!f.date_departure&&f.date&&R({...f,date_departure:f.date})}})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"travel-departure-time",className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Departure Time"}),e.jsx("input",{id:"travel-departure-time","data-testid":"travel-departure-time",type:"time",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.time_departure||"",onChange:t=>R({...f,time_departure:t.target.value||null})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Category"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:le.map(t=>{const s=t.icon,l=f.category===t.id;return e.jsxs("button",{type:"button",onClick:()=>R({...f,category:t.id}),"data-testid":"category-button",className:`flex flex-col items-center gap-1.5 rounded-lg border p-2 transition-all ${l?"border-indigo-200 bg-indigo-50 text-indigo-600 shadow-sm":"border-slate-100 bg-white text-slate-400 hover:border-slate-200 hover:bg-slate-50"}`,children:[e.jsx(s,{size:18}),e.jsx("span",{className:"text-[10px] font-bold tracking-wider uppercase",children:t.label})]},t.id)})})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500",checked:f.is_tba,onChange:t=>R({...f,is_tba:t.target.checked})}),e.jsx("span",{className:"text-sm font-semibold text-slate-700",children:"TBA (To Be Amended)"})]}),e.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500",checked:f.hide_from_map,onChange:t=>R({...f,hide_from_map:t.target.checked})}),e.jsx("span",{className:"text-sm font-semibold text-slate-700",children:"Hide from map"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:["Location Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",required:!0,"data-testid":"location-input",placeholder:"e.g. Paris, France",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.location,onChange:t=>R({...f,location:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Description"}),e.jsx("textarea",{rows:6,"data-testid":"description-input",placeholder:"What are you planning to do there?",className:"w-full resize-y rounded-lg border border-slate-200 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.description,onChange:t=>R({...f,description:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Private Note (hidden on shared links)"}),e.jsx("textarea",{rows:6,placeholder:"Personal notes, booking references, etc.",className:"w-full resize-y rounded-lg border border-slate-200 bg-green-50/30 px-4 py-2.5 transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.description_private,onChange:t=>R({...f,description_private:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Coordinates"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text","data-testid":"gps-input",placeholder:"GPS 'lat, lng' or Google Maps link https://www.google.com/maps/place/...",className:"flex-1 rounded-lg border border-slate-200 px-4 py-2 text-sm transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:Ke,onChange:t=>{const s=t.target.value;if(X(s),s.startsWith("http")){const l=s.match(/!3d(-?\d+(?:\.\d+)?)/),u=s.match(/!4d(-?\d+(?:\.\d+)?)/);if(l&&u){const h=parseFloat(l[1]),x=parseFloat(u[1]);!isNaN(h)&&!isNaN(x)&&(R({...f,lat:h,lng:x}),X(`${h}, ${x}`))}else{const h=s.match(/@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/);if(h){const x=parseFloat(h[1]),a=parseFloat(h[2]);!isNaN(x)&&!isNaN(a)&&(R({...f,lat:x,lng:a}),X(`${x}, ${a}`))}}}else{const l=s.split(/[\s,]+/);if(l.length>=2){const u=parseFloat(l[0]),h=parseFloat(l[1]);!isNaN(u)&&!isNaN(h)&&R({...f,lat:u,lng:h})}}}}),e.jsx("button",{type:"button",onClick:()=>{I(!0),Le(!1)},className:"flex shrink-0 items-center justify-center rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-2 font-bold text-indigo-700 shadow-sm transition-all hover:bg-indigo-100",title:"Pick location on map","data-testid":"select-on-map-button",children:e.jsx(Wt,{size:20})})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:["Google Map URL (or"," ",e.jsx("a",{href:"https://developers.google.com/maps/documentation/javascript/examples/places-placeid-finder",target:"_blank",rel:"noopener noreferrer",className:"font-normal text-indigo-600 hover:underline",onClick:t=>t.stopPropagation(),children:"Google Place ID"}),")"]}),e.jsx("input",{type:"url","data-testid":"map-url-input",placeholder:"e.g. https://google.com/maps/... or ChIJ3S-JXmauEmsRUcIaWtf4MzE",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 text-sm transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.url_map,onChange:t=>{let s=t.target.value;s&&!s.startsWith("http")&&(s=`https://www.google.com/maps/search/?api=1&query_place_id=${s}&query=a`);const l=s.match(/!3d(-?\d+(?:\.\d+)?)/),u=s.match(/!4d(-?\d+(?:\.\d+)?)/);let h=null,x=null;if(l&&u)h=parseFloat(l[1]),x=parseFloat(u[1]);else{const a=s.match(/@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/);a&&(h=parseFloat(a[1]),x=parseFloat(a[2]))}h!==null&&x!==null&&!isNaN(h)&&!isNaN(x)?(R({...f,url_map:s,lat:h,lng:x}),X(`${h}, ${x}`)):R({...f,url_map:s})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-sm font-semibold text-slate-700",children:"Place URL"}),e.jsx("input",{type:"url",placeholder:"e.g. https://booking.com/... or https://www.tripadvisor.co.uk/...",className:"w-full rounded-lg border border-slate-200 px-4 py-2.5 text-sm transition-all outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",value:f.url_booking,onChange:t=>{let s=t.target.value;s.startsWith("https://www.booking.com/")&&(s=s.split("?")[0]),R({...f,url_booking:s})}})]})]})]})]}):e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-slate-100 p-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-baseline items-center gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:"Itinerary"}),(()=>{const t=d.find(a=>a.date);if(!t||!t.date)return null;const s=new Date,h=(new Date(`${t.date}T${t.time||"12:00"}`).getTime()-s.getTime())/(1e3*60*60*24),x=Math.round(h*10)/10;return x>0?e.jsxs("span",{className:"text-md inline-flex items-center rounded-full px-2.5 py-0.5 font-semibold text-red-700",children:["starting in ",x.toFixed(1)," day",x!==1&&"s"]}):null})()]}),e.jsxs("p",{className:"mt-1 text-sm text-slate-500",children:[De," stops and ",d.length-De," unconnected points"]})]}),!A&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{disabled:r===null,onClick:()=>ve(),className:"rounded-lg bg-indigo-600 p-2 text-white shadow-sm transition-all hover:bg-indigo-700 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50",title:"Add Stop","data-testid":"add-stop-button",children:e.jsx(_e,{size:20})}),e.jsx("button",{disabled:r===null,onClick:()=>lt(),className:"rounded-lg bg-indigo-600 p-2 text-white shadow-sm transition-all hover:bg-indigo-700 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50",title:"Sort by Date","data-testid":"sort-by-date-button",children:e.jsx(Dt,{size:20})})]})]}),e.jsx("div",{ref:ce,"data-testid":"timeline-container",className:"scrollbar-thin scrollbar-thumb-slate-200 flex-1 overflow-y-auto p-6",onDragOver:t=>{t.preventDefault(),ee.current={y:t.clientY}},children:j?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-b-2 border-indigo-600"})}):_?e.jsx("div",{className:"px-4 py-12 text-center font-medium text-red-500",children:_}):d.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-slate-50 text-slate-400",children:e.jsx(Se,{size:32})}),e.jsx("p",{className:"font-medium text-slate-500",children:"No stops added yet."}),!A&&e.jsx("button",{disabled:r===null,onClick:()=>ve(),className:"mt-2 text-sm font-bold text-indigo-600 hover:underline disabled:opacity-50","data-testid":"add-stop-empty-state-button",children:r===null?"Create a trip first":"Start planning now"})]}):e.jsx("div",{className:"relative flex flex-col space-y-2",children:(()=>{const t=d.filter(a=>!a.parent_id),s=d.reduce((a,v)=>(v.parent_id&&(a[v.parent_id]||(a[v.parent_id]=[]),a[v.parent_id].push(v)),a),{}),l=t.filter(a=>a.is_connected).length,u=a=>e.jsxs("div",{className:`relative ${P?"py-2":"py-6"}`,onDragOver:ft,children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-dashed border-slate-200"})}),e.jsx("div",{className:"relative flex justify-center",children:e.jsx("span",{className:"bg-white px-4 text-[10px] font-bold tracking-[0.2em] text-slate-400 uppercase",children:"Extra Locations"})})]},a),h=(a,v,E,U)=>{const Ae=t[E].is_connected?E+1:String.fromCharCode(65+(E-l)),gt=v?`${Ae}.${U+1}`:Ae;return e.jsxs("div",{id:`travel-item-${a.id}`,className:`relative ${v?"py-0 pr-0 pl-16":"py-1 pl-10"} ${Z===a.id?"opacity-20":""} ${se===a.id?"select-none":""}`,onClick:()=>k(a),"data-testid":`travel-item-${a.id}`,draggable:!A&&se===a.id&&C!==a.id,onDragStart:()=>ht(a.id),onDrag:S=>{S.clientY!==0&&(ee.current={y:S.clientY})},onDragOver:S=>xt(S,a.id),onDragEnd:mt,children:[E<l&&e.jsxs(e.Fragment,{children:[(E<l-1||E===l-1&&v)&&e.jsx("div",{className:"absolute top-0 bottom-0 left-4 z-0 w-[3px] -translate-x-1/2 bg-indigo-200"}),E===l-1&&!v&&e.jsx("div",{className:"absolute top-0 left-4 z-0 h-4 w-[3px] -translate-x-1/2 bg-indigo-200"}),(E>0||v)&&e.jsx("div",{className:`absolute left-4 ${P?"-top-2 h-2":"-top-4 h-4"} z-0 w-[3px] -translate-x-1/2 bg-indigo-200`})]}),v&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-0 bottom-1/2 left-10 z-0 h-full w-4 w-[2px] -translate-x-1/2 rounded-bl-lg border-b-2 border-l-2 border-slate-200 bg-slate-200"}),U>0&&e.jsx("div",{className:`absolute left-10 ${P?"-top-2 h-2":"-top-4 h-4"} z-0 w-[2px] -translate-x-1/2 bg-slate-200`})]}),e.jsx("div",{"data-testid":`travel-item-dot-${a.id}`,"data-connected":a.is_connected?"true":"false",className:`absolute ${v?"left-6 mt-1.5 h-7 w-7":"top-1.5 left-0 h-8 w-8"} z-20 flex items-center justify-center rounded-full border-[3px] shadow-sm transition-colors ${N?.id===a.id||C===a.id?"border-slate-300 bg-red-400 text-white":v?"border-indigo-200 bg-green-50 text-slate-500":a.is_connected?"border-indigo-200 bg-slate-200 text-slate-500":"border-indigo-200 bg-amber-500 text-white"}`,children:e.jsx("span",{"data-testid":`travel-item-label-${a.id}`,className:"text-[0.8rem] font-bold",children:gt})}),!A&&N?.id===a.id&&e.jsx("button",{onClick:S=>{S.stopPropagation(),ve(v?a.parent_id:a.id)},className:`absolute ${v?"left-[30px] h-5 w-5":"left-1 h-6 w-6"} bottom-1.5 z-20 flex items-center justify-center rounded-full border-2 border-indigo-100 bg-white text-indigo-300 shadow-sm transition-colors hover:border-indigo-200 hover:text-indigo-400`,title:"Add item after this","data-testid":`add-item-after-button-${a.id}`,children:e.jsx(_e,{size:v?10:12})}),e.jsxs("div",{"data-testid":`travel-item-content-${a.id}`,className:`${P?"p-2":"p-4"} group/item relative z-10 flex flex-col rounded-xl border shadow-sm ${a.hide_from_map?"bg-white":v?"bg-green-50":a.is_connected?"bg-indigo-50":"bg-amber-50"} ${N?.id===a.id?"border-indigo-200":v?"border-green-200 hover:border-green-300":a.is_connected?"border-indigo-200 hover:border-indigo-300":"border-amber-200 hover:border-amber-300"}`,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[(a.date||a.time||a.date_departure||a.time_departure)&&e.jsx("div",{className:"mb-1 flex items-start justify-between",children:e.jsxs("span",{className:`text-xs font-bold tracking-wider uppercase ${v?"text-green-600":a.is_connected?"text-indigo-600":"text-amber-600"}`,children:[[a.date?xe(a.date,!0):null,a.time?a.time.substring(0,5):null].filter(Boolean).join(" @ "),(a.date_departure||a.time_departure)&&e.jsxs(e.Fragment,{children:[" → ",[a.date_departure?xe(a.date_departure):null,a.time_departure?a.time_departure.substring(0,5):null].filter(Boolean).join(" @ ")]})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[a.category&&e.jsx("div",{className:`shrink-0 ${v?"text-green-400":a.is_connected?"text-indigo-400":"text-amber-400"}`,children:(()=>{const S=le.find(we=>we.id===a.category),je=S?S.icon:Ee;return e.jsx(je,{size:16})})()}),e.jsx("h3",{className:`${P?"text-sm":"text-base"} truncate font-bold text-slate-900`,children:a.location}),a.is_tba&&e.jsx("span",{"data-testid":"tba-pill",className:"shrink-0 rounded border border-pink-200 bg-pink-100 px-1.5 py-0.5 text-[10px] font-bold tracking-wider text-pink-700 uppercase",children:"TBA"})]}),(a.url_booking||a.url_map)&&e.jsxs("div",{className:"mt-1 flex gap-2",children:[a.url_booking&&e.jsx("a",{href:Xe(a.url_booking,a.date,a.date_departure),target:"_blank",rel:"noopener noreferrer",onClick:S=>S.stopPropagation(),className:"inline-flex items-center gap-1 rounded border border-blue-500 bg-blue-50 px-2 py-0.5 text-[10px] font-bold text-blue-800 uppercase transition-colors hover:text-blue-900",children:(()=>{const S=le.find(we=>we.id===a.category)||le[7],je=S.icon;return e.jsxs(e.Fragment,{children:[e.jsx(je,{size:10}),S.label]})})()}),a.url_map&&e.jsxs("a",{href:a.url_map,target:"_blank",rel:"noopener noreferrer",onClick:S=>S.stopPropagation(),className:"inline-flex items-center gap-1 rounded border border-amber-500 bg-amber-50 px-2 py-0.5 text-[10px] font-bold text-amber-600 uppercase transition-colors hover:text-amber-800",children:[e.jsx(me,{size:10}),"Google Map"]})]}),!P&&e.jsxs(e.Fragment,{children:[a.description&&e.jsx($e,{text:a.description,className:"mt-1",textClassName:"text-sm text-slate-600"}),!A&&a.description_private&&e.jsx($e,{text:a.description_private,className:"mt-1.5 rounded-md border border-slate-100/50 bg-slate-50/50 p-1.5",textClassName:"text-sm text-slate-700/80",badge:e.jsx("span",{className:"mt-0.5 shrink-0 rounded bg-slate-200 px-1 text-[10px] font-bold text-slate-800 uppercase",children:"Private"})})]})]}),!A&&N?.id===a.id&&e.jsxs("div",{className:"ml-auto flex shrink-0 items-center gap-3","data-testid":`list-control-icons-${a.id}`,children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:S=>{S.stopPropagation(),Fe(a)},className:"rounded-md p-1.5 text-indigo-400 transition-all hover:bg-red-50 hover:text-red-600",title:"Edit","data-testid":`edit-item-button-${a.id}`,children:e.jsx(qe,{size:P?14:16})}),e.jsx("button",{onClick:S=>{S.stopPropagation(),ut(a)},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-indigo-50 hover:text-indigo-600",title:"Duplicate","data-testid":`duplicate-item-button-${a.id}`,children:e.jsx(Lt,{size:P?14:16})}),!v&&E>0&&e.jsx("button",{onClick:S=>{S.stopPropagation(),it(a,t[E-1])},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-indigo-50 hover:text-indigo-600",title:"Make Child of Previous Item","data-testid":`indent-item-button-${a.id}`,children:e.jsx(Zt,{size:P?14:16})}),v&&e.jsx("button",{onClick:S=>{S.stopPropagation(),dt(a)},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-indigo-50 hover:text-indigo-600",title:"Make it a Parent Item","data-testid":`outdent-item-button-${a.id}`,children:e.jsx(Vt,{size:P?14:16})}),e.jsx("button",{onClick:S=>{S.stopPropagation(),pt(a.id)},className:"rounded-md p-1.5 text-slate-400 transition-all hover:bg-red-50 hover:text-red-600",title:"Delete","data-testid":`delete-item-button-${a.id}`,children:e.jsx(Me,{size:P?14:16})})]}),e.jsx("div",{"data-testid":`drag-handle-${a.id}`,className:"cursor-grab touch-none p-1 text-slate-400 transition-all hover:text-slate-600 active:cursor-grabbing",onMouseDown:()=>ne(a.id),onMouseUp:()=>ne(null),onTouchStart:()=>ne(a.id),onTouchEnd:()=>ne(null),onTouchCancel:()=>ne(null),children:e.jsx(Rt,{size:P?16:20})})]})]})]},a.id)},x=[];return t.forEach((a,v)=>{v===l&&x.push(u(`marker-${v}`)),x.push(h(a,!1,v,0)),s[a.id]?.forEach((E,U)=>x.push(h(E,!0,v,U)))}),l===t.length&&t.length>0&&x.push(u("marker-end")),x})()})})]})}),e.jsx("div",{className:`${P||$&&!B?"hidden md:block":"block"} ${P?"md:hidden":""} h-full flex-1`,children:e.jsx(fa,{tripId:r,items:d,selectedItem:N,editingItemId:C,editingItemLocation:$?{lat:f.lat,lng:f.lng,category:f.category,is_connected:f.is_connected,hide_from_map:f.hide_from_map}:null,onSelectItem:k,onEdit:Fe,onLocationSelect:(t,s)=>{R({...f,lat:t,lng:s}),X(`${t.toFixed(6)}, ${s.toFixed(6)}`),I(!1)},onAddAtLocation:rt,onCancelLocationSelect:()=>I(!1),isSelectingLocation:B,isCollapsed:P,isReadOnly:A})})]}),ae&&n&&e.jsx(ra,{auth:n,onClose:()=>T(!1)}),q&&n&&te&&e.jsx(ga,{auth:n,trip:te,onClose:()=>pe(!1),onUpdate:t=>{p(s=>s.map(l=>l.id===t.id?t:l))},onDelete:ot,onExport:at,onImport:()=>oe.current?.click()}),ie&&e.jsx("div",{className:`fixed top-8 left-1/2 z-50 -translate-x-1/2 rounded-full bg-slate-800 px-4 py-2 text-sm font-bold text-white shadow-lg transition-opacity duration-1000 ${G?"opacity-0":"opacity-100"}`,children:"Copied to clipboard!"})]})},He=document.getElementById("root");He&&(document.body.classList.add("travel-page"),ReactDOM.createRoot(He).render(e.jsx(React.StrictMode,{children:e.jsx(ba,{})})));
